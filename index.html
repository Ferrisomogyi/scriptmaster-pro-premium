<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptMaster Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a26;
            --bg-elevated: #22222f;
            --text-primary: #eeeef0;
            --text-secondary: #8b8b9e;
            --text-muted: #55556a;
            --accent: #c8a44e;
            --accent-hover: #dbb85e;
            --accent-dim: rgba(200, 164, 78, 0.12);
            --accent-glow: rgba(200, 164, 78, 0.25);
            --success: #4ade80;
            --error: #f87171;
            --warning: #fbbf24;
            --info: #60a5fa;
            --border: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(255, 255, 255, 0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.5);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.6);
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Noise texture overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.015'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 9999;
        }
        
        /* Glass morphism - upgraded */
        .glass {
            background: rgba(18, 18, 26, 0.85);
            backdrop-filter: blur(20px) saturate(1.2);
            border: 1px solid var(--border);
        }
        
        .glass-light {
            background: rgba(26, 26, 38, 0.6);
            backdrop-filter: blur(12px);
        }
        
        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }
        
        /* Header - cinematic top bar */
        .header {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(18,18,26,0.98) 0%, rgba(10,10,15,0.95) 100%);
            position: relative;
        }
        
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-dim), transparent);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent) 0%, #8b6914 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 0 20px var(--accent-dim);
        }
        
        .logo h1 {
            font-family: var(--font-display);
            font-size: 1.4rem;
            font-weight: 400;
            color: var(--accent);
            letter-spacing: -0.01em;
        }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Navigation - refined tab bar */
        .nav-tabs {
            display: flex;
            gap: 2px;
            padding: 0.5rem 1rem;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            scrollbar-width: none;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }
        
        .nav-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            border-radius: var(--radius-sm);
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-family: var(--font-body);
            font-size: 0.82rem;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
            letter-spacing: 0.01em;
        }
        
        .nav-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .nav-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
            font-weight: 600;
            box-shadow: 0 0 16px var(--accent-dim);
        }
        
        .nav-tab i {
            width: 16px;
            height: 16px;
        }
        
        /* Main content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
        }
        
        /* Buttons - refined */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.65rem 1.25rem;
            border-radius: var(--radius-sm);
            border: none;
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.01em;
        }
        
        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 0 20px var(--accent-dim);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-hover);
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 0.5rem;
        }
        
        .btn-ghost:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .btn i {
            width: 16px;
            height: 16px;
        }
        
        /* Cards - premium feel */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: border-color 0.2s;
        }
        
        .card:hover {
            border-color: var(--border-hover);
        }
        
        .card-header {
            padding: 0.85rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-header h3 {
            font-family: var(--font-display);
            font-size: 1.05rem;
            font-weight: 400;
            color: var(--text-primary);
        }
        
        .card-body {
            padding: 1.25rem;
        }
        
        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        /* Upload zone - cinematic */
        .upload-zone {
            border: 1px dashed rgba(200, 164, 78, 0.25);
            border-radius: var(--radius-xl);
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--accent-dim) 0%, transparent 60%);
            position: relative;
        }
        
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            background: linear-gradient(135deg, var(--accent-dim) 0%, rgba(200,164,78,0.06) 60%);
            box-shadow: 0 0 40px var(--accent-dim);
            transform: translateY(-2px);
        }
        
        .upload-zone i {
            width: 48px;
            height: 48px;
            color: var(--accent);
            margin-bottom: 1rem;
        }
        
        .upload-zone h3 {
            font-family: var(--font-display);
            font-size: 1.15rem;
            margin-bottom: 0.5rem;
            font-weight: 400;
        }
        
        .upload-zone p {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        /* Script list */
        .script-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.85rem 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .script-item:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
        }
        
        .script-icon {
            width: 44px;
            height: 44px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .script-icon i {
            width: 22px;
            height: 22px;
            color: var(--accent);
        }
        
        .script-info {
            flex: 1;
            min-width: 0;
        }
        
        .script-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .script-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .script-actions {
            display: flex;
            gap: 0.25rem;
        }
        
        /* Stats badges */
        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            background: var(--bg-elevated);
            border-radius: 100px;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }
        
        /* Character/Location cards */
        .entity-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.25s ease;
            border: 1px solid transparent;
            position: relative;
        }
        
        .entity-card:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-dim);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .entity-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .entity-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Storyframe */
        .storyframe-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .storyframe-input {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.9rem;
            resize: vertical;
            transition: border-color 0.2s;
        }
        
        .storyframe-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        .genre-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .genre-btn {
            padding: 0.45rem 0.9rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 100px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-body);
            font-size: 0.82rem;
        }
        
        .genre-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .genre-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
            font-weight: 600;
        }
        
        .week-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .week-header {
            padding: 0.65rem 1rem;
            background: var(--bg-secondary);
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .week-content {
            padding: 1rem;
        }
        
        .act-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .act-1 { background: #3b82f6; }
        .act-2 { background: #22c55e; }
        .act-3 { background: #f59e0b; }
        .act-4 { background: #ef4444; }
        .act-5 { background: #8b5cf6; }
        
        /* Chat - elegant messaging */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
        }
        
        .chat-message {
            max-width: 80%;
            padding: 0.85rem 1rem;
            border-radius: var(--radius-lg);
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .chat-message.user {
            background: var(--accent);
            color: var(--bg-primary);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.assistant {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.65rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        /* Script Accordion - refined */
        .script-accordion {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            transition: all 0.25s ease;
        }
        
        .script-accordion:hover {
            border-color: var(--border-hover);
        }
        
        .script-accordion.expanded {
            border-color: rgba(200, 164, 78, 0.2);
            box-shadow: 0 0 24px var(--accent-dim);
        }
        
        .script-accordion-header {
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .script-accordion-header:hover {
            background: var(--bg-tertiary);
        }
        
        .script-accordion-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-dim);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            flex-shrink: 0;
        }
        
        .script-accordion-info {
            flex: 1;
            min-width: 0;
        }
        
        .script-accordion-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .script-accordion-meta {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.35rem;
            flex-wrap: wrap;
        }
        
        .script-accordion-chevron {
            color: var(--text-muted);
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        
        .script-accordion.expanded .script-accordion-chevron {
            transform: rotate(180deg);
        }
        
        .script-accordion-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .script-accordion.expanded .script-accordion-body {
            max-height: 2000px;
        }
        
        .script-accordion-content {
            padding: 0 1.25rem 1.25rem 1.25rem;
            border-top: 1px solid var(--border);
        }
        
        .script-actions-bar {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .scene-summary-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .scene-summary-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .scene-summary-item:hover {
            background: var(--accent-dim);
        }
        
        .scene-summary-number {
            width: 26px;
            height: 26px;
            background: var(--accent);
            color: var(--bg-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
            flex-shrink: 0;
            font-family: var(--font-mono);
        }
        
        .scene-summary-content {
            flex: 1;
        }
        
        .scene-summary-header {
            font-weight: 500;
            font-size: 0.82rem;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }
        
        .scene-summary-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .generating-summaries {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--accent-dim);
            border-radius: var(--radius-md);
            color: var(--accent);
            border: 1px solid rgba(200,164,78,0.15);
        }
        
        /* Location Editor */
        .location-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .location-editor-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .location-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .location-header h2 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #3b82f6;
        }
        
        .location-body {
            padding: 1.5rem;
        }
        
        .location-field {
            margin-bottom: 1.25rem;
        }
        
        .location-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        
        .location-scenes-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .location-scene-item {
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        /* Export Format Selector */
        .export-format-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .export-format-btn {
            flex: 1;
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .export-format-btn:hover {
            border-color: var(--accent);
        }
        
        .export-format-btn.selected {
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        
        .export-format-btn i {
            display: block;
            margin: 0 auto 0.5rem;
            color: var(--accent);
        }
        
        /* Continuity Categories Expanded */
        .continuity-section {
            margin-bottom: 1.5rem;
        }
        
        .continuity-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }
        
        .continuity-section-header h4 {
            flex: 1;
            margin: 0;
            font-size: 0.95rem;
        }
        
        /* Script Search */
        .script-search-container {
            margin-bottom: 1.5rem;
        }
        
        .script-search-box {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .script-search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            padding-left: 2.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .script-search-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .script-search-wrapper {
            position: relative;
            flex: 1;
        }
        
        .script-search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }
        
        .search-results-card {
            background: var(--bg-secondary);
            border: 1px solid var(--accent);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .search-results-header {
            padding: 1rem;
            background: var(--accent-dim);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-result-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: var(--bg-tertiary);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-highlight {
            background: var(--accent-glow);
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
        }
        
        .search-result-context {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-family: monospace;
        }
        
        /* Wisdom cards */
        .wisdom-category {
            margin-bottom: 2rem;
        }
        
        .wisdom-category h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }
        
        .wisdom-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }
        
        .wisdom-quote {
            font-style: italic;
            margin-bottom: 0.5rem;
        }
        
        .wisdom-author {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: right;
        }
        
        /* Modal - premium overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 100;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-body {
            padding: 1.25rem;
        }
        
        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        /* Form elements */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.82rem;
            letter-spacing: 0.02em;
        }
        
        .form-input {
            width: 100%;
            padding: 0.65rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        /* Scene viewer */
        .scene-viewer {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 50;
            display: flex;
            flex-direction: column;
        }
        
        .scene-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .scene-header-text {
            font-family: var(--font-mono);
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: var(--accent);
            font-size: 0.9rem;
        }
        
        .scene-action {
            font-family: var(--font-mono);
            margin: 0.5rem 0;
            font-size: 0.88rem;
        }
        
        .scene-character {
            font-family: var(--font-mono);
            font-weight: bold;
            text-align: center;
            margin-top: 1.5rem;
            margin-bottom: 0;
            font-size: 0.88rem;
        }
        
        .scene-dialogue {
            font-family: var(--font-mono);
            margin: 0 auto;
            max-width: 400px;
            text-align: center;
            font-size: 0.88rem;
        }
        
        .scene-parenthetical {
            font-family: var(--font-mono);
            font-style: italic;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        /* Continuity */
        .continuity-issue {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 3px solid var(--error);
            margin-bottom: 0.5rem;
        }
        
        .continuity-issue.warning {
            border-left-color: var(--accent);
        }
        
        .continuity-issue.ok {
            border-left-color: var(--success);
        }
        
        .continuity-issue.info {
            border-left-color: #3b82f6;
        }
        
        .continuity-category {
            margin-bottom: 1.5rem;
        }
        
        .continuity-category-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
        }
        
        .continuity-category-header:hover {
            background: var(--bg-tertiary);
        }
        
        .continuity-count {
            margin-left: auto;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .continuity-count.error { background: var(--error); color: white; }
        .continuity-count.warning { background: var(--accent); color: var(--bg-primary); }
        .continuity-count.ok { background: var(--success); color: white; }
        
        /* Location Editor Modal */
        .location-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }
        
        .location-editor-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .location-editor-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .location-editor-body {
            padding: 1.25rem;
        }
        
        .location-field {
            margin-bottom: 1rem;
        }
        
        .location-field label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .location-scenes-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .location-scene-item {
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        /* Writer Assistant Styles */
        .writer-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .method-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .method-btn {
            padding: 0.75rem 1.25rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .method-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .method-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .beat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .beat-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .beat-card:hover {
            border-color: var(--accent);
        }
        
        .beat-card.active {
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        
        .beat-card.completed {
            border-color: var(--success);
        }
        
        .beat-number {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .beat-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .beat-status {
            font-size: 0.8rem;
        }
        
        .beat-status.empty { color: var(--text-muted); }
        .beat-status.filled { color: var(--success); }
        
        .beat-editor {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .beat-editor-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }
        
        .beat-editor-body {
            padding: 1.25rem;
        }
        
        .beat-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }
        
        .beat-textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .beat-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        .suggestion-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .suggestions-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .suggestion-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion-card:hover {
            background: var(--border);
        }
        
        .suggestion-card.conventional { border-left-color: #22c55e; }
        .suggestion-card.surprising { border-left-color: #f59e0b; }
        .suggestion-card.bold { border-left-color: #ef4444; }
        
        .suggestion-label {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .suggestion-label.conventional { color: #22c55e; }
        .suggestion-label.surprising { color: #f59e0b; }
        .suggestion-label.bold { color: #ef4444; }
        
        .suggestion-text {
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .master-tip {
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-dim), transparent);
            border-radius: var(--radius-md);
            border: 1px solid rgba(200, 164, 78, 0.15);
            margin-top: 1rem;
        }
        
        .master-tip-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--accent);
        }
        
        .master-tip-quote {
            font-style: italic;
            margin-bottom: 0.5rem;
        }
        
        .master-tip-example {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .masters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .master-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .master-card:hover {
            border-color: var(--accent);
            background: var(--border);
        }
        
        .master-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .master-works {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .master-technique {
            font-size: 0.85rem;
            color: var(--accent);
        }
        
        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            border-color: var(--accent);
        }
        
        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .beat-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .project-setup {
            display: grid;
            gap: 1rem;
        }
        
        .tabs-sub {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .tab-sub {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .tab-sub:hover {
            background: var(--bg-secondary);
        }
        
        .tab-sub.active {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }
        
        .empty-state i {
            width: 56px;
            height: 56px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            font-family: var(--font-display);
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0.6rem 0.85rem;
            }
            
            .logo h1 {
                font-size: 1.15rem;
            }
            
            .nav-tabs {
                padding: 0.4rem 0.5rem;
            }
            
            .nav-tab {
                padding: 0.45rem 0.65rem;
                font-size: 0.78rem;
            }
            
            .nav-tab span {
                display: none;
            }
            
            .main-content {
                padding: 0.85rem;
            }
            
            .chat-message {
                max-width: 92%;
            }
        }
        
        /* Scrollbar - subtle */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 100px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-elevated);
        }

        /* Hidden file input */
        .hidden-input {
            display: none;
        }

        /* ========================================
           NEW FEATURES STYLES
           ======================================== */

        /* Scene Builder Styles */
        .scene-builder {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .scene-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .scene-form-full {
            grid-column: 1 / -1;
        }

        .scene-preview {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            font-family: var(--font-mono);
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.88rem;
            border: 1px solid var(--border);
        }

        .scene-preview .scene-heading {
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .scene-preview .action {
            margin: 0.5rem 0;
        }

        .scene-preview .character-name {
            text-align: center;
            font-weight: bold;
            margin-top: 1rem;
            text-transform: uppercase;
        }

        .scene-preview .dialogue {
            text-align: center;
            max-width: 60%;
            margin: 0 auto;
        }

        .scene-preview .parenthetical {
            text-align: center;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Dialogue Generator Styles */
        .dialogue-generator {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .dialogue-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .dialogue-option {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .dialogue-option:hover {
            border-color: var(--accent);
        }

        .dialogue-option.selected {
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .dialogue-option-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .dialogue-preview {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 1rem;
            font-family: var(--font-mono);
            font-size: 0.88rem;
            border: 1px solid var(--border);
        }

        /* Conflict Escalator Styles */
        .conflict-scale {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .conflict-level {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid;
        }

        .conflict-level:hover {
            background: var(--border);
        }

        .conflict-level.level-1 { border-left-color: #22c55e; }
        .conflict-level.level-2 { border-left-color: #84cc16; }
        .conflict-level.level-3 { border-left-color: #f59e0b; }
        .conflict-level.level-4 { border-left-color: #f97316; }
        .conflict-level.level-5 { border-left-color: #ef4444; }

        .conflict-level-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--bg-primary);
        }

        .conflict-level.level-1 .conflict-level-number { background: #22c55e; }
        .conflict-level.level-2 .conflict-level-number { background: #84cc16; }
        .conflict-level.level-3 .conflict-level-number { background: #f59e0b; }
        .conflict-level.level-4 .conflict-level-number { background: #f97316; }
        .conflict-level.level-5 .conflict-level-number { background: #ef4444; }

        .conflict-content {
            flex: 1;
        }

        .conflict-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .conflict-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Plot Twist Generator Styles */
        .twist-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .twist-category-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .twist-category-btn:hover {
            border-color: var(--accent);
        }

        .twist-category-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        .twist-results {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .twist-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            cursor: pointer;
            transition: all 0.2s;
        }

        .twist-card:hover {
            background: var(--border);
        }

        .twist-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .twist-setup {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .twist-example {
            font-size: 0.85rem;
            font-style: italic;
            color: var(--text-muted);
        }

        /* Export Modal Styles */
        .export-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .export-option {
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .export-option:hover {
            border-color: var(--accent);
        }

        .export-option i {
            width: 32px;
            height: 32px;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .export-option-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .export-option-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Master Detail Modal */
        .master-detail-modal {
            max-width: 600px;
        }

        .master-detail-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .master-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent), #8b6914);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 0 20px var(--accent-dim);
        }

        .master-info h2 {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .master-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .master-technique-box {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .master-technique-label {
            font-size: 0.85rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .master-quote-box {
            background: linear-gradient(135deg, var(--accent-dim), transparent);
            border: 1px solid rgba(200, 164, 78, 0.15);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .master-quote-box blockquote {
            font-family: var(--font-display);
            font-style: italic;
            font-size: 1.05rem;
            margin: 0;
            color: var(--text-primary);
        }

        /* Tool tabs in Writer */
        .tool-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tool-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .tool-tab:hover {
            background: var(--bg-secondary);
        }

        .tool-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .tool-tab i {
            width: 16px;
            height: 16px;
        }

        /* Copy button */
        .copy-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .copy-btn.copied {
            background: var(--success);
            color: white;
        }

        /* Character Ruit styles */
        .character-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }

        .character-card.has-ruit {
            border-left: 3px solid var(--success);
        }

        .ruit-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--success);
            font-size: 1rem;
        }

        .ruit-editor-modal {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .ruit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .ruit-section {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
        }

        .ruit-section-title {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ruit-section-full {
            grid-column: 1 / -1;
        }

        .ruit-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .ruit-tag {
            background: var(--bg-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ruit-tag-remove {
            cursor: pointer;
            color: var(--error);
            font-weight: bold;
        }

        .ruit-photo-upload {
            width: 120px;
            height: 120px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
        }

        .ruit-photo-upload:hover {
            border-color: var(--accent);
        }

        .ruit-photo-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ruit-visual {
            display: flex;
            justify-content: center;
            margin: 1rem 0;
        }

        .ruit-diamond {
            position: relative;
            width: 300px;
            height: 300px;
        }

        .ruit-diamond-shape {
            position: absolute;
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, var(--accent-dim), rgba(139, 92, 246, 0.08));
            border: 2px solid var(--accent);
            transform: rotate(45deg);
            top: 50px;
            left: 50px;
        }

        .ruit-label {
            position: absolute;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            max-width: 80px;
        }

        .ruit-label.top { top: 0; left: 50%; transform: translateX(-50%); }
        .ruit-label.right { top: 50%; right: 0; transform: translateY(-50%); }
        .ruit-label.bottom { bottom: 0; left: 50%; transform: translateX(-50%); }
        .ruit-label.left { top: 50%; left: 0; transform: translateY(-50%); }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 10;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Progress indicator */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #dbb85e);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Tabs scrollable */
        .tabs-sub {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Animation for new items */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <!-- App content rendered by JavaScript -->
    </div>

    <script>
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    
    const state = {
        activeTab: 'scripts',
        scripts: [],
        characters: [],
        locations: [],
        selectedScript: null,
        selectedScene: null,
        storyframe: {
            longLine: '',
            genre: 'drama',
            totalWeeks: 10,
            weeks: []
        },
        chat: {
            messages: [],
            isLoading: false
        },
        settings: {
            apiKey: '',
            proxyUrl: 'https://actingtool.ferencsomogyi.workers.dev/v1/messages'
        },
        ui: {
            showSettings: false,
            showSceneViewer: false,
            isProcessing: false,
            showMasterDetail: null,
            showExportModal: false,
            showRuitEditor: null, // Character key for ruit editor modal
            ruitViewMode: 'edit', // 'edit', 'visual', 'import'
            showSessionManager: false,
            expandedScripts: {}, // Track which scripts are expanded: { scriptIndex: true }
            generatingSummaries: null, // scriptIndex when generating summaries
            showLocationEditor: null, // Location name for editor modal
            continuityReport: null, // Cached AI continuity report
            generatingContinuity: false,
            scriptSearch: '', // Current search query
            scriptSearchResults: null // Search results array
        },
        // Session management
        session: {
            currentId: null,
            currentName: 'Nieuwe Sessie'
        },
        // NEW: Writer Assistant State
        writer: {
            subTab: 'beats', // beats, scene, dialogue, conflict, twist
            method: 'savethecat',
            genre: 'thriller',
            logline: '',
            currentBeat: 0,
            beats: {},
            suggestions: [],
            isGenerating: false,
            masterFilter: 'all',
            selectedMaster: null, // ID van geselecteerde meester
            // Scene Builder state
            scene: {
                location: '',
                timeOfDay: 'DAY',
                intExt: 'INT',
                characters: [],
                objective: '',
                conflict: '',
                tone: 'neutral',
                generatedScene: ''
            },
            // Dialogue Generator state
            dialogue: {
                speaker: '',
                listener: '',
                objective: '',
                subtext: '',
                tone: 'neutral',
                options: [],
                selectedOption: null
            },
            // Conflict Escalator state
            conflict: {
                baseConflict: '',
                escalations: [],
                selectedLevel: null
            },
            // Plot Twist state
            twist: {
                category: 'all',
                context: '',
                twists: []
            }
        }
    };

    // ============================================
    // SESSION MANAGEMENT
    // ============================================

    function generateSessionId() {
        return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function getAllSessions() {
        try {
            return JSON.parse(localStorage.getItem('scriptmaster_sessions') || '[]');
        } catch (e) {
            return [];
        }
    }

    function saveSessionsList(sessions) {
        localStorage.setItem('scriptmaster_sessions', JSON.stringify(sessions));
    }

    function getCurrentSessionData() {
        return {
            id: state.session.currentId,
            name: state.session.currentName,
            updatedAt: new Date().toISOString(),
            scripts: state.scripts,
            storyframe: state.storyframe,
            chat: state.chat,
            writer: state.writer
        };
    }

    function createNewSession(name = null) {
        // Save current session first if it exists and has data
        if (state.session.currentId && (state.scripts.length > 0 || state.storyframe.longLine)) {
            saveCurrentSession();
        }

        // Create new session
        const sessionId = generateSessionId();
        const sessionName = name || `Sessie ${new Date().toLocaleDateString('nl-NL')} ${new Date().toLocaleTimeString('nl-NL', {hour: '2-digit', minute: '2-digit'})}`;
        
        // Reset state for new session
        state.session.currentId = sessionId;
        state.session.currentName = sessionName;
        state.scripts = [];
        state.characters = [];
        state.locations = [];
        state.storyframe = { longLine: '', genre: 'drama', totalWeeks: 10, weeks: [], notes: '' };
        state.chat = { messages: [], isLoading: false };
        state.writer.beats = {};
        state.writer.logline = '';
        state.writer.scene = { location: '', timeOfDay: 'DAY', intExt: 'INT', characters: [], objective: '', conflict: '', tone: 'neutral', generatedScene: '' };
        
        // Clear ruiten for new session
        localStorage.removeItem('scriptmaster_ruiten');
        
        // Save to sessions list
        const sessions = getAllSessions();
        sessions.unshift({
            id: sessionId,
            name: sessionName,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            scriptCount: 0
        });
        saveSessionsList(sessions);
        
        // Save active session id
        localStorage.setItem('scriptmaster_active_session', sessionId);
        
        saveState();
        render();
        
        return sessionId;
    }

    function saveCurrentSession() {
        if (!state.session.currentId) {
            state.session.currentId = generateSessionId();
            state.session.currentName = `Sessie ${new Date().toLocaleDateString('nl-NL')}`;
        }
        
        // Save session data
        const sessionData = getCurrentSessionData();
        localStorage.setItem(`scriptmaster_session_${state.session.currentId}`, JSON.stringify(sessionData));
        
        // Save ruiten separately with session prefix
        const ruiten = JSON.parse(localStorage.getItem('scriptmaster_ruiten') || '{}');
        localStorage.setItem(`scriptmaster_ruiten_${state.session.currentId}`, JSON.stringify(ruiten));
        
        // Update sessions list
        const sessions = getAllSessions();
        const sessionIndex = sessions.findIndex(s => s.id === state.session.currentId);
        if (sessionIndex >= 0) {
            sessions[sessionIndex].updatedAt = new Date().toISOString();
            sessions[sessionIndex].scriptCount = state.scripts.length;
            sessions[sessionIndex].name = state.session.currentName;
        } else {
            sessions.unshift({
                id: state.session.currentId,
                name: state.session.currentName,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                scriptCount: state.scripts.length
            });
        }
        saveSessionsList(sessions);
        
        localStorage.setItem('scriptmaster_active_session', state.session.currentId);
    }

    function loadSession(sessionId) {
        try {
            const sessionData = JSON.parse(localStorage.getItem(`scriptmaster_session_${sessionId}`) || 'null');
            if (!sessionData) {
                alert('Sessie niet gevonden.');
                return false;
            }
            
            // Load session data into state
            state.session.currentId = sessionData.id;
            state.session.currentName = sessionData.name;
            state.scripts = sessionData.scripts || [];
            state.storyframe = sessionData.storyframe || { longLine: '', genre: 'drama', totalWeeks: 10, weeks: [] };
            state.chat = sessionData.chat || { messages: [], isLoading: false };
            if (sessionData.writer) {
                Object.assign(state.writer, sessionData.writer);
            }
            
            // Load ruiten for this session
            const ruiten = JSON.parse(localStorage.getItem(`scriptmaster_ruiten_${sessionId}`) || '{}');
            localStorage.setItem('scriptmaster_ruiten', JSON.stringify(ruiten));
            
            rebuildIndexes();
            
            localStorage.setItem('scriptmaster_active_session', sessionId);
            
            state.ui.showSessionManager = false;
            render();
            
            return true;
        } catch (e) {
            console.error('Error loading session:', e);
            alert('Fout bij laden van sessie.');
            return false;
        }
    }

    function deleteSession(sessionId) {
        if (!confirm('Weet je zeker dat je deze sessie wilt verwijderen? Dit kan niet ongedaan worden gemaakt.')) {
            return;
        }
        
        // Remove session data
        localStorage.removeItem(`scriptmaster_session_${sessionId}`);
        localStorage.removeItem(`scriptmaster_ruiten_${sessionId}`);
        
        // Update sessions list
        let sessions = getAllSessions();
        sessions = sessions.filter(s => s.id !== sessionId);
        saveSessionsList(sessions);
        
        // If we deleted the current session, create a new one
        if (state.session.currentId === sessionId) {
            if (sessions.length > 0) {
                loadSession(sessions[0].id);
            } else {
                createNewSession();
            }
        } else {
            render();
        }
    }

    function renameSession(sessionId, newName) {
        if (!newName || !newName.trim()) return;
        
        const sessions = getAllSessions();
        const session = sessions.find(s => s.id === sessionId);
        if (session) {
            session.name = newName.trim();
            saveSessionsList(sessions);
            
            if (state.session.currentId === sessionId) {
                state.session.currentName = newName.trim();
                saveCurrentSession();
            }
            
            render();
        }
    }

    function clearAllData() {
        if (!confirm('WAARSCHUWING: Dit verwijdert ALLE data inclusief alle sessies, scripts en karakters. Weet je dit zeker?')) {
            return;
        }
        if (!confirm('Laatste kans: Echt ALLES verwijderen?')) {
            return;
        }
        
        // Clear all scriptmaster data from localStorage
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('scriptmaster_')) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // Reset state and create fresh session
        state.scripts = [];
        state.characters = [];
        state.locations = [];
        state.storyframe = { longLine: '', genre: 'drama', totalWeeks: 10, weeks: [] };
        state.chat = { messages: [], isLoading: false };
        state.session.currentId = null;
        state.session.currentName = 'Nieuwe Sessie';
        
        createNewSession('Eerste Sessie');
        
        alert('Alle data is gewist.');
    }

    // Load from localStorage
    function loadState() {
        try {
            // Load settings (global, not per session)
            const savedSettings = localStorage.getItem('scriptmaster_settings');
            if (savedSettings) {
                Object.assign(state.settings, JSON.parse(savedSettings));
            }
            
            // Check for active session
            const activeSessionId = localStorage.getItem('scriptmaster_active_session');
            
            if (activeSessionId) {
                // Try to load the active session
                const sessionData = localStorage.getItem(`scriptmaster_session_${activeSessionId}`);
                if (sessionData) {
                    const parsed = JSON.parse(sessionData);
                    state.session.currentId = parsed.id;
                    state.session.currentName = parsed.name || 'Sessie';
                    state.scripts = parsed.scripts || [];
                    state.storyframe = parsed.storyframe || { longLine: '', genre: 'drama', totalWeeks: 10, weeks: [] };
                    state.chat = parsed.chat || { messages: [], isLoading: false };
                    if (parsed.writer) {
                        Object.assign(state.writer, parsed.writer);
                    }
                    
                    // Load ruiten for this session
                    const ruiten = localStorage.getItem(`scriptmaster_ruiten_${activeSessionId}`);
                    if (ruiten) {
                        localStorage.setItem('scriptmaster_ruiten', ruiten);
                    }
                    
                    rebuildIndexes();
                    return;
                }
            }
            
            // Fallback: try old format for migration
            const oldState = localStorage.getItem('scriptmaster_state');
            if (oldState) {
                const parsed = JSON.parse(oldState);
                state.scripts = parsed.scripts || [];
                Object.assign(state.settings, parsed.settings || {});
                Object.assign(state.storyframe, parsed.storyframe || {});
                if (parsed.writer) {
                    Object.assign(state.writer, parsed.writer);
                }
                rebuildIndexes();
                
                // Migrate to new session format
                createNewSession('Gemigreerde Sessie');
                
                // Remove old format
                localStorage.removeItem('scriptmaster_state');
                return;
            }
            
            // No data found, create first session
            if (!state.session.currentId) {
                createNewSession('Eerste Sessie');
            }
            
        } catch (e) {
            console.error('Error loading state:', e);
            createNewSession('Nieuwe Sessie');
        }
    }

    // Save to localStorage
    function saveState() {
        try {
            // Save settings globally
            localStorage.setItem('scriptmaster_settings', JSON.stringify(state.settings));
            
            // Save current session
            saveCurrentSession();
            
        } catch (e) {
            console.error('Error saving state:', e);
        }
    }

    // Rebuild character and location indexes from scripts
    function rebuildIndexes() {
        const charMap = new Map();
        const locMap = new Map();

        // Load saved ruiten from localStorage
        const savedRuiten = JSON.parse(localStorage.getItem('scriptmaster_ruiten') || '{}');

        state.scripts.forEach((script, scriptIndex) => {
            script.scenes?.forEach((scene, sceneIndex) => {
                // Locations
                if (scene.location) {
                    const locKey = scene.location.toUpperCase();
                    if (!locMap.has(locKey)) {
                        locMap.set(locKey, {
                            name: scene.location,
                            scenes: [],
                            scripts: new Set()
                        });
                    }
                    locMap.get(locKey).scenes.push({ scriptIndex, sceneIndex, header: scene.header });
                    locMap.get(locKey).scripts.add(script.title);
                }

                // Characters
                scene.characters?.forEach(charName => {
                    const charKey = charName.toUpperCase();
                    if (!charMap.has(charKey)) {
                        charMap.set(charKey, {
                            name: charName,
                            scenes: [],
                            scripts: new Set(),
                            dialogueCount: 0,
                            // Ruit structure - load saved or use empty defaults
                            ruit: savedRuiten[charKey] || {
                                kernbehoefte: '',
                                kernbehoefteLabel: '', // bijv. "Liefde", "Macht", "Veiligheid"
                                masker: '',
                                kernverhaal: [],
                                valkuilen: [],
                                kracht: [],
                                donkereKant: [],
                                angsten: [],
                                gedragspatronen: [],
                                moetWorden: [],
                                foto: ''
                            }
                        });
                    }
                    charMap.get(charKey).scenes.push({ scriptIndex, sceneIndex });
                    charMap.get(charKey).scripts.add(script.title);
                    charMap.get(charKey).dialogueCount += scene.dialogues?.filter(d => 
                        d.character.toUpperCase() === charKey
                    ).length || 0;
                });
            });
        });

        state.characters = Array.from(charMap.values()).map(c => ({
            ...c,
            scripts: Array.from(c.scripts)
        })).sort((a, b) => b.dialogueCount - a.dialogueCount);

        state.locations = Array.from(locMap.values()).map(l => ({
            ...l,
            scripts: Array.from(l.scripts)
        })).sort((a, b) => b.scenes.length - a.scenes.length);
    }
    
    // Save character ruit to localStorage
    function saveCharacterRuit(charKey, ruit) {
        const savedRuiten = JSON.parse(localStorage.getItem('scriptmaster_ruiten') || '{}');
        savedRuiten[charKey] = ruit;
        localStorage.setItem('scriptmaster_ruiten', JSON.stringify(savedRuiten));
        
        // Also update state
        const char = state.characters.find(c => c.name.toUpperCase() === charKey);
        if (char) {
            char.ruit = ruit;
        }
        render();
    }
    
    // Get ruit for character
    function getCharacterRuit(charKey) {
        const char = state.characters.find(c => c.name.toUpperCase() === charKey);
        return char?.ruit || null;
    }
    
    // Check if character has ruit filled in
    function hasRuitData(ruit) {
        if (!ruit) return false;
        return ruit.kernbehoefte || ruit.masker || ruit.valkuilen?.length > 0 || 
               ruit.kracht?.length > 0 || ruit.angsten?.length > 0;
    }

    // ============================================
    // SCRIPT PARSING
    // ============================================
    
    // Detecteer of een script het GTST/Dutch TV format gebruikt
    function detectGTSTFormat(text) {
        // GTST format indicators:
        // 1. Scene codes like "6931 01 A2 1:20"
        // 2. Numbered dialogue like "1. RIK"
        // 3. Dutch character name patterns
        // 4. Lack of INT./EXT. markers
        
        const lines = text.split('\n').slice(0, 100); // Check first 100 lines
        let gtssIndicators = 0;
        let hollywoodIndicators = 0;
        
        for (const line of lines) {
            const trimmed = line.trim();
            
            // GTST indicators
            if (trimmed.match(/^\d{4}\s+\d+\s+[A-Z]\d?\s+[\d:]+/)) gtssIndicators += 3;
            if (trimmed.match(/^\d+\.\s*[A-Z]+/)) gtssIndicators += 2;
            if (trimmed.match(/^SC\.?\s*\d+/i)) gtssIndicators += 1;
            
            // Hollywood indicators
            if (trimmed.match(/^(INT\.|EXT\.)/i)) hollywoodIndicators += 3;
            if (trimmed.match(/^FADE (IN|OUT)/i)) hollywoodIndicators += 1;
            if (trimmed.match(/^CUT TO:/i)) hollywoodIndicators += 1;
        }
        
        console.log(`Format detection - GTST: ${gtssIndicators}, Hollywood: ${hollywoodIndicators}`);
        return gtssIndicators > hollywoodIndicators;
    }

    function parseScript(text, filename) {
        const lines = text.split('\n');
        const scenes = [];
        const characters = new Set();
        const locations = new Set();
        
        let currentScene = null;
        let sceneNumber = 0;
        let lastCharacter = null;
        let isDialogue = false;
        
        // Detecteer script format
        const isGTSTFormat = detectGTSTFormat(text);
        console.log('Script format detected:', isGTSTFormat ? 'GTST/Dutch TV' : 'Standard Hollywood');

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const trimmed = line.trim();
            
            // === SCENE HEADER DETECTION ===
            
            // Standard Hollywood format: INT./EXT. LOCATION - TIME
            const standardMatch = trimmed.match(/^(INT\.|EXT\.|INT\/EXT\.|I\/E\.)/i);
            
            // GTST format: "6932 01 A3 0:50 B.O. INT. HOTEL / BAR"
            // Pattern: episode TAB scene_num TAB code TAB timing TAB location
            const gtssMatch = trimmed.match(/^(\d{4})\t(\d+)\t([A-Z]\d?)\t([\d:]+)\t(.+)/);
            
            // Also match simpler GTST format without tabs: "6932 01 A3 0:50 LOCATION"
            const gtssMatchSpaces = !gtssMatch && trimmed.match(/^(\d{4})\s+(\d+)\s+([A-Z]\d?)\s+([\d:]+)\s+(.+)/);
            
            // Match explicit scene markers (not numbered dialogue which is "1. NAME")
            // Only match "SC 1", "SCENE 1", "SCNE 1" - NOT "1. Janine"
            const simpleSceneMatch = trimmed.match(/^(SC\.?\s+\d+|SCENE\s+\d+|SCNE\s+\d+)\s*(.*)$/i);
            
            if (standardMatch || gtssMatch || gtssMatchSpaces || simpleSceneMatch) {
                if (currentScene) {
                    scenes.push(currentScene);
                }
                sceneNumber++;
                
                let locationPart = '';
                let timePart = '';
                let header = trimmed;
                
                if (standardMatch) {
                    // Standard Hollywood parsing
                    const headerParts = trimmed.split('-');
                    locationPart = headerParts[0].replace(/^(INT\.|EXT\.|INT\/EXT\.|I\/E\.)\s*/i, '').trim();
                    timePart = headerParts[1]?.trim() || '';
                } else if (gtssMatch || gtssMatchSpaces) {
                    // GTST format: extract location from last part
                    const match = gtssMatch || gtssMatchSpaces;
                    const locationRaw = match[5]; // The location part
                    timePart = match[4]; // The timing
                    
                    // Location might have time of day at end after another tab
                    const locParts = locationRaw.split('\t');
                    locationPart = locParts[0]?.trim() || locationRaw;
                    if (locParts[1]) {
                        timePart = locParts[1].trim(); // DAG/AVOND etc
                    }
                } else if (simpleSceneMatch) {
                    // Simple scene number format
                    locationPart = simpleSceneMatch[2]?.trim() || `Scene ${sceneNumber}`;
                }
                
                locations.add(locationPart);
                
                currentScene = {
                    number: sceneNumber,
                    header: header,
                    location: locationPart,
                    time: timePart,
                    characters: [],
                    dialogues: [],
                    content: [trimmed]
                };
                lastCharacter = null;
                isDialogue = false;
                continue;
            }

            if (!currentScene) continue;

            // === CHARACTER NAME DETECTION ===
            
            // GTST numbered dialogue format: "1. RIK" or "2. SHANTI"
            const numberedCharMatch = trimmed.match(/^(\d+)\.\s*([A-Z][A-Z\s\.\']+)$/);
            if (numberedCharMatch) {
                const charName = numberedCharMatch[2].trim();
                characters.add(charName);
                if (!currentScene.characters.includes(charName)) {
                    currentScene.characters.push(charName);
                }
                lastCharacter = charName;
                isDialogue = true;
                currentScene.content.push(line);
                continue;
            }
            
            // Dutch TV character format: "RIK DE JONG" on its own line (full name, all caps)
            // These are often character introductions in scene descriptions
            const dutchCharMatch = trimmed.match(/^([A-Z][A-Z\s]+)$/);
            if (dutchCharMatch && trimmed.length >= 3 && trimmed.length < 30 &&
                !trimmed.match(/^(INT|EXT|FADE|CUT|DISSOLVE|THE END|CONTINUED|LATER|DAG|NACHT|AVOND|OCHTEND)$/i)) {
                const charName = dutchCharMatch[1].trim();
                characters.add(charName);
                if (!currentScene.characters.includes(charName)) {
                    currentScene.characters.push(charName);
                }
                // Don't set as lastCharacter here - these are often scene introductions, not dialogue
                currentScene.content.push(line);
                continue;
            }

            // Standard Hollywood character format (ALL CAPS, possibly with parenthetical)
            const charMatch = trimmed.match(/^([A-Z][A-Z\s\.\']+)(\s*\([^)]+\))?$/);
            if (charMatch && trimmed.length > 1 && trimmed.length < 40 && 
                !trimmed.match(/^(INT\.|EXT\.|FADE|CUT|DISSOLVE|THE END)/i)) {
                const charName = charMatch[1].trim();
                
                // Validate it's likely a character name
                if (charName.length >= 2 && !charName.match(/^\d/) && 
                    !charName.match(/^(CONTINUED|CONT'D|MORE|LATER|ANGLE|CLOSE|WIDE|POV)$/i)) {
                    characters.add(charName);
                    if (!currentScene.characters.includes(charName)) {
                        currentScene.characters.push(charName);
                    }
                    lastCharacter = charName;
                    isDialogue = true;
                    currentScene.content.push(line);
                    continue;
                }
            }

            // Dialogue (follows a character name, often centered or indented)
            if (isDialogue && trimmed && lastCharacter) {
                // Check if it's a parenthetical
                if (trimmed.match(/^\([^)]+\)$/)) {
                    currentScene.dialogues.push({
                        character: lastCharacter,
                        type: 'parenthetical',
                        text: trimmed
                    });
                } else if (!trimmed.match(/^([A-Z][A-Z\s\.\']+)$/)) {
                    // It's dialogue text
                    currentScene.dialogues.push({
                        character: lastCharacter,
                        type: 'dialogue',
                        text: trimmed
                    });
                }
                currentScene.content.push(line);
                continue;
            }

            // Action line
            if (trimmed) {
                isDialogue = false;
                lastCharacter = null;
                currentScene.content.push(line);
            }
        }

        // Don't forget the last scene
        if (currentScene) {
            scenes.push(currentScene);
        }
        
        // FALLBACK: Als geen scenes gevonden, maak 1 scene van hele tekst
        if (scenes.length === 0 && text.trim().length > 0) {
            console.warn('No scenes detected - creating fallback scene from raw text');
            
            // Probeer nog karakters te vinden via een simpelere methode
            const capsWords = text.match(/\b([A-Z]{2,}(?:\s+[A-Z]{2,})?)\b/g) || [];
            const potentialChars = capsWords.filter(w => 
                w.length >= 3 && 
                w.length < 25 &&
                !w.match(/^(INT|EXT|DAG|NACHT|LATER|AVOND|OCHTEND|SCENE|THE|END|FADE|CUT)$/i)
            );
            // Dedupe and limit
            const uniqueChars = [...new Set(potentialChars)].slice(0, 10);
            uniqueChars.forEach(c => characters.add(c));
            
            scenes.push({
                number: 1,
                header: 'SCRIPT (geen scenes gedetecteerd)',
                location: 'Onbekend',
                time: '',
                characters: uniqueChars,
                dialogues: [],
                content: text.split('\n').filter(l => l.trim())
            });
            
            locations.add('Onbekend');
        }

        console.log(`Parsing complete: ${scenes.length} scenes, ${characters.size} characters, ${locations.size} locations`);

        return {
            title: filename.replace(/\.(txt|fountain|fdx|pdf|docx)$/i, ''),
            filename: filename,
            uploadedAt: new Date().toISOString(),
            scenes: scenes,
            characters: Array.from(characters),
            locations: Array.from(locations),
            rawText: text,
            stats: {
                sceneCount: scenes.length,
                characterCount: characters.size,
                locationCount: locations.size,
                dialogueCount: scenes.reduce((sum, s) => sum + s.dialogues.length, 0),
                wordCount: text.split(/\s+/).length
            }
        };
    }

    // Extract text from PDF using PDF.js
    async function extractTextFromPDF(arrayBuffer) {
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            
            // Betere text reconstructie met newlines
            let lastY = null;
            let pageText = '';
            
            for (const item of content.items) {
                // Check of we naar een nieuwe regel moeten
                if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                    pageText += '\n';
                }
                pageText += item.str;
                lastY = item.transform[5];
            }
            
            fullText += pageText + '\n\n';
        }
        
        return fullText;
    }

    // Extract text from DOCX using Mammoth
    async function extractTextFromDOCX(arrayBuffer) {
        const result = await mammoth.extractRawText({ arrayBuffer });
        // Zorg voor proper newline formatting
        let text = result.value;
        
        // Hollywood format: voeg newlines toe voor INT./EXT.
        text = text.replace(/\s+(INT\.|EXT\.)/gi, '\n\n$1');
        
        // GTST format: voeg newlines toe voor scene codes (bijv. "6931 01 A2")
        text = text.replace(/\s+(\d{4}\s+\d+\s+[A-Z]\d?\s+[\d:]+)/g, '\n\n$1');
        
        // Voeg newlines toe voor genummerde dialogen (bijv. "1. RIK")
        text = text.replace(/\s+(\d+\.\s+[A-Z]{2,})/g, '\n$1');
        
        // 3+ spaties  newline (vaak gebruikt als scheidingsteken)
        text = text.replace(/\s{3,}/g, '\n');
        
        return text;
    }

    // Process uploaded file
    async function processFile(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        let text = '';

        try {
            if (ext === 'txt' || ext === 'fountain') {
                text = await file.text();
            } else if (ext === 'pdf') {
                const arrayBuffer = await file.arrayBuffer();
                text = await extractTextFromPDF(arrayBuffer);
            } else if (ext === 'docx') {
                const arrayBuffer = await file.arrayBuffer();
                text = await extractTextFromDOCX(arrayBuffer);
            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic'].includes(ext)) {
                // Image files - use AI vision to extract text
                text = await extractTextFromImage(file);
            } else {
                throw new Error(`Niet ondersteund bestandstype: .${ext}. Upload .txt, .fountain, .pdf, .docx, of een foto.`);
            }

            // Debug: log extracted text length
            console.log(`Extracted ${text.length} characters from ${file.name}`);

            // Use AI to analyze the script
            const script = await analyzeScriptWithAI(text, file.name);
            
            state.scripts.push(script);
            rebuildIndexes();
            saveState();
            return script;
        } catch (error) {
            console.error('Error processing file:', error);
            throw error;
        }
    }
    
    // Extract text from image using Claude Vision API
    async function extractTextFromImage(file) {
        if (!state.settings.apiKey) {
            throw new Error('API key vereist voor het lezen van afbeeldingen. Stel deze in bij Settings.');
        }
        
        state.ui.isProcessing = true;
        state.ui.processingMessage = 'Afbeelding wordt gelezen door AI...';
        render();
        
        try {
            // Convert to base64
            const arrayBuffer = await file.arrayBuffer();
            const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
            const mimeType = file.type || 'image/jpeg';
            
            const response = await fetch(state.settings.proxyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.settings.apiKey
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 4096,
                    messages: [{
                        role: 'user',
                        content: [
                            {
                                type: 'image',
                                source: {
                                    type: 'base64',
                                    media_type: mimeType,
                                    data: base64
                                }
                            },
                            {
                                type: 'text',
                                text: 'Dit is een foto van een script/scenario. Lees alle tekst die je ziet en geef deze exact terug als plain text. Behoud de opmaak zo goed mogelijk (scene headers, karakternamen, dialoog). Als je geen script/tekst ziet, beschrijf dan wat je ziet.'
                            }
                        ]
                    }]
                })
            });
            
            if (!response.ok) {
                throw new Error(`API fout: ${response.status}`);
            }
            
            const data = await response.json();
            return data.content?.[0]?.text || '';
        } finally {
            state.ui.isProcessing = false;
            state.ui.processingMessage = '';
            render();
        }
    }
    
    // AI-powered script analysis
    async function analyzeScriptWithAI(text, filename) {
        // Check if API key is available
        if (!state.settings.apiKey) {
            console.warn('No API key - falling back to basic parsing');
            return parseScript(text, filename);
        }
        
        // Truncate text if too long (keep first ~15000 chars for API limits)
        const maxChars = 15000;
        const truncatedText = text.length > maxChars 
            ? text.substring(0, maxChars) + '\n\n[... tekst afgekapt voor analyse ...]' 
            : text;
        
        const prompt = `Je bent een script-analyse expert. Analyseer het volgende script en geef een gestructureerde JSON response.

LET OP: Dit script kan elk format hebben (Hollywood, Nederlands TV zoals GTST, Fountain, etc). Bepaal zelf wat scenes zijn, wie de karakters zijn, etc.

=== SCRIPT TEKST ===
${truncatedText}

=== INSTRUCTIES ===
Analyseer dit script en retourneer ALLEEN een JSON object (geen andere tekst) met deze structuur:

{
  "scenes": [
    {
      "number": 1,
      "header": "De scene header/titel zoals in het script",
      "location": "De locatie van de scene",
      "time": "Tijdstip (DAG/NACHT/AVOND/etc) indien vermeld",
      "characters": ["KARAKTER1", "KARAKTER2"],
      "summary": "Korte samenvatting van wat er gebeurt in deze scene (1-2 zinnen)",
      "dialogues": [
        {"character": "KARAKTER1", "text": "De gesproken tekst"},
        {"character": "KARAKTER2", "text": "Reactie"}
      ]
    }
  ],
  "characters": ["Lijst van ALLE unieke karakternamen in hoofdletters"],
  "locations": ["Lijst van alle unieke locaties"],
  "summary": "Korte samenvatting van het hele script (2-3 zinnen)",
  "format": "Het gedetecteerde script format (bijv. 'GTST Nederlands TV', 'Hollywood', 'Fountain', etc)"
}

BELANGRIJK:
- Geef ALLEEN JSON terug, geen andere tekst
- Karakternamen altijd in HOOFDLETTERS
- Neem alle dialogen mee die je vindt
- Als je iets niet kunt bepalen, gebruik dan een lege array [] of lege string ""`;

        try {
            state.ui.isProcessing = true;
            state.ui.processingMessage = 'Script wordt geanalyseerd door AI...';
            render();
            
            const response = await callClaudeAPI(prompt);
            
            // Parse JSON from response
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('Geen geldige JSON response van AI');
            }
            
            const data = JSON.parse(jsonMatch[0]);
            
            // Build script object from AI analysis
            const script = {
                title: filename.replace(/\.(txt|fountain|fdx|pdf|docx)$/i, ''),
                filename: filename,
                uploadedAt: new Date().toISOString(),
                scenes: data.scenes || [],
                characters: data.characters || [],
                locations: data.locations || [],
                rawText: text,
                summary: data.summary || '',
                detectedFormat: data.format || 'Onbekend',
                analyzedByAI: true,
                stats: {
                    sceneCount: (data.scenes || []).length,
                    characterCount: (data.characters || []).length,
                    locationCount: (data.locations || []).length,
                    dialogueCount: (data.scenes || []).reduce((sum, s) => sum + (s.dialogues?.length || 0), 0),
                    wordCount: text.split(/\s+/).length
                }
            };
            
            console.log('AI Analysis complete:', script.stats);
            return script;
            
        } catch (error) {
            console.error('AI analysis failed, falling back to regex parsing:', error);
            // Fallback to regex parsing if AI fails
            return parseScript(text, filename);
        } finally {
            state.ui.isProcessing = false;
            state.ui.processingMessage = '';
            render();
        }
    }

    // ============================================
    // STORYFRAME GENERATION
    // ============================================

    const genres = {
        drama: { 
            name: 'Psychologisch Drama', 
            color: '#3b82f6',
            principles: 'Focus op interne conflicten, morele dilemma\'s, langzame onthullingen van geheimen, complexe karakterpsychologie en emotionele confrontaties.',
            references: ['Big Little Lies', 'The Affair', 'In Treatment', 'Mare of Easttown', 'Normal People'],
            tips: 'Laat karakters hun eigen grootste vijand zijn. Subtext is belangrijker dan dialoog.'
        },
        ya: { 
            name: 'Young Adult', 
            color: '#ec4899',
            principles: 'Coming-of-age thema\'s, identiteitsvorming, eerste ervaringen (liefde, verlies, verraad), sociale dynamiek en groepsdruk.',
            references: ['Euphoria', 'Skins', 'Skam', 'Sex Education', 'Elite'],
            tips: 'Authenticiteit is alles. Vermijd moraliseren. Laat jongeren zelf hun fouten maken en ervan leren.'
        },
        romcom: { 
            name: 'Romantic Comedy', 
            color: '#f43f5e',
            principles: 'Will-they-won\'t-they dynamiek, miscommunicatie, grappige obstakels, groeicurve naar kwetsbaarheid en commitment.',
            references: ['You\'re the Worst', 'Crazy Ex-Girlfriend', 'Fleabag', 'Love', 'The Mindy Project'],
            tips: 'De beste romcoms hebben twee karakters die allebei fout zitten. Timing is alles - bijna-kusjes zijn spannender dan echte kusjes.'
        },
        thriller: { 
            name: 'Suspense/Thriller', 
            color: '#ef4444',
            principles: 'Escalerende spanning, ticking clock elementen, morele degradatie, cat-and-mouse dynamiek, verrassende wendingen.',
            references: ['Breaking Bad', 'The Fall', 'Mindhunter', 'Ozark', 'Broadchurch'],
            tips: 'Geef de kijker meer informatie dan de karakters (dramatic irony). Laat spanning komen uit wat NIET gezegd wordt.'
        },
        family: { 
            name: 'Family Drama', 
            color: '#22c55e',
            principles: 'Generatieconflicten, erfeniskwesties, familiegeheimen, loyaliteit versus eigenheid, de kracht en pijn van bloedverwanten.',
            references: ['Succession', 'This Is Us', 'Parenthood', 'Six Feet Under', 'Transparent'],
            tips: 'Elke familiebijeenkomst is een slagveld met onzichtbare wapens. De diepste wonden komen van degenen die het dichtst bij ons staan.'
        },
        social: { 
            name: 'Social Realism', 
            color: '#8b5cf6',
            principles: 'Maatschappelijke thema\'s, klassenverschillen, systemisch onrecht, alledaagse heroek, authentieke representatie.',
            references: ['The Wire', 'Shameless', 'I May Destroy You', 'When They See Us', 'Top Boy'],
            tips: 'Vermijd "poverty porn". Geef karakters agency. Laat zien hoe systemen mensen benvloeden zonder karakters te reduceren tot slachtoffers.'
        }
    };

    const actStructure = [
        { 
            act: 1, 
            name: 'Exposition', 
            description: 'Setup, karakters introduceren, status quo',
            detail: 'Introduceer de wereld, de belangrijkste karakters en hun normale leven. Hint naar het conflict dat komt. Eindig met de "inciting incident" die alles in beweging zet.',
            percentage: 20
        },
        { 
            act: 2, 
            name: 'Rising Action', 
            description: 'Conflict escaleert, stakes verhogen',
            detail: 'Het conflict wordt duidelijk en groeit. Karakters proberen het probleem op te lossen maar maken het vaak erger. Introduceer subplots. De stakes worden persoonlijker.',
            percentage: 25
        },
        { 
            act: 3, 
            name: 'Mid-Act Climax', 
            description: 'Keerpunt, grote onthulling of confrontatie',
            detail: 'Het "point of no return". Een grote onthulling, verraad of confrontatie verandert alles. Karakters kunnen niet meer terug naar hoe het was.',
            percentage: 15
        },
        { 
            act: 4, 
            name: 'Falling Action', 
            description: 'Gevolgen, dieper conflict, karaktergroei',
            detail: 'De gevolgen van de mid-act climax. Karakters worden gedwongen te veranderen of te falen. Het "darkest moment" waar alles verloren lijkt.',
            percentage: 25
        },
        { 
            act: 5, 
            name: 'Resolution', 
            description: 'Climax en afronding',
            detail: 'De finale confrontatie. Karakters gebruiken wat ze geleerd hebben. Niet alles hoeft perfect af te lopen - bittersweet is vaak sterker.',
            percentage: 15
        }
    ];

    function getActForWeek(weekNum, totalWeeks) {
        // Bereken dynamisch welke act bij welke week hoort op basis van percentages
        const week1Based = weekNum; // 1-indexed
        const progress = (week1Based / totalWeeks) * 100;
        
        let cumulative = 0;
        for (const act of actStructure) {
            cumulative += act.percentage;
            if (progress <= cumulative) {
                return act;
            }
        }
        return actStructure[actStructure.length - 1];
    }
    
    function getWeekRangeForAct(actNum, totalWeeks) {
        // Bereken welke weken bij een act horen
        let startPercent = 0;
        for (let i = 0; i < actNum - 1; i++) {
            startPercent += actStructure[i].percentage;
        }
        const endPercent = startPercent + actStructure[actNum - 1].percentage;
        
        const startWeek = Math.ceil((startPercent / 100) * totalWeeks) || 1;
        const endWeek = Math.ceil((endPercent / 100) * totalWeeks);
        
        return { start: startWeek, end: endWeek };
    }

    async function generateStoryframe() {
        if (!state.settings.apiKey || !state.storyframe.longLine) {
            alert('Vul eerst je API key in (Settings) en een lange lijn.');
            return;
        }

        state.ui.isProcessing = true;
        render();

        const genreInfo = genres[state.storyframe.genre];
        const totalWeeks = state.storyframe.totalWeeks;
        
        // Bereken week ranges per act
        const actWeekRanges = actStructure.map((act, i) => {
            const range = getWeekRangeForAct(i + 1, totalWeeks);
            return `- Week ${range.start}${range.end > range.start ? '-' + range.end : ''}: Act ${act.act} (${act.name}) - ${act.detail}`;
        }).join('\n');
        
        const prompt = `Je bent een ervaren TV-schrijver en creative producer, gespecialiseerd in ${genreInfo.name}. 
Je taak is om een lange lijn om te zetten naar een gestructureerd storyframe dat schrijvers kunnen gebruiken als inspiratiebron VOORDAT ze de synopsis bedenken.

BELANGRIJK: Antwoord VOLLEDIG in het NEDERLANDS.
${getMasterPromptText()}

=== LANGE LIJN ===
${state.storyframe.longLine}

=== GENRE: ${genreInfo.name.toUpperCase()} ===
**Principes van dit genre:**
${genreInfo.principles}

**Referentie series/films voor dit genre:**
${genreInfo.references.join(', ')}

**Tip voor dit genre:**
${genreInfo.tips}

=== DRAMATISCHE STRUCTUUR (5 ACTES) ===
Verdeel dit verhaal in ${totalWeeks} weken volgens de 5-acten structuur:
${actWeekRanges}

=== INSTRUCTIES ===
Denk als een ervaren ${genreInfo.name} schrijver. Pas de principes van het genre toe. 
Verwijs waar mogelijk naar technieken uit de referentie-series.

Per week geef IN HET NEDERLANDS:
1. **Samenvatting** (2-3 zinnen over wat er gebeurt)
2. **Key beats** (3-4 concrete verhaalbeats/scenes)
3. **Emotionele lading** (welk gevoel moet de kijker hebben aan het eind van deze week)
4. **Genre-element** (welk specifiek ${genreInfo.name} principe pas je hier toe)

=== OUTPUT FORMAT ===
Antwoord in JSON formaat, ALLES IN HET NEDERLANDS:
{
  "weeks": [
    {
      "number": 1,
      "act": 1,
      "actName": "Exposition",
      "summary": "Samenvatting van week 1...",
      "beats": ["Beat 1", "Beat 2", "Beat 3"],
      "emotion": "De emotie die de kijker voelt...",
      "genreElement": "Welk ${genreInfo.name} principe je toepast..."
    }
  ],
  "overallNotes": "Algemene dramaturgische tips voor dit specifieke verhaal..."
}`;

        try {
            const response = await callClaudeAPI(prompt);
            
            // Parse JSON from response
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const data = JSON.parse(jsonMatch[0]);
                state.storyframe.weeks = data.weeks;
                state.storyframe.notes = data.overallNotes || '';
                saveState();
            }
        } catch (error) {
            console.error('Error generating storyframe:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.ui.isProcessing = false;
        render();
    }

    // ============================================
    // AI CHAT
    // ============================================

    async function callClaudeAPI(prompt) {
        const response = await fetch(state.settings.proxyUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': state.settings.apiKey
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4096,
                messages: [{ role: 'user', content: prompt }]
            })
        });

        if (!response.ok) {
            const error = await response.text();
            throw new Error(`API Error ${response.status}: ${error}`);
        }

        const data = await response.json();
        return data.content[0].text;
    }

    async function sendChatMessage(message) {
        if (!message.trim() || !state.settings.apiKey) {
            if (!state.settings.apiKey) {
                alert('Vul eerst je API key in via Settings.');
            }
            return;
        }

        state.chat.messages.push({ role: 'user', content: message });
        state.chat.isLoading = true;
        render();

        // Build comprehensive context from ALL app data
        let context = 'Je bent een AI schrijfassistent voor ScriptMaster Pro. Je helpt scenarioschrijvers met hun werk.\n\n';
        
        // Include ALL script content for analysis
        if (state.scripts.length > 0) {
            context += '=== GEPLOADE SCRIPTS ===\n\n';
            state.scripts.forEach(script => {
                context += `### SCRIPT: "${script.title}" ###\n`;
                context += `Aantal scenes: ${script.stats?.sceneCount || 0}\n`;
                context += `Aantal karakters: ${script.stats?.characterCount || 0}\n`;
                
                if (script.characters && script.characters.length > 0) {
                    context += `Karakters: ${script.characters.join(', ')}\n`;
                }
                if (script.locations && script.locations.length > 0) {
                    context += `Locaties: ${script.locations.join(', ')}\n`;
                }
                context += '\n';
                
                // Include FULL scene content (more than before)
                if (script.scenes && script.scenes.length > 0) {
                    script.scenes.slice(0, 30).forEach((scene, idx) => {
                        context += `--- SCENE ${idx + 1}: ${scene.header || 'Geen header'} ---\n`;
                        
                        // Include full scene content
                        if (scene.content && scene.content.length > 0) {
                            const sceneText = scene.content.slice(0, 50).join('\n');
                            context += sceneText + '\n';
                        }
                        context += '\n';
                    });
                    
                    if (script.scenes.length > 30) {
                        context += `... en nog ${script.scenes.length - 30} scenes meer.\n`;
                    }
                }
                
                // Include scene summaries if available
                if (script.sceneSummaries && script.sceneSummaries.length > 0) {
                    context += '\n### SCENE SAMENVATTINGEN ###\n';
                    script.sceneSummaries.forEach((sum, idx) => {
                        context += `Scene ${idx + 1}: ${sum.summary}\n`;
                    });
                }
                
                context += '\n---\n\n';
            });
        }
        
        // Include character data with ruiten
        if (state.characters && state.characters.length > 0) {
            context += '=== KARAKTER DETAILS ===\n';
            state.characters.forEach(char => {
                context += `\n**${char.name}**: ${char.dialogueCount || 0} dialogen, ${char.scenes?.length || 0} scenes\n`;
                if (char.ruit) {
                    if (char.ruit.kernbehoefte) context += `  Kernbehoefte: ${char.ruit.kernbehoefte}\n`;
                    if (char.ruit.masker) context += `  Masker: ${char.ruit.masker}\n`;
                    if (char.ruit.kracht && char.ruit.kracht.length) context += `  Kracht: ${char.ruit.kracht.join(', ')}\n`;
                    if (char.ruit.valkuilen && char.ruit.valkuilen.length) context += `  Valkuilen: ${char.ruit.valkuilen.join(', ')}\n`;
                    if (char.ruit.donkereKant && char.ruit.donkereKant.length) context += `  Donkere kant: ${char.ruit.donkereKant.join(', ')}\n`;
                }
            });
            context += '\n';
        }
        
        // Include storyframe
        if (state.storyframe.longLine) {
            context += `=== LANGE LIJN ===\n${state.storyframe.longLine}\n\n`;
        }
        
        if (state.storyframe.weeks && state.storyframe.weeks.length > 0) {
            context += '=== STORYFRAME WEKEN ===\n';
            state.storyframe.weeks.forEach(week => {
                context += `Week ${week.number}: ${week.summary}\n`;
            });
            context += '\n';
        }

        const prompt = context + '=== VRAAG VAN DE SCHRIJVER ===\n' + message + '\n\nGeef een behulpzaam antwoord gebaseerd op bovenstaande script data.';

        try {
            const response = await callClaudeAPI(prompt);
            state.chat.messages.push({ role: 'assistant', content: response });
        } catch (error) {
            console.error('Chat error:', error);
            state.chat.messages.push({ 
                role: 'assistant', 
                content: `Fout: ${error.message}. Check je API key in Settings.` 
            });
        }

        state.chat.isLoading = false;
        render();
    }

    // ============================================
    // CONTINUITY CHECK
    // ============================================

    function checkContinuity() {
        const issues = {
            plot: [],
            characters: [],
            locations: [],
            props: [],
            time: [],
            dialogue: []
        };

        // 1. CHARACTER NAME INCONSISTENCIES
        const charVariations = new Map();
        state.characters.forEach(char => {
            const base = char.name.split(' ')[0].toUpperCase();
            if (!charVariations.has(base)) {
                charVariations.set(base, []);
            }
            charVariations.get(base).push(char.name);
        });

        charVariations.forEach((variations, base) => {
            if (variations.length > 1) {
                issues.characters.push({
                    type: 'warning',
                    message: `Mogelijke naamvariaties: ${variations.join(', ')}`,
                    suggestion: 'Check of dit dezelfde persoon is of verschillende karakters.'
                });
            }
        });

        // 2. LOCATION INCONSISTENCIES
        const locVariations = new Map();
        state.locations.forEach(loc => {
            const simplified = loc.name.replace(/[^a-zA-Z]/g, '').toUpperCase();
            if (!locVariations.has(simplified)) {
                locVariations.set(simplified, []);
            }
            locVariations.get(simplified).push(loc.name);
        });

        locVariations.forEach((variations, base) => {
            if (variations.length > 1) {
                issues.locations.push({
                    type: 'warning',
                    message: `Mogelijke locatievariaties: ${variations.join(', ')}`,
                    suggestion: 'Gebruik consistente locatienamen (INT./EXT., spelling).'
                });
            }
        });

        // 3. TIME CONTINUITY - Check for DAG/NACHT inconsistenties binnen scenes
        state.scripts.forEach(script => {
            let lastTimeOfDay = null;
            let lastScene = null;
            
            script.scenes?.forEach((scene, idx) => {
                const header = scene.header?.toUpperCase() || '';
                let currentTime = null;
                
                if (header.includes('- DAG') || header.includes('- OCHTEND') || header.includes('- MIDDAG')) {
                    currentTime = 'DAG';
                } else if (header.includes('- NACHT') || header.includes('- AVOND') || header.includes('- SCHEMERING')) {
                    currentTime = 'NACHT';
                }
                
                // Check for rapid time jumps without transition
                if (lastTimeOfDay && currentTime && lastTimeOfDay !== currentTime) {
                    // Check if scenes are sequential and at same location
                    const lastLoc = lastScene?.header?.split('-')[1]?.trim();
                    const currLoc = header.split('-')[1]?.trim();
                    
                    if (lastLoc && currLoc && lastLoc === currLoc) {
                        issues.time.push({
                            type: 'warning',
                            message: `Tijdsprong op zelfde locatie: Scene ${idx} en ${idx+1} in "${script.title}"`,
                            suggestion: `Van ${lastTimeOfDay} naar ${currentTime} op dezelfde locatie. Check of dit intentioneel is.`
                        });
                    }
                }
                
                lastTimeOfDay = currentTime;
                lastScene = scene;
            });
        });

        // 4. PROPS CONTINUITY - Look for mentioned objects in dialogue
        const propsPerCharacter = new Map();
        state.scripts.forEach(script => {
            script.scenes?.forEach(scene => {
                const content = scene.content?.join(' ') || '';
                
                // Simple prop detection (items in parentheticals or mentioned objects)
                const propMatches = content.match(/\((.*?)\)/g) || [];
                propMatches.forEach(match => {
                    const prop = match.toLowerCase();
                    if (prop.includes('pakt') || prop.includes('geeft') || prop.includes('houdt') || 
                        prop.includes('legt') || prop.includes('neemt') || prop.includes('zet')) {
                        // Extract what's being interacted with
                        const charMatch = content.match(/^([A-Z]{2,})/);
                        if (charMatch) {
                            const char = charMatch[1];
                            if (!propsPerCharacter.has(char)) {
                                propsPerCharacter.set(char, []);
                            }
                            propsPerCharacter.get(char).push({
                                action: match,
                                scene: scene.header
                            });
                        }
                    }
                });
            });
        });

        // 5. DIALOGUE REPETITION CHECK
        const dialogueLines = new Map();
        state.scripts.forEach(script => {
            script.scenes?.forEach(scene => {
                scene.content?.forEach(line => {
                    const trimmed = line.trim();
                    if (trimmed.length > 20 && !trimmed.match(/^[A-Z\s]+$/) && !trimmed.startsWith('(')) {
                        const normalized = trimmed.toLowerCase().replace(/[^a-z\s]/g, '');
                        if (normalized.length > 15) {
                            if (!dialogueLines.has(normalized)) {
                                dialogueLines.set(normalized, []);
                            }
                            dialogueLines.get(normalized).push({
                                original: trimmed.substring(0, 50),
                                scene: scene.header,
                                script: script.title
                            });
                        }
                    }
                });
            });
        });

        dialogueLines.forEach((occurrences, line) => {
            if (occurrences.length > 1) {
                issues.dialogue.push({
                    type: 'info',
                    message: `Herhaalde dialoog: "${occurrences[0].original}..."`,
                    suggestion: `Komt ${occurrences.length}x voor. Check of dit intentioneel is (catchphrase) of duplicaat.`
                });
            }
        });

        // 6. CHARACTER APPEARANCE CHECK - Characters appearing without introduction
        const characterFirstAppearance = new Map();
        state.scripts.forEach(script => {
            script.scenes?.forEach((scene, sceneIdx) => {
                scene.content?.forEach(line => {
                    const charMatch = line.trim().match(/^([A-Z]{2,}[A-Z\s]*?)(?:\s*\(|$)/);
                    if (charMatch) {
                        const char = charMatch[1].trim();
                        if (char.length > 1 && char.length < 30 && !char.includes('INT') && !char.includes('EXT')) {
                            if (!characterFirstAppearance.has(char)) {
                                characterFirstAppearance.set(char, {
                                    scene: sceneIdx + 1,
                                    header: scene.header,
                                    script: script.title
                                });
                            }
                        }
                    }
                });
            });
        });

        // 7. PLOT HOLE CHECK - Characters in multiple locations same scene
        // This would need AI analysis for deeper checks

        // ============================================
        // 8. WARDROBE MENTIONS - Track costume changes
        // ============================================
        const wardrobeKeywords = ['jas', 'coat', 'jurk', 'dress', 'pak', 'suit', 'shirt', 'hemd', 
                                   'trui', 'sweater', 'schoenen', 'shoes', 'uniform', 'kleding'];
        const wardrobeMentions = [];
        
        state.scripts.forEach(script => {
            script.scenes?.forEach((scene, sceneIdx) => {
                scene.content?.forEach(line => {
                    const lower = line.toLowerCase();
                    wardrobeKeywords.forEach(keyword => {
                        if (lower.includes(keyword)) {
                            wardrobeMentions.push({
                                scene: sceneIdx + 1,
                                header: scene.header,
                                mention: line.trim().substring(0, 60),
                                script: script.title
                            });
                        }
                    });
                });
            });
        });

        if (wardrobeMentions.length > 0) {
            if (!issues.wardrobe) issues.wardrobe = [];
            issues.wardrobe.push({
                type: 'info',
                message: `${wardrobeMentions.length} kleding/wardrobe vermeldingen gevonden`,
                suggestion: `Controleer consistentie van kleding tussen scenes. Eerste: "${wardrobeMentions[0]?.mention?.substring(0, 40) || ''}..."`
            });
        }

        // ============================================
        // 9. FOOD/DRINK CONTINUITY - Most common continuity errors!
        // ============================================
        const foodDrinkKeywords = ['koffie', 'coffee', 'wijn', 'wine', 'bier', 'beer', 'glas', 'glass', 
                                    'bord', 'plate', 'eten', 'food', 'drinkt', 'drinks', 'eet', 'eats'];
        let foodMentions = 0;
        
        state.scripts.forEach(script => {
            script.scenes?.forEach(scene => {
                scene.content?.forEach(line => {
                    const lower = line.toLowerCase();
                    foodDrinkKeywords.forEach(keyword => {
                        if (lower.includes(keyword)) foodMentions++;
                    });
                });
            });
        });

        if (foodMentions > 2) {
            issues.props.push({
                type: 'warning',
                message: `${foodMentions} eten/drinken vermeldingen - MEEST VOORKOMENDE FOUT!`,
                suggestion: 'Bij opname: let op vulhoogte glazen, positie borden, hoeveelheid eten tussen takes.'
            });
        }

        // ============================================
        // 10. PHONE/TECH CONTINUITY
        // ============================================
        const techKeywords = ['telefoon', 'phone', 'mobiel', 'laptop', 'computer', 'tablet', 'scherm', 'screen'];
        let techMentions = 0;
        
        state.scripts.forEach(script => {
            script.scenes?.forEach(scene => {
                scene.content?.forEach(line => {
                    const lower = line.toLowerCase();
                    techKeywords.forEach(keyword => {
                        if (lower.includes(keyword)) techMentions++;
                    });
                });
            });
        });

        if (techMentions > 3) {
            issues.props.push({
                type: 'info',
                message: `${techMentions} technologie/telefoon vermeldingen`,
                suggestion: 'Let op: schermen moeten consistent zijn (aan/uit, inhoud, positie).'
            });
        }

        // ============================================
        // 11. WEATHER/LIGHTING CONTINUITY
        // ============================================
        const weatherKeywords = ['regen', 'rain', 'zon', 'sun', 'sneeuw', 'snow', 'bewolkt', 'cloudy', 
                                  'onweer', 'storm', 'wind', 'mist', 'nat', 'wet'];
        const weatherMentions = [];
        
        state.scripts.forEach(script => {
            script.scenes?.forEach((scene, idx) => {
                const content = scene.content?.join(' ').toLowerCase() || '';
                weatherKeywords.forEach(keyword => {
                    if (content.includes(keyword)) {
                        weatherMentions.push({
                            scene: idx + 1,
                            header: scene.header,
                            weather: keyword
                        });
                    }
                });
            });
        });

        if (weatherMentions.length > 0) {
            const weathers = [...new Set(weatherMentions.map(w => w.weather))];
            issues.locations.push({
                type: 'info',
                message: `Weer vermeldingen: ${weathers.join(', ')}`,
                suggestion: 'Controleer weerconsistentie tussen opeenvolgende buitenscnes.'
            });
        }

        // ============================================
        // 12. ENTERING/EXITING CHECK
        // ============================================
        if (!issues.action) issues.action = [];
        state.scripts.forEach(script => {
            script.scenes?.forEach((scene, sceneIdx) => {
                const content = scene.content?.join(' ').toLowerCase() || '';
                
                const exitWords = ['gaat weg', 'vertrekt', 'exits', 'loopt weg', 'verdwijnt'];
                exitWords.forEach(word => {
                    const exitIndex = content.indexOf(word);
                    if (exitIndex > -1 && exitIndex < content.length - 100) {
                        issues.action.push({
                            type: 'warning',
                            message: `Karakter vertrekt middenin scene ${sceneIdx + 1}`,
                            suggestion: `Check of vertrokken karakter niet meer spreekt in "${scene.header}".`
                        });
                    }
                });
            });
        });

        // ============================================
        // 13. EYELINE CHECK
        // ============================================
        if (!issues.eyelines) issues.eyelines = [];
        const eyelineWords = ['kijkt naar', 'looks at', 'staart naar', 'ziet', 'blikt naar'];
        let totalEyelines = 0;
        state.scripts.forEach(script => {
            script.scenes?.forEach(scene => {
                scene.content?.forEach(line => {
                    const lower = line.toLowerCase();
                    eyelineWords.forEach(word => {
                        if (lower.includes(word)) totalEyelines++;
                    });
                });
            });
        });
        
        if (totalEyelines > 5) {
            issues.eyelines.push({
                type: 'info',
                message: `${totalEyelines} eyeline/blik aanwijzingen gevonden`,
                suggestion: 'Controleer bij opname dat eyelines consistent zijn tussen takes (180 regel).'
            });
        }

        return issues;
    }

    // AI-powered deep continuity analysis
    async function generateAIContinuityReport() {
        if (!state.settings.apiKey) {
            alert('Voer eerst een API key in bij instellingen');
            return;
        }

        if (state.scripts.length === 0) {
            alert('Upload eerst scripts om te analyseren');
            return;
        }

        state.ui.generatingContinuity = true;
        render();

        try {
            // Build context from all scripts
            const scriptsContext = state.scripts.map(script => {
                const sceneSummary = script.scenes?.slice(0, 30).map((scene, i) => 
                    `Scene ${i+1}: ${scene.header}\n${scene.content?.slice(0, 10).join('\n')}`
                ).join('\n\n');
                return `=== ${script.title} ===\n${sceneSummary}`;
            }).join('\n\n---\n\n');

            const prompt = `Je bent een professionele script supervisor die continuteitsfouten opspoort. Analyseer de volgende scripts op continuteitsproblemen.

${scriptsContext}

Zoek naar de volgende categorien problemen:

1. **PLOT CONTINUTEIT**: Tegenstrijdige informatie, plot holes, karakters die dingen weten die ze niet kunnen weten
2. **KARAKTER CONTINUTEIT**: Inconsistent gedrag, karakters op twee plekken tegelijk, onverklaarde afwezigheden
3. **LOCATIE CONTINUTEIT**: Onmogelijke verplaatsingen, locaties die niet kloppen
4. **PROPS CONTINUTEIT**: Items die verschijnen/verdwijnen, inconsistente objecten
5. **TIJD CONTINUTEIT**: Dag/nacht fouten, onlogische tijdsprongen
6. **DIALOOG CONTINUTEIT**: Herhalingen, tegenstrijdige uitspraken

Geef je analyse in het volgende JSON formaat:
{
    "issues": [
        {
            "category": "plot|character|location|props|time|dialogue",
            "severity": "error|warning|info",
            "scene": "Scene nummer of header",
            "description": "Wat is het probleem",
            "suggestion": "Hoe op te lossen"
        }
    ],
    "summary": "Korte samenvatting van de algehele continuteitsstatus"
}

Wees specifiek en noem concrete scenes en voorbeelden. Als alles goed is, geef dan een lege issues array.`;

            const response = await fetch(state.settings.proxyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.settings.apiKey
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 4096,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            const data = await response.json();
            const text = data.content[0].text;

            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                state.ui.continuityReport = JSON.parse(jsonMatch[0]);
                saveState();
            }

        } catch (error) {
            console.error('Error generating continuity report:', error);
            alert('Fout bij genereren rapport: ' + error.message);
        }

        state.ui.generatingContinuity = false;
        render();
    }

    // ============================================
    // MASTER WISDOM
    // ============================================

    const masterWisdom = {
        structure: [
            { writer: 'Robert McKee', wisdom: 'Story is about change. Each scene must turn the situation in a new direction.' },
            { writer: 'Syd Field', wisdom: 'Plot Point 1 should happen around page 25-27. It spins the story in a new direction.' },
            { writer: 'Blake Snyder', wisdom: 'Your "Save the Cat" moment must happen in the first 10 minutes - make us like the hero.' },
            { writer: 'Christopher Nolan', wisdom: 'Non-linear structure works when each timeline has its own momentum and stakes.' }
        ],
        character: [
            { writer: 'Aaron Sorkin', wisdom: 'Characters are defined by what they DO, not what they say about themselves.' },
            { writer: 'Phoebe Waller-Bridge', wisdom: 'Give characters contradictions. The most interesting people are at war with themselves.' },
            { writer: 'Quentin Tarantino', wisdom: 'A character introduction is a promise to the audience about who this person will be.' },
            { writer: 'Greta Gerwig', wisdom: 'Small moments reveal character more than grand gestures. Watch how they eat, walk, wait.' }
        ],
        dialogue: [
            { writer: 'David Mamet', wisdom: 'People rarely say what they mean. The truth is in what they\'re NOT saying.' },
            { writer: 'Diablo Cody', wisdom: 'Every character needs their own vocabulary. No two people speak exactly alike.' },
            { writer: 'Nora Ephron', wisdom: 'Dialogue should be composed like music - rhythm, pauses, tempo all matter.' },
            { writer: 'Armando Iannucci', wisdom: 'Comedy timing lives in the pauses. The silence after a line can be funnier than the line.' }
        ],
        theme: [
            { writer: 'Charlie Kaufman', wisdom: 'Your theme is a question, not an answer. Let the audience find their own meaning.' },
            { writer: 'Denis Villeneuve', wisdom: 'Every visual choice should reflect the internal state of your characters.' },
            { writer: 'Jordan Peele', wisdom: 'Genre is a vessel for saying something real. Horror can be the most honest form of social commentary.' },
            { writer: 'Bong Joon-ho', wisdom: 'Genre mixing works when you commit fully to each genre within its moments.' }
        ]
    };

    // ============================================
    // WRITING METHODS DATA
    // ============================================

    const writingMethods = {
        savethecat: {
            name: 'Save the Cat',
            author: 'Blake Snyder',
            beats: [
                { id: 1, name: 'Opening Image', page: '1', description: 'De eerste visuele van je film. Zet de toon en geeft een "voor" beeld van je held.' },
                { id: 2, name: 'Theme Stated', page: '5', description: 'Een secundair karakter spreekt het thema uit, vaak terloops.' },
                { id: 3, name: 'Set-up', page: '1-10', description: 'Toon de held\'s gewone wereld en de "Six Things That Need Fixing".' },
                { id: 4, name: 'Catalyst', page: '12', description: 'Het inciting incident dat alles verandert.' },
                { id: 5, name: 'Debate', page: '12-25', description: 'De held twijfelt. Moeten ze wel gaan?' },
                { id: 6, name: 'Break into Two', page: '25', description: 'De held maakt een actieve keuze. Act 2 begint.' },
                { id: 7, name: 'B Story', page: '30', description: 'Een subplot begint, vaak een liefdesverhaal.' },
                { id: 8, name: 'Fun and Games', page: '30-55', description: 'De "promise of the premise" - de fun stuff.' },
                { id: 9, name: 'Midpoint', page: '55', description: 'False victory of false defeat. Stakes worden verhoogd.' },
                { id: 10, name: 'Bad Guys Close In', page: '55-75', description: 'Externe druk neemt toe, alles begint te ontrafelen.' },
                { id: 11, name: 'All Is Lost', page: '75', description: 'Het laagste punt. Vaak een "whiff of death".' },
                { id: 12, name: 'Dark Night of the Soul', page: '75-85', description: 'De held in hopeloosheid, vindt dan kracht.' },
                { id: 13, name: 'Break into Three', page: '85', description: 'A en B verhaallijnen komen samen. Epifanie.' },
                { id: 14, name: 'Finale', page: '85-110', description: 'De held past geleerde lessen toe en wint.' },
                { id: 15, name: 'Final Image', page: '110', description: 'Tegenovergestelde van Opening Image. Transformatie compleet.' }
            ]
        },
        storycircle: {
            name: 'Story Circle',
            author: 'Dan Harmon',
            beats: [
                { id: 1, name: 'YOU', page: '1-10', description: 'Karakter in comfort zone, gewone wereld.' },
                { id: 2, name: 'NEED', page: '10-15', description: 'Ze willen of missen iets.' },
                { id: 3, name: 'GO', page: '15-30', description: 'Ze betreden een onbekende situatie.' },
                { id: 4, name: 'SEARCH', page: '30-50', description: 'Ze passen zich aan en zoeken.' },
                { id: 5, name: 'FIND', page: '50-60', description: 'Ze vinden wat ze zochten (false victory).' },
                { id: 6, name: 'TAKE', page: '60-75', description: 'Ze betalen een zware prijs.' },
                { id: 7, name: 'RETURN', page: '75-90', description: 'Ze keren terug naar hun wereld.' },
                { id: 8, name: 'CHANGE', page: '90-110', description: 'Ze zijn veranderd door de reis.' }
            ]
        },
        threeact: {
            name: '3-Act Structure',
            author: 'Syd Field',
            beats: [
                { id: 1, name: 'Act 1: Setup', page: '1-30', description: 'Introduceer held, wereld, en probleem.' },
                { id: 2, name: 'Inciting Incident', page: '10-15', description: 'Het moment dat alles in gang zet.' },
                { id: 3, name: 'Plot Point 1', page: '25-30', description: 'Keerpunt dat held Act 2 in dwingt.' },
                { id: 4, name: 'Act 2A: Confrontation', page: '30-55', description: 'Held reageert op obstakels.' },
                { id: 5, name: 'Midpoint', page: '55-60', description: 'Grote shift, held wordt proactief.' },
                { id: 6, name: 'Act 2B: Complications', page: '60-85', description: 'Stakes hoger, alles gaat mis.' },
                { id: 7, name: 'Plot Point 2', page: '85-90', description: 'Laagste punt, dan doorbraak.' },
                { id: 8, name: 'Act 3: Resolution', page: '90-120', description: 'Climax en afronding.' }
            ]
        },
        herosjourney: {
            name: 'Hero\'s Journey',
            author: 'Joseph Campbell',
            beats: [
                { id: 1, name: 'Ordinary World', page: '1-10', description: 'De held in hun dagelijks leven.' },
                { id: 2, name: 'Call to Adventure', page: '10-15', description: 'Een uitdaging presenteert zich.' },
                { id: 3, name: 'Refusal of the Call', page: '15-20', description: 'De held aarzelt.' },
                { id: 4, name: 'Meeting the Mentor', page: '20-25', description: 'Een wijze figuur helpt.' },
                { id: 5, name: 'Crossing Threshold', page: '25-30', description: 'De held betreedt de speciale wereld.' },
                { id: 6, name: 'Tests, Allies, Enemies', page: '30-55', description: 'De held wordt getest.' },
                { id: 7, name: 'Approach to Cave', page: '55-65', description: 'Naderen van grootste uitdaging.' },
                { id: 8, name: 'Ordeal', page: '65-75', description: 'Confrontatie met grootste angst.' },
                { id: 9, name: 'Reward', page: '75-80', description: 'De held verkrijgt wat ze zochten.' },
                { id: 10, name: 'The Road Back', page: '80-90', description: 'Begin van de terugkeer.' },
                { id: 11, name: 'Resurrection', page: '90-105', description: 'De ultieme test.' },
                { id: 12, name: 'Return with Elixir', page: '105-120', description: 'Terugkeer, getransformeerd.' }
            ]
        }
    };

    // ============================================
    // 100 MASTER WRITERS DATABASE
    // ============================================

    const masterWriters = [
        // STRUCTURE (1-10)
        { id: 1, name: 'Robert McKee', category: 'structure', works: 'Story (boek)', technique: 'Scene als story event', tip: 'Elke scene moet de waarde van het leven veranderen.' },
        { id: 2, name: 'Syd Field', category: 'structure', works: 'Screenplay', technique: '3-Act Paradigm', tip: 'Structure is the spine of the story.' },
        { id: 3, name: 'Blake Snyder', category: 'structure', works: 'Save the Cat', technique: '15 Beat Sheet', tip: 'Give me the same thing, only different.' },
        { id: 4, name: 'Christopher Nolan', category: 'structure', works: 'Memento, Inception', technique: 'Non-lineaire structuur', tip: 'Play with time to create meaning.' },
        { id: 5, name: 'Quentin Tarantino', category: 'structure', works: 'Pulp Fiction, Kill Bill', technique: 'Chaptered, non-lineair', tip: 'Start in the middle of action.' },
        { id: 6, name: 'Charlie Kaufman', category: 'structure', works: 'Eternal Sunshine', technique: 'Meta-structuur', tip: 'Structure should reflect the theme.' },
        { id: 7, name: 'Christopher McQuarrie', category: 'structure', works: 'Usual Suspects', technique: 'Twist endings', tip: 'Plant seeds early, harvest late.' },
        { id: 8, name: 'David Fincher', category: 'structure', works: 'Fight Club, Gone Girl', technique: 'Unreliable narrator', tip: 'Make the audience complicit.' },
        { id: 9, name: 'Denis Villeneuve', category: 'structure', works: 'Arrival, Blade Runner 2049', technique: 'Slow burn revelation', tip: 'Patience in storytelling pays off.' },
        { id: 10, name: 'Guillermo del Toro', category: 'structure', works: 'Pan\'s Labyrinth', technique: 'Parallelle verhaallijnen', tip: 'Fairy tale structure for adult themes.' },
        
        // CHARACTER (11-25)
        { id: 11, name: 'Aaron Sorkin', category: 'character', works: 'Social Network, West Wing', technique: 'Walk-and-talk', tip: 'Characters are what they DO.' },
        { id: 12, name: 'Phoebe Waller-Bridge', category: 'character', works: 'Fleabag, Killing Eve', technique: 'Breaking fourth wall', tip: 'Give characters contradictions.' },
        { id: 13, name: 'Greta Gerwig', category: 'character', works: 'Lady Bird, Little Women', technique: 'Small moments', tip: 'The specific is universal.' },
        { id: 14, name: 'Jordan Peele', category: 'character', works: 'Get Out, Us', technique: 'Subverted expectations', tip: 'Genre as social commentary.' },
        { id: 15, name: 'Bong Joon-ho', category: 'character', works: 'Parasite', technique: 'Class dynamics', tip: 'Environment shapes character.' },
        { id: 16, name: 'Taika Waititi', category: 'character', works: 'Jojo Rabbit', technique: 'Comedy + tragedy', tip: 'Find the funny in the dark.' },
        { id: 17, name: 'Emerald Fennell', category: 'character', works: 'Promising Young Woman', technique: 'Revenge with purpose', tip: 'Subvert the victim narrative.' },
        { id: 18, name: 'Barry Jenkins', category: 'character', works: 'Moonlight', technique: 'Intimate study', tip: 'Silence speaks volumes.' },
        { id: 19, name: 'Celine Sciamma', category: 'character', works: 'Portrait of a Lady on Fire', technique: 'The gaze', tip: 'Show don\'t tell - especially love.' },
        { id: 20, name: 'Sofia Coppola', category: 'character', works: 'Lost in Translation', technique: 'Mood over plot', tip: 'Atmosphere is character.' },
        { id: 21, name: 'Yorgos Lanthimos', category: 'character', works: 'The Favourite', technique: 'Absurdist drama', tip: 'Alienation as technique.' },
        { id: 22, name: 'Paul Thomas Anderson', category: 'character', works: 'There Will Be Blood', technique: 'Long takes', tip: 'Let scenes breathe.' },
        { id: 23, name: 'Darren Aronofsky', category: 'character', works: 'Black Swan', technique: 'Physical transformation', tip: 'The body shows inner turmoil.' },
        { id: 24, name: 'Mike Leigh', category: 'character', works: 'Secrets & Lies', technique: 'Improvised realism', tip: 'Character from rehearsal.' },
        { id: 25, name: 'Kenneth Lonergan', category: 'character', works: 'Manchester by the Sea', technique: 'Grief realism', tip: 'Not everyone gets healed.' },
        
        // DIALOGUE (26-40)
        { id: 26, name: 'David Mamet', category: 'dialogue', works: 'Glengarry Glen Ross', technique: 'Sparse, rhythmic', tip: 'People rarely say what they mean.' },
        { id: 27, name: 'Diablo Cody', category: 'dialogue', works: 'Juno', technique: 'Distinctive voice', tip: 'Every character needs their own vocabulary.' },
        { id: 28, name: 'Nora Ephron', category: 'dialogue', works: 'When Harry Met Sally', technique: 'Natural banter', tip: 'Dialogue as music.' },
        { id: 29, name: 'Armando Iannucci', category: 'dialogue', works: 'Veep, In the Loop', technique: 'Insult comedy', tip: 'Comedy timing lives in pauses.' },
        { id: 30, name: 'Joel & Ethan Coen', category: 'dialogue', works: 'Fargo, No Country', technique: 'Regional dialect', tip: 'Dialogue reveals geography and class.' },
        { id: 31, name: 'Woody Allen', category: 'dialogue', works: 'Annie Hall', technique: 'Neurotic, intellectual', tip: 'Let characters talk into corners.' },
        { id: 32, name: 'Richard Linklater', category: 'dialogue', works: 'Before Sunrise trilogy', technique: 'Philosophical conversation', tip: 'Real conversations meander.' },
        { id: 33, name: 'Amy Sherman-Palladino', category: 'dialogue', works: 'Gilmore Girls', technique: 'Rapid-fire', tip: 'Density creates character.' },
        { id: 34, name: 'Tony Gilroy', category: 'dialogue', works: 'Michael Clayton', technique: 'Corporate subtext', tip: 'What\'s NOT said matters most.' },
        { id: 35, name: 'Taylor Sheridan', category: 'dialogue', works: 'Sicario, Yellowstone', technique: 'Laconic, Western', tip: 'Fewer words, more weight.' },
        { id: 36, name: 'Eric Roth', category: 'dialogue', works: 'Forrest Gump', technique: 'Sweeping emotion', tip: 'Find the humanity in epic.' },
        { id: 37, name: 'Tony Kushner', category: 'dialogue', works: 'Lincoln', technique: 'Theatrical speeches', tip: 'Monologues can be cinema.' },
        { id: 38, name: 'Paddy Chayefsky', category: 'dialogue', works: 'Network', technique: 'Passionate rants', tip: 'Let characters explode.' },
        { id: 39, name: 'Billy Wilder', category: 'dialogue', works: 'Some Like It Hot', technique: 'Setup/payoff', tip: 'Act 3 problems? Fix Act 1.' },
        { id: 40, name: 'Preston Sturges', category: 'dialogue', works: 'Sullivan\'s Travels', technique: 'Screwball comedy', tip: 'Fast and furious.' },
        
        // TV MASTERS (41-55)
        { id: 41, name: 'Vince Gilligan', category: 'tv', works: 'Breaking Bad', technique: 'Slow burn transformation', tip: 'Mr. Chips to Scarface.' },
        { id: 42, name: 'David Chase', category: 'tv', works: 'The Sopranos', technique: 'Antihero complexity', tip: 'Sympathy for the devil.' },
        { id: 43, name: 'David Simon', category: 'tv', works: 'The Wire', technique: 'Systemic storytelling', tip: 'Institutions as characters.' },
        { id: 44, name: 'Shonda Rhimes', category: 'tv', works: 'Grey\'s Anatomy', technique: 'Cliffhangers', tip: 'End every act with a question.' },
        { id: 45, name: 'Dan Harmon', category: 'tv', works: 'Community, Rick and Morty', technique: 'Story Circle', tip: 'The embryo of story.' },
        { id: 46, name: 'Damon Lindelof', category: 'tv', works: 'Lost, The Leftovers', technique: 'Mystery boxes', tip: 'Questions beat answers.' },
        { id: 47, name: 'Jesse Armstrong', category: 'tv', works: 'Succession', technique: 'Dark comedy', tip: 'Make them awful but watchable.' },
        { id: 48, name: 'Mike White', category: 'tv', works: 'The White Lotus', technique: 'Social satire', tip: 'Privilege exposed.' },
        { id: 49, name: 'Noah Hawley', category: 'tv', works: 'Fargo (TV)', technique: 'Tonal shifts', tip: 'Genre-bending within episodes.' },
        { id: 50, name: 'Craig Mazin', category: 'tv', works: 'Chernobyl, Last of Us', technique: 'Research + emotion', tip: 'Truth is dramatic enough.' },
        { id: 51, name: 'Lisa Joy & Jonathan Nolan', category: 'tv', works: 'Westworld', technique: 'Puzzle box', tip: 'Reward careful viewers.' },
        { id: 52, name: 'Ryan Murphy', category: 'tv', works: 'American Horror Story', technique: 'Anthology', tip: 'Reinvent each season.' },
        { id: 53, name: 'Michaela Coel', category: 'tv', works: 'I May Destroy You', technique: 'Personal trauma as art', tip: 'Authenticity above comfort.' },
        { id: 54, name: 'Sally Wainwright', category: 'tv', works: 'Happy Valley', technique: 'Strong female leads', tip: 'Women can be complex.' },
        { id: 55, name: 'Jed Mercurio', category: 'tv', works: 'Line of Duty', technique: 'Procedural tension', tip: 'Make bureaucracy thrilling.' },
        
        // COMEDY (56-65)
        { id: 56, name: 'Mel Brooks', category: 'comedy', works: 'Blazing Saddles', technique: 'Parody', tip: 'Tragedy + time = comedy.' },
        { id: 57, name: 'Judd Apatow', category: 'comedy', works: '40-Year-Old Virgin', technique: 'Improv-friendly', tip: 'Let actors find the funny.' },
        { id: 58, name: 'Tina Fey', category: 'comedy', works: '30 Rock, Mean Girls', technique: 'Joke density', tip: 'More jokes per page.' },
        { id: 59, name: 'Edgar Wright', category: 'comedy', works: 'Shaun of the Dead', technique: 'Visual comedy', tip: 'Every frame is setup or payoff.' },
        { id: 60, name: 'Lord & Miller', category: 'comedy', works: 'LEGO Movie', technique: 'Meta-comedy', tip: 'Acknowledge the absurdity.' },
        { id: 61, name: 'Mike Judge', category: 'comedy', works: 'Office Space', technique: 'Workplace absurdity', tip: 'Mundane horror is comedy.' },
        { id: 62, name: 'Seth Rogen', category: 'comedy', works: 'Superbad', technique: 'Friendship comedy', tip: 'Authentic friendship.' },
        { id: 63, name: 'Bo Burnham', category: 'comedy', works: 'Eighth Grade', technique: 'Cringe + heart', tip: 'Awkwardness is universal.' },
        { id: 64, name: 'Charlie Day', category: 'comedy', works: 'Always Sunny', technique: 'Unlikeable protagonists', tip: 'Make them awful, make them funny.' },
        { id: 65, name: 'Nick Kroll', category: 'comedy', works: 'Big Mouth', technique: 'Animated honesty', tip: 'Animation allows more truth.' },
        
        // HORROR (66-75)
        { id: 66, name: 'Ari Aster', category: 'horror', works: 'Hereditary, Midsommar', technique: 'Dread, grief-horror', tip: 'Family trauma is the real monster.' },
        { id: 67, name: 'Mike Flanagan', category: 'horror', works: 'Haunting of Hill House', technique: 'Character-driven horror', tip: 'Ghosts are metaphors.' },
        { id: 68, name: 'Robert Eggers', category: 'horror', works: 'The Witch', technique: 'Period authenticity', tip: 'Research creates atmosphere.' },
        { id: 69, name: 'James Wan', category: 'horror', works: 'Conjuring', technique: 'Set-piece horror', tip: 'Build to the scare.' },
        { id: 70, name: 'Leigh Whannell', category: 'horror', works: 'Invisible Man', technique: 'High concept', tip: 'One idea, fully explored.' },
        { id: 71, name: 'John Carpenter', category: 'horror', works: 'Halloween', technique: 'Minimalist suspense', tip: 'Less is more scary.' },
        { id: 72, name: 'Wes Craven', category: 'horror', works: 'Scream', technique: 'Meta-horror', tip: 'Know the rules to break them.' },
        { id: 73, name: 'David Cronenberg', category: 'horror', works: 'The Fly', technique: 'Body horror', tip: 'The flesh is the canvas.' },
        { id: 74, name: 'Ti West', category: 'horror', works: 'X, Pearl', technique: 'Retro horror', tip: 'Genre pastiche with depth.' },
        { id: 75, name: 'Jennifer Kent', category: 'horror', works: 'The Babadook', technique: 'Psychological horror', tip: 'The monster is grief.' },
        
        // SCI-FI (76-85)
        { id: 76, name: 'George Lucas', category: 'scifi', works: 'Star Wars', technique: 'Mythology in space', tip: 'Campbell in a galaxy far away.' },
        { id: 77, name: 'Peter Jackson', category: 'scifi', works: 'LOTR', technique: 'Adaptation, scale', tip: 'Respect source, serve the film.' },
        { id: 78, name: 'The Wachowskis', category: 'scifi', works: 'The Matrix', technique: 'Philosophical action', tip: 'Ideas can be visualized.' },
        { id: 79, name: 'Alex Garland', category: 'scifi', works: 'Ex Machina', technique: 'Cerebral sci-fi', tip: 'Sci-fi as philosophy.' },
        { id: 80, name: 'Ted Chiang', category: 'scifi', works: 'Arrival', technique: 'Linguistic sci-fi', tip: 'Language shapes reality.' },
        { id: 81, name: 'James Cameron', category: 'scifi', works: 'Terminator, Aliens', technique: 'Stakes + spectacle', tip: 'Technology serves emotion.' },
        { id: 82, name: 'Ridley Scott', category: 'scifi', works: 'Blade Runner', technique: 'World-building detail', tip: 'Every corner tells a story.' },
        { id: 83, name: 'Hayao Miyazaki', category: 'scifi', works: 'Spirited Away', technique: 'Environmental fantasy', tip: 'Nature as character.' },
        { id: 84, name: 'Terry Gilliam', category: 'scifi', works: 'Brazil', technique: 'Dystopian satire', tip: 'Bureaucracy is the enemy.' },
        { id: 85, name: 'Neill Blomkamp', category: 'scifi', works: 'District 9', technique: 'Allegory sci-fi', tip: 'Sci-fi as social mirror.' },
        
        // INTERNATIONAL (86-100)
        { id: 86, name: 'Akira Kurosawa', category: 'international', works: 'Seven Samurai, Rashomon', technique: 'Multiple perspectives', tip: 'Truth is subjective.' },
        { id: 87, name: 'Ingmar Bergman', category: 'international', works: 'Persona', technique: 'Existential dialogue', tip: 'Face the void.' },
        { id: 88, name: 'Federico Fellini', category: 'international', works: '8', technique: 'Dream logic', tip: 'Reality is overrated.' },
        { id: 89, name: 'Franois Truffaut', category: 'international', works: '400 Blows', technique: 'Autobiographical', tip: 'Write what you know, deeply.' },
        { id: 90, name: 'Andrei Tarkovsky', category: 'international', works: 'Stalker', technique: 'Poetic imagery', tip: 'Time is the medium.' },
        { id: 91, name: 'Park Chan-wook', category: 'international', works: 'Oldboy', technique: 'Revenge aesthetics', tip: 'Vengeance as opera.' },
        { id: 92, name: 'Asghar Farhadi', category: 'international', works: 'A Separation', technique: 'Moral complexity', tip: 'No villains, only perspectives.' },
        { id: 93, name: 'Alfonso Cuarn', category: 'international', works: 'Roma', technique: 'Long takes', tip: 'The camera is a character.' },
        { id: 94, name: 'Alejandro G. Irritu', category: 'international', works: 'Birdman', technique: 'Interconnected stories', tip: 'Everything is connected.' },
        { id: 95, name: 'Wong Kar-wai', category: 'international', works: 'In the Mood for Love', technique: 'Yearning', tip: 'What could have been.' },
        { id: 96, name: 'Pedro Almodvar', category: 'international', works: 'Talk to Her', technique: 'Elevated melodrama', tip: 'Embrace big emotions.' },
        { id: 97, name: 'Hirokazu Kore-eda', category: 'international', works: 'Shoplifters', technique: 'Quiet family drama', tip: 'Found family, chosen bonds.' },
        { id: 98, name: 'Lee Chang-dong', category: 'international', works: 'Burning', technique: 'Ambiguity', tip: 'Let audiences complete the story.' },
        { id: 99, name: 'Paolo Sorrentino', category: 'international', works: 'The Great Beauty', technique: 'Decadence and meaning', tip: 'Beauty masks emptiness.' },
        { id: 100, name: 'Florian von Donnersmarck', category: 'international', works: 'Lives of Others', technique: 'Surveillance drama', tip: 'The watcher becomes watched.' }
    ];

    const masterCategories = {
        all: 'Alle Meesters',
        structure: 'Structuur & Plot',
        character: 'Karakter & Arc',
        dialogue: 'Dialoog',
        tv: 'TV Series',
        comedy: 'Comedy',
        horror: 'Horror & Thriller',
        scifi: 'Sci-Fi & Fantasy',
        international: 'Internationale Meesters'
    };

    // ============================================
    // WRITER ASSISTANT FUNCTIONS
    // ============================================

    function getCurrentMethodBeats() {
        return writingMethods[state.writer.method]?.beats || [];
    }

    function getBeatContent(beatId) {
        const key = `${state.writer.method}_${beatId}`;
        return state.writer.beats[key] || '';
    }

    function setBeatContent(beatId, content) {
        const key = `${state.writer.method}_${beatId}`;
        state.writer.beats[key] = content;
        saveState();
    }

    async function generateBeatSuggestions(beat) {
        if (!state.settings.apiKey) {
            alert('Vul eerst je API key in via Settings.');
            return;
        }

        state.writer.isGenerating = true;
        state.writer.suggestions = [];
        render();

        const method = writingMethods[state.writer.method];
        const previousBeats = getCurrentMethodBeats()
            .filter(b => b.id < beat.id)
            .map(b => `${b.name}: ${getBeatContent(b.id) || '(nog leeg)'}`)
            .join('\n');

        const prompt = `Je bent een expert scenarioschrijver. Help met de ${method.name} methode.

BELANGRIJK: Antwoord VOLLEDIG in het Nederlands.
${getMasterPromptText()}
CONTEXT:
- Genre: ${state.writer.genre}
- Logline: ${state.writer.logline || '(nog niet ingevuld)'}
- Vorige beats: ${previousBeats || '(eerste beat)'}

HUIDIGE BEAT: ${beat.name} (pagina ${beat.page})
Beschrijving: ${beat.description}

Geef 3 suggesties in het Nederlands in JSON:
{
  "suggestions": [
    {"type": "conventional", "title": "Nederlandse titel", "description": "2-3 zinnen in het Nederlands", "reasoning": "Waarom het werkt"},
    {"type": "surprising", "title": "Nederlandse titel", "description": "2-3 zinnen in het Nederlands", "reasoning": "Waarom het werkt"},
    {"type": "bold", "title": "Nederlandse titel", "description": "2-3 zinnen in het Nederlands", "reasoning": "Waarom het werkt"}
  ]
}`;

        try {
            const response = await callClaudeAPI(prompt);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const data = JSON.parse(jsonMatch[0]);
                state.writer.suggestions = data.suggestions || [];
            }
        } catch (error) {
            console.error('Error generating suggestions:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.writer.isGenerating = false;
        render();
    }

    function selectSuggestion(suggestion) {
        const beats = getCurrentMethodBeats();
        const currentBeat = beats[state.writer.currentBeat];
        if (currentBeat) {
            setBeatContent(currentBeat.id, `${suggestion.title}\n\n${suggestion.description}`);
            state.writer.suggestions = [];
            render();
        }
    }

    function getRandomMasterTip() {
        return masterWriters[Math.floor(Math.random() * masterWriters.length)];
    }

    function getFilteredMasters() {
        if (state.writer.masterFilter === 'all') return masterWriters;
        return masterWriters.filter(m => m.category === state.writer.masterFilter);
    }

    // Helper functie voor meester dropdown HTML
    function renderMasterDropdown() {
        const selected = state.writer.selectedMaster ? 
            masterWriters.find(m => m.id === state.writer.selectedMaster) : null;
        
        return `
            <div class="form-group">
                <label class="form-label"> Schrijf in de stijl van</label>
                <select class="form-input" onchange="state.writer.selectedMaster = this.value ? parseInt(this.value) : null; render()">
                    <option value="">-- Geen meester (standaard) --</option>
                    <optgroup label="Structuur & Plot">
                        ${masterWriters.filter(m => m.category === 'structure').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Karakter & Arc">
                        ${masterWriters.filter(m => m.category === 'character').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Dialoog">
                        ${masterWriters.filter(m => m.category === 'dialogue').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="TV Series">
                        ${masterWriters.filter(m => m.category === 'tv').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Comedy">
                        ${masterWriters.filter(m => m.category === 'comedy').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Horror & Thriller">
                        ${masterWriters.filter(m => m.category === 'horror').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Sci-Fi & Fantasy">
                        ${masterWriters.filter(m => m.category === 'scifi').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Internationale Meesters">
                        ${masterWriters.filter(m => m.category === 'international').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                </select>
                ${selected ? `
                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: 6px; font-size: 0.85rem;">
                        <strong> ${selected.technique}</strong><br>
                        <em>"${selected.tip}"</em><br>
                        <span style="color: var(--text-muted);">Bekend van: ${selected.works}</span>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Helper functie voor meester prompt tekst
    function getMasterPromptText() {
        if (!state.writer.selectedMaster) return '';
        
        const master = masterWriters.find(m => m.id === state.writer.selectedMaster);
        if (!master) return '';
        
        return `

SCHRIJFSTIJL - SCHRIJF ALS ${master.name.toUpperCase()}:
Je schrijft nu in de stijl van ${master.name}, bekend van: ${master.works}.
Kerntechniek: ${master.technique}
Filosofie: "${master.tip}"

Pas deze stijl en technieken toe in je output. Denk en schrijf zoals ${master.name} zou doen.
`;
    }

    // ============================================
    // SCENE BUILDER FUNCTIONS
    // ============================================

    function toggleSceneCharacter(charName) {
        const index = state.writer.scene.characters.findIndex(
            c => c.toUpperCase() === charName.toUpperCase()
        );
        
        if (index >= 0) {
            // Remove character
            state.writer.scene.characters.splice(index, 1);
        } else {
            // Add character
            state.writer.scene.characters.push(charName);
        }
        render();
    }

    async function generateScene() {
        if (!state.settings.apiKey) {
            alert('Vul eerst je API key in via Settings.');
            return;
        }

        const s = state.writer.scene;
        if (!s.location || !s.objective) {
            alert('Vul minimaal locatie en doel in.');
            return;
        }

        state.writer.isGenerating = true;
        render();

        // Build ruit context for characters in scene
        const ruitContext = buildRuitContext(s.characters);

        const prompt = `Je bent een ervaren scenarioschrijver. Genereer een complete scene in professioneel screenplay format.

BELANGRIJK: Schrijf de VOLLEDIGE scene in het NEDERLANDS. Alle dialoog en action lines moeten in het Nederlands zijn.
${getMasterPromptText()}
SCENE DETAILS:
- Locatie: ${s.intExt}. ${s.location} - ${s.timeOfDay}
- Karakters: ${s.characters.join(', ') || 'Nog te bepalen'}
- Doel van de scene: ${s.objective}
- Conflict: ${s.conflict || 'Subtiel conflict'}
- Toon: ${s.tone}
- Genre: ${state.writer.genre}
- Logline van het script: ${state.writer.logline || '(niet ingevuld)'}
${ruitContext ? `
=== KARAKTER RUITEN ===
Gebruik onderstaande karakter-informatie om authentieke dialoog en gedrag te schrijven:
${ruitContext}

INSTRUCTIES VOOR KARAKTER RUITEN:
- Het MASKER bepaalt HOE het karakter communiceert (toon, woordkeuze)
- Laat minimaal 1 VALKUIL subtiel naar voren komen in gedrag
- Gebruik de KRACHT van het karakter
- De ANGST benvloedt onderbewust het gedrag
- Pas minimaal 1 GEDRAGSPATROON toe
- Houd de GROEI-ARC in gedachten voor de karakterontwikkeling
` : ''}
INSTRUCTIES:
1. Begin met de scene heading (INT./EXT. LOCATIE - TIJD)
2. Schrijf action lines in tegenwoordige tijd IN HET NEDERLANDS
3. Karakter namen in HOOFDLETTERS bij eerste introductie
4. Dialoog met karakter naam gecentreerd, tekst eronder - IN HET NEDERLANDS
5. Gebruik parentheticals spaarzaam
6. Scene moet 1-2 pagina's zijn (ongeveer 1 pagina = 1 minuut screen time)
7. Eindig met een duidelijk einde of cliffhanger

Schrijf de volledige scene in professioneel screenplay format, VOLLEDIG IN HET NEDERLANDS:`;

        try {
            const response = await callClaudeAPI(prompt);
            state.writer.scene.generatedScene = response;
        } catch (error) {
            console.error('Error generating scene:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.writer.isGenerating = false;
        render();
    }

    // ============================================
    // DIALOGUE GENERATOR FUNCTIONS
    // ============================================

    async function generateDialogueOptions() {
        if (!state.settings.apiKey) {
            alert('Vul eerst je API key in via Settings.');
            return;
        }

        const d = state.writer.dialogue;
        if (!d.speaker || !d.objective) {
            alert('Vul minimaal spreker en doel in.');
            return;
        }

        state.writer.isGenerating = true;
        state.writer.dialogue.options = [];
        render();

        // Build ruit context for speaker (and listener if known)
        const characters = [d.speaker];
        if (d.listener) characters.push(d.listener);
        const ruitContext = buildRuitContext(characters);

        const prompt = `Je bent een dialoog-expert. Genereer 3 verschillende versies van hetzelfde dialoogfragment.

BELANGRIJK: Schrijf ALLE dialoog in het NEDERLANDS.
${getMasterPromptText()}
CONTEXT:
- Wie spreekt: ${d.speaker}
- Tegen wie: ${d.listener || 'onbekend'}
- Wat wil ${d.speaker} bereiken: ${d.objective}
- Subtext/wat wordt NIET gezegd: ${d.subtext || 'geen specifieke subtext'}
- Toon: ${d.tone}
- Genre: ${state.writer.genre}
${ruitContext ? `
=== KARAKTER RUITEN ===
${ruitContext}
Pas de ruit-informatie toe: gebruik het masker voor de communicatiestijl, laat valkuilen doorschemeren, en zorg dat angsten subtiel het gedrag benvloeden.
` : ''}
Geef 3 versies in JSON format, met NEDERLANDSE dialoog:
{
  "options": [
    {
      "style": "Subtiel",
      "description": "Korte beschrijving van de aanpak in het Nederlands",
      "dialogue": "De daadwerkelijke NEDERLANDSE dialoog (2-4 regels)"
    },
    {
      "style": "Direct",
      "description": "Korte beschrijving van de aanpak in het Nederlands",
      "dialogue": "De daadwerkelijke NEDERLANDSE dialoog (2-4 regels)"
    },
    {
      "style": "Gedurfd",
      "description": "Korte beschrijving van de aanpak in het Nederlands",
      "dialogue": "De daadwerkelijke NEDERLANDSE dialoog (2-4 regels)"
    }
  ]
}`;

        try {
            const response = await callClaudeAPI(prompt);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const data = JSON.parse(jsonMatch[0]);
                state.writer.dialogue.options = data.options || [];
            }
        } catch (error) {
            console.error('Error generating dialogue:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.writer.isGenerating = false;
        render();
    }

    // ============================================
    // CONFLICT ESCALATOR FUNCTIONS
    // ============================================

    async function generateConflictEscalations() {
        if (!state.settings.apiKey) {
            alert('Vul eerst je API key in via Settings.');
            return;
        }

        const baseConflict = state.writer.conflict.baseConflict;
        if (!baseConflict) {
            alert('Beschrijf eerst het basisconflict.');
            return;
        }

        state.writer.isGenerating = true;
        state.writer.conflict.escalations = [];
        render();

        const prompt = `Je bent een expert in dramatische spanning. Neem dit basisconflict en escaleer het in 5 niveaus van mild naar explosief.

BELANGRIJK: Antwoord VOLLEDIG in het NEDERLANDS.
${getMasterPromptText()}
BASISCONFLICT:
${baseConflict}

GENRE: ${state.writer.genre}
LOGLINE: ${state.writer.logline || '(niet ingevuld)'}

Geef 5 escalatieniveaus in JSON, ALLES IN HET NEDERLANDS:
{
  "escalations": [
    {
      "level": 1,
      "name": "Onderhuidse Spanning",
      "description": "Hoe het conflict subtiel begint (Nederlands)",
      "example": "Concrete scne-beschrijving in het Nederlands"
    },
    {
      "level": 2,
      "name": "Eerste Confrontatie",
      "description": "De eerste openlijke botsing (Nederlands)",
      "example": "Concrete scne-beschrijving in het Nederlands"
    },
    {
      "level": 3,
      "name": "Escalatie",
      "description": "Stakes worden verhoogd (Nederlands)",
      "example": "Concrete scne-beschrijving in het Nederlands"
    },
    {
      "level": 4,
      "name": "Point of No Return",
      "description": "Geen weg terug (Nederlands)",
      "example": "Concrete scne-beschrijving in het Nederlands"
    },
    {
      "level": 5,
      "name": "Explosie",
      "description": "Maximale confrontatie (Nederlands)",
      "example": "Concrete scne-beschrijving in het Nederlands"
    }
  ]
}`;

        try {
            const response = await callClaudeAPI(prompt);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const data = JSON.parse(jsonMatch[0]);
                state.writer.conflict.escalations = data.escalations || [];
            }
        } catch (error) {
            console.error('Error generating escalations:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.writer.isGenerating = false;
        render();
    }

    // ============================================
    // PLOT TWIST GENERATOR FUNCTIONS
    // ============================================

    const twistCategories = {
        all: 'Alle Twists',
        character: 'Karakter Onthulling',
        perspective: 'Perspectief Shift',
        time: 'Tijd Twist',
        relationship: 'Relatie Twist',
        reality: 'Realiteit Twist'
    };

    async function generatePlotTwists() {
        if (!state.settings.apiKey) {
            alert('Vul eerst je API key in via Settings.');
            return;
        }

        state.writer.isGenerating = true;
        state.writer.twist.twists = [];
        render();

        const category = state.writer.twist.category;
        const categoryText = category === 'all' ? 'verschillende categorien' : twistCategories[category];

        const prompt = `Je bent een meester in plot twists. Genereer 5 originele plot twists.

BELANGRIJK: Antwoord VOLLEDIG in het NEDERLANDS.
${getMasterPromptText()}
CONTEXT:
- Genre: ${state.writer.genre}
- Logline: ${state.writer.logline || '(nog niet ingevuld)'}
- Extra context: ${state.writer.twist.context || '(geen)'}
- Categorie: ${categoryText}

TWIST CATEGORIEN:
- character: Karakter onthulling (hij was de moordenaar, zij is zijn zus)
- perspective: Perspectief shift (unreliable narrator, we zagen het verkeerd)
- time: Tijd twist (we zijn in de toekomst, flashback onthulling)
- relationship: Relatie twist (ze zijn familie, geheime romance)
- reality: Realiteit twist (het was een droom, simulatie, hallucinatie)

Geef 5 twists in JSON, ALLES IN HET NEDERLANDS:
{
  "twists": [
    {
      "category": "character/perspective/time/relationship/reality",
      "title": "Korte Nederlandse titel",
      "setup": "Wat moet er eerst opgezet worden (Nederlands)",
      "reveal": "De twist zelf (Nederlands)",
      "impact": "Waarom dit werkt (Nederlands)",
      "example": "Bekende film/serie die dit deed"
    }
  ]
}`;

        try {
            const response = await callClaudeAPI(prompt);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const data = JSON.parse(jsonMatch[0]);
                let twists = data.twists || [];
                if (category !== 'all') {
                    twists = twists.filter(t => t.category === category);
                }
                state.writer.twist.twists = twists;
            }
        } catch (error) {
            console.error('Error generating twists:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.writer.isGenerating = false;
        render();
    }

    // ============================================
    // EXPORT FUNCTIONS
    // ============================================

    function exportBeatsToText() {
        const method = writingMethods[state.writer.method];
        const beats = getCurrentMethodBeats();
        
        let text = `${method.name} - ${method.author}\n`;
        text += `Genre: ${state.writer.genre}\n`;
        text += `Logline: ${state.writer.logline || '(niet ingevuld)'}\n`;
        text += `${'='.repeat(50)}\n\n`;

        beats.forEach(beat => {
            const content = getBeatContent(beat.id);
            text += `BEAT ${beat.id}: ${beat.name} (p.${beat.page})\n`;
            text += `${'-'.repeat(40)}\n`;
            text += `${content || '(nog niet ingevuld)'}\n\n`;
        });

        downloadFile(text, `beats-${state.writer.method}-${Date.now()}.txt`, 'text/plain');
    }

    function exportBeatsToJSON() {
        const method = writingMethods[state.writer.method];
        const beats = getCurrentMethodBeats();
        
        const data = {
            method: method.name,
            author: method.author,
            genre: state.writer.genre,
            logline: state.writer.logline,
            exportedAt: new Date().toISOString(),
            beats: beats.map(beat => ({
                id: beat.id,
                name: beat.name,
                page: beat.page,
                description: beat.description,
                content: getBeatContent(beat.id) || ''
            }))
        };

        downloadFile(JSON.stringify(data, null, 2), `beats-${state.writer.method}-${Date.now()}.json`, 'application/json');
    }

    function exportSceneToFountain() {
        const scene = state.writer.scene.generatedScene;
        if (!scene) {
            alert('Genereer eerst een scene.');
            return;
        }
        downloadFile(scene, `scene-${Date.now()}.fountain`, 'text/plain');
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function copyToClipboard(text, buttonElement) {
        navigator.clipboard.writeText(text).then(() => {
            if (buttonElement) {
                const originalText = buttonElement.innerText;
                buttonElement.innerText = ' Gekopieerd!';
                buttonElement.classList.add('copied');
                setTimeout(() => {
                    buttonElement.innerText = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            }
        });
    }

    // ============================================
    // MASTER DETAIL MODAL
    // ============================================

    // ============================================
    // KARAKTER RUIT EDITOR
    // ============================================

    function openRuitEditor(charKey) {
        state.ui.showRuitEditor = charKey;
        render();
    }

    function closeRuitEditor() {
        state.ui.showRuitEditor = null;
        render();
    }

    function handleRuitPhotoUpload(event, charKey) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const char = state.characters.find(c => c.name.toUpperCase() === charKey);
            if (char) {
                char.ruit.foto = e.target.result;
                saveCharacterRuit(charKey, char.ruit);
            }
        };
        reader.readAsDataURL(file);
    }

    function updateRuitField(charKey, field, value) {
        const char = state.characters.find(c => c.name.toUpperCase() === charKey);
        if (char) {
            char.ruit[field] = value;
            saveCharacterRuit(charKey, char.ruit);
        }
    }

    function addRuitArrayItem(charKey, field, value) {
        if (!value.trim()) return;
        const char = state.characters.find(c => c.name.toUpperCase() === charKey);
        if (char) {
            if (!char.ruit[field]) char.ruit[field] = [];
            char.ruit[field].push(value.trim());
            saveCharacterRuit(charKey, char.ruit);
        }
    }

    function removeRuitArrayItem(charKey, field, index) {
        const char = state.characters.find(c => c.name.toUpperCase() === charKey);
        if (char && char.ruit[field]) {
            char.ruit[field].splice(index, 1);
            saveCharacterRuit(charKey, char.ruit);
        }
    }

    function renderRuitEditorModal() {
        if (!state.ui.showRuitEditor) return '';

        const charKey = state.ui.showRuitEditor;
        const char = state.characters.find(c => c.name.toUpperCase() === charKey);
        if (!char) return '';

        const ruit = char.ruit || {};
        const ruitViewMode = state.ui.ruitViewMode || 'edit'; // 'edit', 'visual', 'import'

        return `
            <div class="modal-overlay" onclick="closeRuitEditor()">
                <div class="modal ruit-editor-modal" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3><i data-lucide="diamond" style="color: var(--accent);"></i> Karakter Ruit: ${escapeHtml(char.name)}</h3>
                        <button class="btn btn-ghost" onclick="closeRuitEditor()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: 0.25rem; padding: 0.5rem 1rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border);">
                        <button class="btn ${ruitViewMode === 'edit' ? 'btn-primary' : 'btn-secondary'}" 
                                style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                onclick="state.ui.ruitViewMode = 'edit'; render();">
                            <i data-lucide="edit-2" style="width: 14px; height: 14px;"></i> Bewerken
                        </button>
                        <button class="btn ${ruitViewMode === 'visual' ? 'btn-primary' : 'btn-secondary'}"
                                style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                onclick="state.ui.ruitViewMode = 'visual'; render();">
                            <i data-lucide="diamond" style="width: 14px; height: 14px;"></i> Visueel
                        </button>
                        <button class="btn ${ruitViewMode === 'import' ? 'btn-primary' : 'btn-secondary'}"
                                style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                onclick="state.ui.ruitViewMode = 'import'; render();">
                            <i data-lucide="upload" style="width: 14px; height: 14px;"></i> Importeren
                        </button>
                    </div>
                    
                    <div class="modal-body">
                        ${ruitViewMode === 'visual' ? renderRuitVisual(char, ruit, charKey) : ''}
                        ${ruitViewMode === 'import' ? renderRuitImport(charKey) : ''}
                        ${ruitViewMode === 'edit' ? renderRuitEditForm(char, ruit, charKey) : ''}
                    </div>
                    <div class="modal-footer">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            Wijzigingen worden automatisch opgeslagen
                        </div>
                        <button class="btn btn-primary" onclick="closeRuitEditor()">
                            <i data-lucide="check"></i>
                            Sluiten
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Render the visual diamond diagram
    function renderRuitVisual(char, ruit, charKey) {
        const hasData = hasRuitData(ruit);
        
        return `
            <div style="text-align: center; padding: 1rem;">
                ${ruit.foto ? `
                    <img src="${ruit.foto}" alt="${char.name}" 
                         style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 3px solid var(--accent);">
                ` : ''}
                <h2 style="color: var(--accent); margin-bottom: 0.25rem;">${escapeHtml(char.name)}</h2>
                ${ruit.kernbehoefteLabel ? `
                    <div style="font-size: 1.1rem; color: var(--text-primary); margin-bottom: 0.5rem;">
                        <strong>${escapeHtml(ruit.kernbehoefteLabel)}:</strong>
                    </div>
                ` : ''}
                ${ruit.kernbehoefte ? `
                    <div style="font-size: 1rem; font-style: italic; color: var(--text-secondary); margin-bottom: 1.5rem;">
                        "${escapeHtml(ruit.kernbehoefte)}"
                    </div>
                ` : ''}
                
                ${hasData ? `
                    <!-- SVG Diamond Diagram -->
                    <div style="position: relative; width: 100%; max-width: 500px; margin: 0 auto;">
                        <svg viewBox="0 0 400 450" style="width: 100%; height: auto;">
                            <!-- Diamond shape -->
                            <polygon points="200,30 370,200 200,370 30,200" 
                                     fill="none" stroke="var(--accent)" stroke-width="2" opacity="0.5"/>
                            <polygon points="200,60 340,200 200,340 60,200" 
                                     fill="rgba(245, 158, 11, 0.1)" stroke="var(--accent)" stroke-width="1"/>
                            
                            <!-- Center lines -->
                            <line x1="200" y1="60" x2="200" y2="340" stroke="var(--border)" stroke-width="1" stroke-dasharray="4"/>
                            <line x1="60" y1="200" x2="340" y2="200" stroke="var(--border)" stroke-width="1" stroke-dasharray="4"/>
                            
                            <!-- Masker - TOP -->
                            <text x="200" y="20" text-anchor="middle" fill="var(--accent)" font-size="12" font-weight="bold">MASKER</text>
                            <text x="200" y="50" text-anchor="middle" fill="var(--text-primary)" font-size="11">
                                ${escapeHtml((ruit.masker || 'Niet ingevuld').substring(0, 25))}
                            </text>
                            
                            <!-- Valkuilen - TOP LEFT -->
                            <text x="70" y="100" text-anchor="start" fill="#ef4444" font-size="10" font-weight="bold">Valkuilen:</text>
                            ${(ruit.valkuilen || []).slice(0, 4).map((v, i) => `
                                <text x="70" y="${115 + i * 14}" text-anchor="start" fill="var(--text-secondary)" font-size="9">
                                    ${escapeHtml(v.substring(0, 15))}
                                </text>
                            `).join('')}
                            
                            <!-- Kracht - LEFT MIDDLE -->
                            <text x="20" y="180" text-anchor="start" fill="#22c55e" font-size="10" font-weight="bold">Kracht:</text>
                            ${(ruit.kracht || []).slice(0, 4).map((k, i) => `
                                <text x="20" y="${195 + i * 14}" text-anchor="start" fill="var(--text-secondary)" font-size="9">
                                    ${escapeHtml(k.substring(0, 12))}
                                </text>
                            `).join('')}
                            
                            <!-- Donkere Kant - BOTTOM LEFT -->
                            <text x="70" y="290" text-anchor="start" fill="#8b5cf6" font-size="10" font-weight="bold">Donkere kant:</text>
                            ${(ruit.donkereKant || []).slice(0, 3).map((d, i) => `
                                <text x="70" y="${305 + i * 14}" text-anchor="start" fill="var(--text-secondary)" font-size="9">
                                    ${escapeHtml(d.substring(0, 15))}
                                </text>
                            `).join('')}
                            
                            <!-- Kernverhaal - TOP RIGHT -->
                            <text x="330" y="100" text-anchor="end" fill="var(--text-primary)" font-size="10" font-weight="bold">Kernverhaal:</text>
                            ${(ruit.kernverhaal || []).slice(0, 4).map((k, i) => `
                                <text x="330" y="${115 + i * 14}" text-anchor="end" fill="var(--text-secondary)" font-size="8">
                                    ${escapeHtml(k.substring(0, 25))}
                                </text>
                            `).join('')}
                            
                            <!-- Angsten - RIGHT MIDDLE -->
                            <text x="380" y="180" text-anchor="end" fill="#ec4899" font-size="10" font-weight="bold">Angsten:</text>
                            ${(ruit.angsten || []).slice(0, 3).map((a, i) => `
                                <text x="380" y="${195 + i * 14}" text-anchor="end" fill="var(--text-secondary)" font-size="9">
                                    ${escapeHtml(a.substring(0, 18))}
                                </text>
                            `).join('')}
                            
                            <!-- Gedragspatronen - BOTTOM RIGHT -->
                            <text x="330" y="270" text-anchor="end" fill="var(--text-secondary)" font-size="10" font-weight="bold">Gedrag:</text>
                            ${(ruit.gedragspatronen || []).slice(0, 3).map((g, i) => `
                                <text x="330" y="${285 + i * 14}" text-anchor="end" fill="var(--text-muted)" font-size="8">
                                    ${escapeHtml(g.substring(0, 30))}...
                                </text>
                            `).join('')}
                            
                            <!-- Moet Worden - BOTTOM -->
                            <text x="200" y="385" text-anchor="middle" fill="var(--accent)" font-size="12" font-weight="bold">MOET WORDEN</text>
                            <text x="200" y="405" text-anchor="middle" fill="var(--text-primary)" font-size="10">
                                ${escapeHtml((ruit.moetWorden || []).slice(0, 2).join(', ').substring(0, 35))}
                            </text>
                            
                            <!-- Center photo placeholder or icon -->
                            <circle cx="200" cy="200" r="35" fill="var(--bg-secondary)" stroke="var(--accent)" stroke-width="2"/>
                            ${ruit.foto ? `
                                <clipPath id="circleClip">
                                    <circle cx="200" cy="200" r="33"/>
                                </clipPath>
                                <image href="${ruit.foto}" x="167" y="167" width="66" height="66" clip-path="url(#circleClip)" preserveAspectRatio="xMidYMid slice"/>
                            ` : `
                                <text x="200" y="205" text-anchor="middle" fill="var(--accent)" font-size="24"></text>
                            `}
                        </svg>
                    </div>
                ` : `
                    <div style="padding: 3rem; color: var(--text-muted); text-align: center;">
                        <i data-lucide="diamond" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Vul eerst de ruit-velden in via het "Bewerken" tabblad om de visuele weergave te zien.</p>
                    </div>
                `}
            </div>
        `;
    }

    // Render the import form
    function renderRuitImport(charKey) {
        return `
            <div style="padding: 1rem;">
                <div style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent); border-radius: 8px; border-left: 3px solid var(--accent);">
                    <strong style="color: var(--accent);"> Snel importeren</strong>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                        Plak tekst met ruit-informatie hieronder. De tool herkent automatisch velden als:
                        Kernbehoefte, Masker, Valkuilen, Kracht, Donkere kant, Angsten, Gedragspatronen, Moet worden.
                    </p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Plak ruit-tekst hier:</label>
                    <textarea id="ruitImportText" class="form-input" style="min-height: 200px; font-family: monospace; font-size: 0.85rem;"
                              placeholder="Voorbeeld:
Kernbehoefte (Liefde): Ik wil nodig zijn
Masker: Ondoorgrondelijk
Valkuilen: Koppig, Dwingend, Overbezorgd
Kracht: Charmant, Vasthoudend, Betrouwbaar
Donkere kant: Obsessief, Wraakzuchtig
Angsten: Onnodig zijn, Geliefden verliezen
Gedragspatronen: Omarmt een kans of bedreiging om aan te trekken
Moet worden: Autonoom, Durven loslaten"></textarea>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="parseAndImportRuit('${charKey}')">
                        <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                        Importeer & Vul In
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('ruitImportText').value = ''">
                        <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                        Wissen
                    </button>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                    <strong style="font-size: 0.9rem;">Ondersteunde formaten:</strong>
                    <ul style="font-size: 0.8rem; color: var(--text-secondary); margin: 0.5rem 0 0 1rem; padding: 0;">
                        <li><code>Veld: waarde</code> of <code>Veld (label): waarde</code></li>
                        <li>Meerdere items gescheiden door komma's</li>
                        <li>Genummerde items: <code>1. item, 2. item</code></li>
                    </ul>
                </div>
            </div>
        `;
    }

    // Parse and import ruit text
    function parseAndImportRuit(charKey) {
        const textArea = document.getElementById('ruitImportText');
        if (!textArea) return;
        
        const text = textArea.value;
        if (!text.trim()) {
            alert('Plak eerst tekst om te importeren.');
            return;
        }
        
        const char = state.characters.find(c => c.name.toUpperCase() === charKey);
        if (!char) return;
        
        const ruit = char.ruit || {};
        const lines = text.split('\n');
        
        // Field mappings (variations of field names)
        const fieldMappings = {
            kernbehoefte: ['kernbehoefte', 'behoefte', 'drijfveer', 'need'],
            kernbehoefteLabel: [], // Will be extracted from parentheses
            masker: ['masker', 'mask', 'facade'],
            kernverhaal: ['kernverhaal', 'overtuigingen', 'beliefs', 'verhaal'],
            valkuilen: ['valkuilen', 'valkuil', 'pitfalls', 'zwaktes'],
            kracht: ['kracht', 'krachten', 'strengths', 'sterke'],
            donkereKant: ['donkere kant', 'donkerekant', 'dark side', 'schaduw'],
            angsten: ['angsten', 'angst', 'fears', 'bang'],
            gedragspatronen: ['gedragspatronen', 'gedrag', 'patronen', 'behavior'],
            moetWorden: ['moet worden', 'moetworden', 'groei', 'growth', 'arc']
        };
        
        lines.forEach(line => {
            const trimmed = line.trim();
            if (!trimmed || trimmed.startsWith('#')) return;
            
            // Try to match "Field: value" or "Field (label): value"
            const colonIndex = trimmed.indexOf(':');
            if (colonIndex === -1) return;
            
            let fieldPart = trimmed.substring(0, colonIndex).trim().toLowerCase();
            let valuePart = trimmed.substring(colonIndex + 1).trim();
            
            // Check for label in parentheses: "Kernbehoefte (Liefde)"
            const labelMatch = fieldPart.match(/^(.+?)\s*\((.+?)\)$/);
            if (labelMatch) {
                fieldPart = labelMatch[1].trim();
                // If it's kernbehoefte, save the label
                if (fieldPart.includes('behoefte') || fieldPart.includes('kernbehoefte')) {
                    ruit.kernbehoefteLabel = labelMatch[2].trim();
                }
            }
            
            // Find matching field
            for (const [ruitField, aliases] of Object.entries(fieldMappings)) {
                const allNames = [ruitField, ...aliases];
                if (allNames.some(name => fieldPart.includes(name.toLowerCase()))) {
                    // Parse value
                    if (['kernbehoefte', 'kernbehoefteLabel', 'masker'].includes(ruitField)) {
                        // Single value fields
                        ruit[ruitField] = valuePart.replace(/^["']|["']$/g, '');
                    } else {
                        // Array fields - split by comma or numbered items
                        let items = valuePart
                            .replace(/^\d+\.\s*/gm, '') // Remove numbering
                            .split(/[,;]/)
                            .map(item => item.trim())
                            .filter(item => item && item.length > 1);
                        
                        // If no commas found, try line breaks
                        if (items.length <= 1 && valuePart.includes('\n')) {
                            items = valuePart.split('\n').map(i => i.trim()).filter(i => i);
                        }
                        
                        if (items.length > 0) {
                            ruit[ruitField] = items;
                        }
                    }
                    break;
                }
            }
        });
        
        // Save the updated ruit
        saveCharacterRuit(charKey, ruit);
        
        // Switch to edit view to show results
        state.ui.ruitViewMode = 'edit';
        render();
        
        alert('Ruit gemporteerd! Check de velden en pas aan waar nodig.');
    }

    // Render the edit form (original form content)
    function renderRuitEditForm(char, ruit, charKey) {
        return `
            <!-- Header met foto en kernbehoefte -->
            <div style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem; align-items: flex-start;">
                <div>
                    <label class="form-label">Foto</label>
                    <div class="ruit-photo-upload" onclick="document.getElementById('ruitPhotoInput').click()">
                        ${ruit.foto ? 
                            `<img src="${ruit.foto}" alt="${char.name}">` : 
                            `<i data-lucide="camera" style="color: var(--text-muted);"></i>`
                        }
                    </div>
                    <input type="file" id="ruitPhotoInput" accept="image/*" style="display: none;" 
                           onchange="handleRuitPhotoUpload(event, '${charKey}')">
                    ${ruit.foto ? `
                        <button class="btn btn-ghost" style="margin-top: 0.5rem; font-size: 0.75rem;" 
                                onclick="updateRuitField('${charKey}', 'foto', ''); render();">
                            Verwijder foto
                        </button>
                    ` : ''}
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">Kernbehoefte Label (bijv. Liefde, Macht, Veiligheid)</label>
                        <input type="text" class="form-input" placeholder="bijv. Liefde"
                               value="${escapeHtml(ruit.kernbehoefteLabel || '')}"
                               onchange="updateRuitField('${charKey}', 'kernbehoefteLabel', this.value)">
                    </div>
                    <div>
                        <label class="form-label">Kernbehoefte (de drijfveer)</label>
                        <input type="text" class="form-input" placeholder="bijv. Ik wil nodig zijn"
                               value="${escapeHtml(ruit.kernbehoefte || '')}"
                               onchange="updateRuitField('${charKey}', 'kernbehoefte', this.value)">
                    </div>
                </div>
            </div>

            <!-- Masker -->
            <div class="ruit-section ruit-section-full" style="margin-bottom: 1rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent);">
                <div class="ruit-section-title">
                    <i data-lucide="mask" style="width: 16px; height: 16px;"></i>
                    Masker (hoe het karakter zich naar buiten presenteert)
                </div>
                <input type="text" class="form-input" placeholder="bijv. Ondoorgrondelijk, Stoer, Vriendelijk"
                       value="${escapeHtml(ruit.masker || '')}"
                       onchange="updateRuitField('${charKey}', 'masker', this.value)">
            </div>

            <!-- Grid met alle ruit onderdelen -->
            <div class="ruit-grid">
                <!-- Kernverhaal -->
                <div class="ruit-section">
                    <div class="ruit-section-title">
                        <i data-lucide="book-open" style="width: 16px; height: 16px;"></i>
                        Kernverhaal (overtuigingen)
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="kernverhaal-input-${charKey}" 
                               placeholder="Voeg overtuiging toe..."
                               onkeydown="if(event.key==='Enter'){addRuitArrayItem('${charKey}','kernverhaal',this.value);this.value='';}">
                        <button class="btn btn-secondary" onclick="addRuitArrayItem('${charKey}','kernverhaal',document.getElementById('kernverhaal-input-${charKey}').value);document.getElementById('kernverhaal-input-${charKey}').value='';">+</button>
                    </div>
                    <div class="ruit-tags">
                        ${(ruit.kernverhaal || []).map((item, i) => `
                            <span class="ruit-tag">${escapeHtml(item)} <span class="ruit-tag-remove" onclick="removeRuitArrayItem('${charKey}','kernverhaal',${i})"></span></span>
                        `).join('')}
                    </div>
                </div>

                <!-- Valkuilen -->
                <div class="ruit-section" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), transparent);">
                    <div class="ruit-section-title" style="color: var(--error);">
                        <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                        Valkuilen
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="valkuilen-input-${charKey}" 
                               placeholder="Voeg valkuil toe..."
                               onkeydown="if(event.key==='Enter'){addRuitArrayItem('${charKey}','valkuilen',this.value);this.value='';}">
                        <button class="btn btn-secondary" onclick="addRuitArrayItem('${charKey}','valkuilen',document.getElementById('valkuilen-input-${charKey}').value);document.getElementById('valkuilen-input-${charKey}').value='';">+</button>
                    </div>
                    <div class="ruit-tags">
                        ${(ruit.valkuilen || []).map((item, i) => `
                            <span class="ruit-tag" style="border-left: 2px solid var(--error);">${escapeHtml(item)} <span class="ruit-tag-remove" onclick="removeRuitArrayItem('${charKey}','valkuilen',${i})"></span></span>
                        `).join('')}
                    </div>
                </div>

                <!-- Kracht -->
                <div class="ruit-section" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), transparent);">
                    <div class="ruit-section-title" style="color: var(--success);">
                        <i data-lucide="zap" style="width: 16px; height: 16px;"></i>
                        Kracht
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="kracht-input-${charKey}" 
                               placeholder="Voeg kracht toe..."
                               onkeydown="if(event.key==='Enter'){addRuitArrayItem('${charKey}','kracht',this.value);this.value='';}">
                        <button class="btn btn-secondary" onclick="addRuitArrayItem('${charKey}','kracht',document.getElementById('kracht-input-${charKey}').value);document.getElementById('kracht-input-${charKey}').value='';">+</button>
                    </div>
                    <div class="ruit-tags">
                        ${(ruit.kracht || []).map((item, i) => `
                            <span class="ruit-tag" style="border-left: 2px solid var(--success);">${escapeHtml(item)} <span class="ruit-tag-remove" onclick="removeRuitArrayItem('${charKey}','kracht',${i})"></span></span>
                        `).join('')}
                    </div>
                </div>

                <!-- Donkere Kant -->
                <div class="ruit-section" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), transparent);">
                    <div class="ruit-section-title" style="color: #8b5cf6;">
                        <i data-lucide="moon" style="width: 16px; height: 16px;"></i>
                        Donkere Kant
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="donkerekant-input-${charKey}" 
                               placeholder="Voeg donkere kant toe..."
                               onkeydown="if(event.key==='Enter'){addRuitArrayItem('${charKey}','donkereKant',this.value);this.value='';}">
                        <button class="btn btn-secondary" onclick="addRuitArrayItem('${charKey}','donkereKant',document.getElementById('donkerekant-input-${charKey}').value);document.getElementById('donkerekant-input-${charKey}').value='';">+</button>
                    </div>
                    <div class="ruit-tags">
                        ${(ruit.donkereKant || []).map((item, i) => `
                            <span class="ruit-tag" style="border-left: 2px solid #8b5cf6;">${escapeHtml(item)} <span class="ruit-tag-remove" onclick="removeRuitArrayItem('${charKey}','donkereKant',${i})"></span></span>
                        `).join('')}
                    </div>
                </div>

                <!-- Angsten -->
                <div class="ruit-section" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), transparent);">
                    <div class="ruit-section-title" style="color: #ec4899;">
                        <i data-lucide="heart-crack" style="width: 16px; height: 16px;"></i>
                        Angsten
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="angsten-input-${charKey}" 
                               placeholder="Voeg angst toe..."
                               onkeydown="if(event.key==='Enter'){addRuitArrayItem('${charKey}','angsten',this.value);this.value='';}">
                        <button class="btn btn-secondary" onclick="addRuitArrayItem('${charKey}','angsten',document.getElementById('angsten-input-${charKey}').value);document.getElementById('angsten-input-${charKey}').value='';">+</button>
                    </div>
                    <div class="ruit-tags">
                        ${(ruit.angsten || []).map((item, i) => `
                            <span class="ruit-tag" style="border-left: 2px solid #ec4899;">${escapeHtml(item)} <span class="ruit-tag-remove" onclick="removeRuitArrayItem('${charKey}','angsten',${i})"></span></span>
                        `).join('')}
                    </div>
                </div>

                <!-- Gedragspatronen -->
                <div class="ruit-section">
                    <div class="ruit-section-title">
                        <i data-lucide="repeat" style="width: 16px; height: 16px;"></i>
                        Gedragspatronen
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="gedrag-input-${charKey}" 
                               placeholder="Voeg gedragspatroon toe..."
                               onkeydown="if(event.key==='Enter'){addRuitArrayItem('${charKey}','gedragspatronen',this.value);this.value='';}">
                        <button class="btn btn-secondary" onclick="addRuitArrayItem('${charKey}','gedragspatronen',document.getElementById('gedrag-input-${charKey}').value);document.getElementById('gedrag-input-${charKey}').value='';">+</button>
                    </div>
                    <div class="ruit-tags">
                        ${(ruit.gedragspatronen || []).map((item, i) => `
                            <span class="ruit-tag">${escapeHtml(item)} <span class="ruit-tag-remove" onclick="removeRuitArrayItem('${charKey}','gedragspatronen',${i})"></span></span>
                        `).join('')}
                    </div>
                </div>
            </div>

            <!-- Moet Worden (groei-arc) -->
            <div class="ruit-section ruit-section-full" style="margin-top: 1rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent);">
                <div class="ruit-section-title">
                    <i data-lucide="trending-up" style="width: 16px; height: 16px;"></i>
                    Moet Worden (groei-arc)
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" class="form-input" id="moetWorden-input-${charKey}" 
                           placeholder="Wat moet het karakter leren/worden?"
                           onkeydown="if(event.key==='Enter'){addRuitArrayItem('${charKey}','moetWorden',this.value);this.value='';}">
                    <button class="btn btn-secondary" onclick="addRuitArrayItem('${charKey}','moetWorden',document.getElementById('moetWorden-input-${charKey}').value);document.getElementById('moetWorden-input-${charKey}').value='';">+</button>
                </div>
                <div class="ruit-tags">
                    ${(ruit.moetWorden || []).map((item, i) => `
                        <span class="ruit-tag" style="border-left: 2px solid var(--accent);">${escapeHtml(item)} <span class="ruit-tag-remove" onclick="removeRuitArrayItem('${charKey}','moetWorden',${i})"></span></span>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Build ruit context string for AI prompts
    function buildRuitContext(characterNames) {
        let ruitContext = '';
        
        characterNames.forEach(charName => {
            const char = state.characters.find(c => c.name.toUpperCase() === charName.toUpperCase());
            if (char && hasRuitData(char.ruit)) {
                const r = char.ruit;
                ruitContext += `\n=== KARAKTER RUIT: ${char.name} ===\n`;
                if (r.kernbehoefteLabel) ruitContext += `Behoefte (${r.kernbehoefteLabel}): "${r.kernbehoefte}"\n`;
                else if (r.kernbehoefte) ruitContext += `Kernbehoefte: "${r.kernbehoefte}"\n`;
                if (r.masker) ruitContext += `Masker: ${r.masker}\n`;
                if (r.kernverhaal?.length) ruitContext += `Kernverhaal: ${r.kernverhaal.join(', ')}\n`;
                if (r.valkuilen?.length) ruitContext += `Valkuilen: ${r.valkuilen.join(', ')}\n`;
                if (r.kracht?.length) ruitContext += `Kracht: ${r.kracht.join(', ')}\n`;
                if (r.donkereKant?.length) ruitContext += `Donkere kant: ${r.donkereKant.join(', ')}\n`;
                if (r.angsten?.length) ruitContext += `Angsten: ${r.angsten.join(', ')}\n`;
                if (r.gedragspatronen?.length) ruitContext += `Gedragspatronen: ${r.gedragspatronen.join('; ')}\n`;
                if (r.moetWorden?.length) ruitContext += `Groei-arc (moet worden): ${r.moetWorden.join(', ')}\n`;
            }
        });
        
        return ruitContext;
    }

    function showMasterDetailModal(masterId) {
        state.ui.showMasterDetail = masterId;
        render();
    }

    function closeMasterDetailModal() {
        state.ui.showMasterDetail = null;
        render();
    }

    function applyMasterStyle(master) {
        // Store the selected master for the AI to reference
        const prompt = `Pas de stijl van ${master.name} toe op mijn volgende schrijfwerk. 
Techniek: ${master.technique}
Tip: "${master.tip}"
Bekend van: ${master.works}`;
        
        // Add to chat context
        state.chat.messages.push({
            role: 'user',
            content: `Ik wil schrijven in de stijl van ${master.name}. Help me met de volgende scene/beat met hun techniek: ${master.technique}`
        });
        
        closeMasterDetailModal();
        state.activeTab = 'chat';
        render();
        
        // Trigger AI response
        sendChatMessage(`Ik heb zojuist ${master.name} geselecteerd als stijlvoorbeeld. Hun kerntechniek is "${master.technique}" en hun tip is "${master.tip}". Hoe kan ik dit toepassen op mijn ${state.writer.genre} verhaal?`);
    }

    function renderSessionManager() {
        if (!state.ui.showSessionManager) return '';
        
        const sessions = getAllSessions();
        
        return `
            <div class="modal-overlay" onclick="state.ui.showSessionManager = false; render();">
                <div class="modal" style="max-width: 600px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3><i data-lucide="folder" style="color: var(--accent);"></i> Sessie Beheer</h3>
                        <button class="btn btn-ghost" onclick="state.ui.showSessionManager = false; render();">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Current Session -->
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent); border-radius: 8px; border-left: 3px solid var(--accent);">
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem;">Huidige sessie:</div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="text" class="form-input" style="flex: 1; font-weight: 600;"
                                       value="${escapeHtml(state.session.currentName)}"
                                       onchange="renameSession('${state.session.currentId}', this.value)">
                                <button class="btn btn-secondary" onclick="saveCurrentSession(); alert('Sessie opgeslagen!');">
                                    <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                                </button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                ${state.scripts.length} scripts  ${state.characters.length} karakters
                            </div>
                        </div>
                        
                        <!-- New Session Button -->
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 1.5rem;" onclick="promptNewSession()">
                            <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
                            Nieuwe Sessie Starten
                        </button>
                        
                        <!-- Sessions List -->
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-secondary);">
                                Opgeslagen Sessies (${sessions.length})
                            </div>
                            ${sessions.length === 0 ? `
                                <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                    Nog geen opgeslagen sessies
                                </div>
                            ` : `
                                <div style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem;">
                                    ${sessions.map(session => `
                                        <div class="session-item ${session.id === state.session.currentId ? 'active' : ''}"
                                             style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; ${session.id === state.session.currentId ? 'border-left: 3px solid var(--accent);' : ''}">
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    ${escapeHtml(session.name)}
                                                </div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted);">
                                                    ${session.scriptCount || 0} scripts  ${new Date(session.updatedAt).toLocaleDateString('nl-NL')} ${new Date(session.updatedAt).toLocaleTimeString('nl-NL', {hour: '2-digit', minute: '2-digit'})}
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 0.25rem;">
                                                ${session.id !== state.session.currentId ? `
                                                    <button class="btn btn-secondary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;"
                                                            onclick="loadSession('${session.id}')">
                                                        <i data-lucide="folder-open" style="width: 14px; height: 14px;"></i>
                                                        Openen
                                                    </button>
                                                ` : `
                                                    <span style="padding: 0.4rem 0.75rem; font-size: 0.75rem; color: var(--accent);">
                                                         Actief
                                                    </span>
                                                `}
                                                <button class="btn btn-ghost" style="padding: 0.4rem; color: var(--error);"
                                                        onclick="deleteSession('${session.id}')"
                                                        title="Verwijderen">
                                                    <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                        
                        <!-- Danger Zone -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--error); margin-bottom: 0.5rem;">
                                 Gevarenzone
                            </div>
                            <button class="btn" style="background: var(--error); color: white; font-size: 0.8rem; padding: 0.5rem 1rem;"
                                    onclick="clearAllData()">
                                <i data-lucide="trash" style="width: 14px; height: 14px;"></i>
                                Alle Data Wissen
                            </button>
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Verwijdert alle sessies, scripts en karakters permanent.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="state.ui.showSessionManager = false; render();">
                            Sluiten
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function promptNewSession() {
        const name = prompt('Naam voor nieuwe sessie:', `Sessie ${new Date().toLocaleDateString('nl-NL')}`);
        if (name !== null) {
            createNewSession(name || undefined);
            state.ui.showSessionManager = false;
        }
    }

    function renderLocationEditorModal() {
        if (!state.ui.showLocationEditor) return '';
        
        const locName = state.ui.showLocationEditor;
        const location = state.locations.find(l => l.name === locName);
        
        if (!location) return '';
        
        // Parse location type from header (INT/EXT)
        const isInterior = locName.toUpperCase().startsWith('INT');
        const isExterior = locName.toUpperCase().startsWith('EXT');
        
        return `
            <div class="location-editor-modal" onclick="closeLocationEditor()">
                <div class="location-editor-content" onclick="event.stopPropagation()">
                    <div class="location-editor-header">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="map-pin" style="color: white;"></i>
                            </div>
                            <div>
                                <h3 style="font-size: 1.1rem; margin: 0;">${escapeHtml(locName)}</h3>
                                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">
                                    ${isInterior ? ' Interieur' : isExterior ? ' Exterieur' : ' Locatie'}
                                </p>
                            </div>
                        </div>
                        <button class="btn btn-ghost" onclick="closeLocationEditor()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="location-editor-body">
                        <!-- Stats -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;">
                            <div style="text-align: center; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${location.scenes.length}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Scenes</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${location.scripts.length}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Scripts</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${location.characterCount || '?'}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Karakters</div>
                            </div>
                        </div>
                        
                        <!-- Type -->
                        <div class="location-field">
                            <label>Type Locatie</label>
                            <select class="form-control" onchange="updateLocationField('${escapeHtml(locName)}', 'type', this.value)">
                                <option value="" ${!location.type ? 'selected' : ''}>-- Selecteer --</option>
                                <option value="Woonhuis" ${location.type === 'Woonhuis' ? 'selected' : ''}> Woonhuis</option>
                                <option value="Kantoor" ${location.type === 'Kantoor' ? 'selected' : ''}> Kantoor</option>
                                <option value="Caf/Restaurant" ${location.type === 'Caf/Restaurant' ? 'selected' : ''}> Caf/Restaurant</option>
                                <option value="Winkel" ${location.type === 'Winkel' ? 'selected' : ''}> Winkel</option>
                                <option value="Ziekenhuis" ${location.type === 'Ziekenhuis' ? 'selected' : ''}> Ziekenhuis</option>
                                <option value="School" ${location.type === 'School' ? 'selected' : ''}> School</option>
                                <option value="Straat" ${location.type === 'Straat' ? 'selected' : ''}> Straat</option>
                                <option value="Park" ${location.type === 'Park' ? 'selected' : ''}> Park</option>
                                <option value="Anders" ${location.type === 'Anders' ? 'selected' : ''}> Anders</option>
                            </select>
                        </div>
                        
                        <!-- Notes -->
                        <div class="location-field">
                            <label>Notities voor Continuteit</label>
                            <textarea class="form-control" rows="4" 
                                      placeholder="Bijv: Gele bank links, TV aan de muur, altijd koffiekopjes op tafel..."
                                      onchange="updateLocationField('${escapeHtml(locName)}', 'notes', this.value)">${escapeHtml(location.notes || '')}</textarea>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                 Noteer props, meubilair, en andere details voor continuteit.
                            </p>
                        </div>
                        
                        <!-- Scenes in this location -->
                        <div class="location-field">
                            <label>Scenes op deze locatie</label>
                            <div class="location-scenes-list">
                                ${location.scenes.map((scene, idx) => `
                                    <div class="location-scene-item">
                                        <strong>Scene ${idx + 1}:</strong> ${escapeHtml(scene.substring(0, 60))}${scene.length > 60 ? '...' : ''}
                                    </div>
                                `).join('') || '<p style="color: var(--text-muted);">Geen scenes gevonden</p>'}
                            </div>
                        </div>
                        
                        <!-- Scripts -->
                        <div class="location-field">
                            <label>Voorkomt in scripts</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${location.scripts.map(script => `
                                    <span class="stat-badge">${escapeHtml(script)}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function openLocationEditor(locName) {
        state.ui.showLocationEditor = locName;
        render();
    }

    function closeLocationEditor() {
        state.ui.showLocationEditor = null;
        render();
    }

    function updateLocationField(locName, field, value) {
        const location = state.locations.find(l => l.name === locName);
        if (location) {
            location[field] = value;
            saveState();
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function highlightSearchMatch(text, searchTerm) {
        if (!text || !searchTerm) return escapeHtml(text || '');
        
        const escaped = escapeHtml(text);
        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return escaped.replace(regex, '<span class="search-highlight">$1</span>');
    }

    function renderHeader() {
        return `
            <header class="header glass">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <h1>ScriptMaster Pro</h1>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer;"
                         onclick="state.ui.showSessionManager = true; render();">
                        <i data-lucide="folder" style="width: 16px; height: 16px; color: var(--accent);"></i>
                        <span style="font-size: 0.85rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${escapeHtml(state.session.currentName || 'Geen sessie')}
                        </span>
                        <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: var(--text-muted);"></i>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-ghost" onclick="state.ui.showSettings = true; render()">
                            <i data-lucide="settings"></i>
                        </button>
                    </div>
                </div>
            </header>
        `;
    }

    function renderNav() {
        const tabs = [
            { id: 'scripts', icon: 'file-text', label: 'Scripts' },
            { id: 'writer', icon: 'pen-tool', label: 'Schrijf Assistent' },
            { id: 'characters', icon: 'users', label: 'Karakters' },
            { id: 'locations', icon: 'map-pin', label: 'Locaties' },
            { id: 'storyframe', icon: 'layout', label: 'Storyframe' },
            { id: 'continuity', icon: 'check-circle', label: 'Continuteit' },
            { id: 'chat', icon: 'message-square', label: 'AI Chat' }
        ];

        return `
            <nav class="nav-tabs">
                ${tabs.map(tab => `
                    <button class="nav-tab ${state.activeTab === tab.id ? 'active' : ''}" 
                            onclick="state.activeTab = '${tab.id}'; render()">
                        <i data-lucide="${tab.icon}"></i>
                        <span>${tab.label}</span>
                    </button>
                `).join('')}
            </nav>
        `;
    }

    function renderScriptsTab() {
        return `
            <div>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-body">
                        ${state.ui.isProcessing && state.ui.processingMessage ? `
                            <div class="upload-zone" style="border-color: var(--accent); background: rgba(245, 158, 11, 0.1);">
                                <span class="spinner" style="width: 32px; height: 32px; border-width: 3px;"></span>
                                <h3 style="color: var(--accent);">${state.ui.processingMessage}</h3>
                                <p>Dit kan 10-30 seconden duren...</p>
                            </div>
                        ` : `
                            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                                <i data-lucide="upload-cloud"></i>
                                <h3>Upload Scripts</h3>
                                <p>Sleep bestanden hierheen of klik om te uploaden</p>
                                <p style="margin-top: 0.5rem; font-size: 0.8rem;">.txt, .fountain, .pdf, .docx, of foto's (.jpg, .png)</p>
                                <p style="margin-top: 0.25rem; font-size: 0.75rem; color: var(--accent);">
                                    <i data-lucide="sparkles" style="width: 12px; height: 12px; display: inline;"></i>
                                    AI analyseert automatisch elk format
                                </p>
                            </div>
                        `}
                        <input type="file" id="fileInput" class="hidden-input" multiple 
                               accept=".txt,.fountain,.pdf,.docx,.jpg,.jpeg,.png,.gif,.webp"
                               onchange="handleFileUpload(event)">
                    </div>
                </div>

                ${state.scripts.length === 0 ? `
                    <div class="empty-state">
                        <i data-lucide="file-text"></i>
                        <h3>Nog geen scripts</h3>
                        <p>Upload je eerste script om te beginnen</p>
                    </div>
                ` : `
                    <!-- Search Box -->
                    <div class="script-search-container">
                        <div class="script-search-box">
                            <div class="script-search-wrapper">
                                <i data-lucide="search" class="script-search-icon" style="width: 18px; height: 18px;"></i>
                                <input type="text" 
                                       class="script-search-input" 
                                       placeholder="Zoek in scripts (karakters, dialoog, locaties...)"
                                       value="${escapeHtml(state.ui.scriptSearch || '')}"
                                       oninput="searchScripts(this.value)"
                                       onkeypress="if(event.key === 'Enter') searchScripts(this.value)">
                            </div>
                            ${state.ui.scriptSearch ? `
                                <button class="btn btn-ghost" onclick="clearScriptSearch()">
                                    <i data-lucide="x"></i>
                                </button>
                            ` : ''}
                        </div>
                        
                        ${state.ui.scriptSearchResults && state.ui.scriptSearchResults.length > 0 ? `
                            <div class="search-results-card">
                                <div class="search-results-header">
                                    <strong><i data-lucide="search" style="width: 16px; height: 16px; display: inline;"></i> ${state.ui.scriptSearchResults.length} resultaten voor "${escapeHtml(state.ui.scriptSearch)}"</strong>
                                    <button class="btn btn-ghost btn-sm" onclick="clearScriptSearch()">Sluiten</button>
                                </div>
                                ${state.ui.scriptSearchResults.slice(0, 20).map((result, resultIdx) => `
                                    <div class="search-result-item" onclick="goToSearchResult(${resultIdx})">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                            <i data-lucide="${result.type === 'character' ? 'user' : result.type === 'location' ? 'map-pin' : result.type === 'dialogue' ? 'message-square' : 'file-text'}" 
                                               style="width: 14px; height: 14px; color: var(--accent);"></i>
                                            <span class="stat-badge">${result.type === 'character' ? 'Karakter' : result.type === 'location' ? 'Locatie' : result.type === 'dialogue' ? 'Dialoog' : result.type === 'scene' ? 'Scene' : result.type === 'summary' ? 'Samenvatting' : 'Titel'}</span>
                                            <span style="font-size: 0.8rem; color: var(--text-muted);">${escapeHtml(result.scriptTitle)}</span>
                                        </div>
                                        <div style="font-weight: 500;">${highlightSearchMatch(result.match, state.ui.scriptSearch)}</div>
                                        ${result.context && result.type === 'dialogue' ? `
                                            <div class="search-result-context">${escapeHtml(result.context.substring(0, 150))}...</div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                                ${state.ui.scriptSearchResults.length > 20 ? `
                                    <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                                        ... en nog ${state.ui.scriptSearchResults.length - 20} resultaten meer
                                    </div>
                                ` : ''}
                            </div>
                        ` : state.ui.scriptSearch && state.ui.scriptSearch.length >= 2 && (!state.ui.scriptSearchResults || state.ui.scriptSearchResults.length === 0) ? `
                            <div style="padding: 1rem; text-align: center; color: var(--text-muted); background: var(--bg-tertiary); border-radius: 8px;">
                                <i data-lucide="search-x" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"></i>
                                <p>Geen resultaten voor "${escapeHtml(state.ui.scriptSearch)}"</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Scripts List -->
                    <div>
                        ${state.scripts.map((script, index) => {
                            const isExpanded = state.ui.expandedScripts[index];
                            const isGenerating = state.ui.generatingSummaries === index;
                            
                            return `
                            <div class="script-accordion ${isExpanded ? 'expanded' : ''}">
                                <div class="script-accordion-header" onclick="toggleScriptAccordion(${index})">
                                    <div class="script-accordion-icon">
                                        <i data-lucide="file-text"></i>
                                    </div>
                                    <div class="script-accordion-info">
                                        <div class="script-accordion-title">${escapeHtml(script.title)}</div>
                                        <div class="script-accordion-meta">
                                            <span class="stat-badge">${script.stats.sceneCount} scenes</span>
                                            <span class="stat-badge">${script.stats.characterCount} karakters</span>
                                            ${script.analyzedByAI ? `<span class="stat-badge" style="background: var(--accent); color: var(--bg-primary);"> AI</span>` : ''}
                                            ${script.sceneSummaries ? `<span class="stat-badge" style="background: var(--success); color: white;"> Samengevat</span>` : ''}
                                        </div>
                                        ${script.detectedFormat ? `
                                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                                                Format: ${escapeHtml(script.detectedFormat)}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <button class="btn btn-ghost" onclick="event.stopPropagation(); deleteScript(${index})" title="Verwijderen">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                    <div class="script-accordion-chevron">
                                        <i data-lucide="chevron-down"></i>
                                    </div>
                                </div>
                                <div class="script-accordion-body">
                                    <div class="script-accordion-content">
                                        <div class="script-actions-bar">
                                            <button class="btn btn-primary" onclick="event.stopPropagation(); viewScript(${index})">
                                                <i data-lucide="maximize-2"></i>
                                                Volledig Script
                                            </button>
                                            ${!script.sceneSummaries ? `
                                                <button class="btn btn-secondary" onclick="event.stopPropagation(); generateSceneSummaries(${index})" ${isGenerating ? 'disabled' : ''}>
                                                    <i data-lucide="sparkles"></i>
                                                    Genereer Samenvattingen
                                                </button>
                                            ` : `
                                                <button class="btn btn-ghost" onclick="event.stopPropagation(); regenerateSceneSummaries(${index})" title="Opnieuw genereren">
                                                    <i data-lucide="refresh-cw"></i>
                                                </button>
                                            `}
                                        </div>
                                        
                                        ${isGenerating ? `
                                            <div class="generating-summaries">
                                                <span class="spinner"></span>
                                                <span>Scene samenvattingen worden gegenereerd...</span>
                                            </div>
                                        ` : script.sceneSummaries ? `
                                            <div class="scene-summary-list">
                                                ${script.sceneSummaries.map((summary, i) => `
                                                    <div class="scene-summary-item">
                                                        <div class="scene-summary-number">${i + 1}</div>
                                                        <div class="scene-summary-content">
                                                            <div class="scene-summary-header">${escapeHtml(summary.header || script.scenes[i]?.header || 'Scene ' + (i + 1))}</div>
                                                            <div class="scene-summary-text">${escapeHtml(summary.summary)}</div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : `
                                            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                                <i data-lucide="list" style="width: 32px; height: 32px; margin-bottom: 0.5rem;"></i>
                                                <p>Klik op "Genereer Samenvattingen" om een overzicht van alle scenes te krijgen</p>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `}
            </div>
        `;
    }

    function renderCharactersTab() {
        if (state.characters.length === 0) {
            return `
                <div class="empty-state">
                    <i data-lucide="users"></i>
                    <h3>Nog geen karakters</h3>
                    <p>Upload scripts om karakters te zien</p>
                </div>
            `;
        }

        return `
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; border-left: 4px solid var(--accent);">
                    <i data-lucide="diamond" style="color: var(--accent); width: 24px; height: 24px;"></i>
                    <div>
                        <strong style="color: var(--accent);">Karakter Ruit Systeem</strong>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">
                            Klik op een karakter om de Ruit in te vullen. De ruit-informatie wordt automatisch meegenomen bij scene-generatie.
                        </p>
                    </div>
                </div>
            </div>
            <div class="grid-3">
                ${state.characters.map(char => {
                    const hasRuit = hasRuitData(char.ruit);
                    return `
                    <div class="entity-card character-card ${hasRuit ? 'has-ruit' : ''}" 
                         onclick="openRuitEditor('${char.name.toUpperCase()}')"
                         style="cursor: pointer; transition: all 0.2s; position: relative;">
                        ${hasRuit ? `<div class="ruit-indicator" title="Ruit ingevuld"></div>` : ''}
                        ${char.ruit?.foto ? `
                            <div class="character-photo" style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; margin-bottom: 0.5rem;">
                                <img src="${char.ruit.foto}" alt="${char.name}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        ` : ''}
                        <div class="entity-name">
                            <i data-lucide="user" style="width: 16px; height: 16px;"></i>
                            ${escapeHtml(char.name)}
                        </div>
                        <div class="entity-stats">
                            <span>${char.scenes.length} scenes</span>
                            <span>${char.dialogueCount} dialogen</span>
                        </div>
                        ${char.ruit?.kernbehoefte ? `
                            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--accent); font-style: italic;">
                                "${escapeHtml(char.ruit.kernbehoefte)}"
                            </div>
                        ` : ''}
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                            ${char.scripts.slice(0, 2).join(', ')}${char.scripts.length > 2 ? '...' : ''}
                        </div>
                        <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--text-secondary);">
                            <i data-lucide="edit-2" style="width: 12px; height: 12px; display: inline;"></i>
                            Klik om ruit te bewerken
                        </div>
                    </div>
                `}).join('')}
            </div>
        `;
    }

    function renderLocationsTab() {
        if (state.locations.length === 0) {
            return `
                <div class="empty-state">
                    <i data-lucide="map-pin"></i>
                    <h3>Nog geen locaties</h3>
                    <p>Upload scripts om locaties te zien</p>
                </div>
            `;
        }

        return `
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <i data-lucide="map-pin" style="color: #3b82f6; width: 24px; height: 24px;"></i>
                    <div>
                        <strong style="color: #3b82f6;">Locatie Details</strong>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">
                            Klik op een locatie om details te bekijken en notities toe te voegen.
                        </p>
                    </div>
                </div>
            </div>
            <div class="grid-3">
                ${state.locations.map(loc => {
                    const hasNotes = loc.notes && loc.notes.trim().length > 0;
                    return `
                    <div class="entity-card ${hasNotes ? 'has-notes' : ''}" 
                         onclick="openLocationEditor('${escapeHtml(loc.name)}')"
                         style="cursor: pointer; transition: all 0.2s; position: relative;">
                        ${hasNotes ? `<div class="ruit-indicator" title="Notities aanwezig" style="background: #3b82f6;"></div>` : ''}
                        <div class="entity-name">
                            <i data-lucide="map-pin" style="width: 16px; height: 16px;"></i>
                            ${escapeHtml(loc.name)}
                        </div>
                        <div class="entity-stats">
                            <span>${loc.scenes.length} scenes</span>
                            <span>${loc.scripts.length} scripts</span>
                        </div>
                        ${loc.type ? `
                            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--accent);">
                                ${escapeHtml(loc.type)}
                            </div>
                        ` : ''}
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                            ${loc.scripts.slice(0, 2).join(', ')}${loc.scripts.length > 2 ? '...' : ''}
                        </div>
                        <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--text-secondary);">
                            <i data-lucide="edit-2" style="width: 12px; height: 12px; display: inline;"></i>
                            Klik voor details
                        </div>
                    </div>
                `}).join('')}
            </div>
        `;
    }

    function renderStoryframeTab() {
        const currentGenre = genres[state.storyframe.genre];
        
        return `
            <div class="storyframe-container">
                <!-- Info Card -->
                <div class="card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid var(--accent);">
                    <div class="card-body" style="padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <i data-lucide="info" style="color: var(--accent);"></i>
                            <strong style="color: var(--accent);">Wat is de Storyframe Tool?</strong>
                        </div>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">
                            Deze tool helpt schrijvers om een <strong>lange lijn</strong> (het verhaal voor meerdere weken) 
                            om te zetten naar concrete <strong>beats per week</strong>, vrdat de synopsis geschreven wordt. 
                            De tool past de 5-acten structuur toe en houdt rekening met de principes van het gekozen genre.
                        </p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i data-lucide="file-text"></i> Lange Lijn Document</h3>
                    </div>
                    <div class="card-body">
                        <textarea class="storyframe-input" 
                                  placeholder="Plak hier je lange lijn document. Beschrijf het verhaal dat je hebt bedacht voor de komende weken/maanden. Wat is het centrale conflict? Wie zijn de hoofdpersonen? Waar gaat het verhaal naartoe? Wat zijn de belangrijkste wendingen?"
                                  oninput="state.storyframe.longLine = this.value; saveState()"
                                  style="min-height: 200px;"
                        >${state.storyframe.longLine || ''}</textarea>
                        
                        <!-- Aantal Weken Selector -->
                        <div style="margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; align-items: start;">
                            <div>
                                <label class="form-label">Aantal Weken</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="range" min="3" max="26" value="${state.storyframe.totalWeeks}" 
                                           oninput="state.storyframe.totalWeeks = parseInt(this.value); saveState(); render()"
                                           style="flex: 1;">
                                    <span style="min-width: 3rem; text-align: center; font-weight: bold; font-size: 1.25rem; color: var(--accent);">
                                        ${state.storyframe.totalWeeks}
                                    </span>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    Week verdeling: ${actStructure.map((act, i) => {
                                        const range = getWeekRangeForAct(i + 1, state.storyframe.totalWeeks);
                                        return `Act ${act.act}: ${range.start}-${range.end}`;
                                    }).join(' | ')}
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label">Genre</label>
                                <div class="genre-selector">
                                    ${Object.entries(genres).map(([key, genre]) => `
                                        <button class="genre-btn ${state.storyframe.genre === key ? 'active' : ''}"
                                                onclick="state.storyframe.genre = '${key}'; saveState(); render()"
                                                style="${state.storyframe.genre === key ? 'background:' + genre.color + '; border-color:' + genre.color : ''}">
                                            ${genre.name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Genre Info Panel -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(${currentGenre.color === '#3b82f6' ? '59,130,246' : currentGenre.color === '#ec4899' ? '236,72,153' : currentGenre.color === '#f43f5e' ? '244,63,94' : currentGenre.color === '#ef4444' ? '239,68,68' : currentGenre.color === '#22c55e' ? '34,197,94' : '139,92,246'}, 0.15); border-radius: 0.5rem; border-left: 4px solid ${currentGenre.color};">
                            <div style="font-weight: 600; color: ${currentGenre.color}; margin-bottom: 0.5rem;">
                                ${currentGenre.name} - Genre Principes
                            </div>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                                ${currentGenre.principles}
                            </p>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                <strong>Referenties:</strong> ${currentGenre.references.join(', ')}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; font-style: italic;">
                                 ${currentGenre.tips}
                            </div>
                        </div>
                        
                        <!-- 5 Acten Structuur Uitleg -->
                        <div style="margin-top: 1.5rem;">
                            <label class="form-label">5-Acten Structuur</label>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
                                ${actStructure.map(act => `
                                    <div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem; text-align: center;">
                                        <div style="font-weight: 600; color: var(--accent); font-size: 0.8rem;">Act ${act.act}</div>
                                        <div style="font-weight: 500; font-size: 0.85rem;">${act.name}</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">${act.percentage}%</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            ${renderMasterDropdown()}
                        </div>
                        
                        <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%; padding: 1rem;" 
                                onclick="generateStoryframe()"
                                ${state.ui.isProcessing ? 'disabled' : ''}>
                            ${state.ui.isProcessing ? '<span class="spinner"></span> Storyframe wordt gegenereerd...' : '<i data-lucide="sparkles"></i> Genereer Storyframe'}
                        </button>
                    </div>
                </div>

                ${state.storyframe.weeks.length > 0 ? `
                    <!-- Overall Notes -->
                    ${state.storyframe.notes ? `
                        <div class="card" style="margin-top: 1.5rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1));">
                            <div class="card-body">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <i data-lucide="lightbulb" style="color: var(--success);"></i>
                                    <strong>Dramaturgische Tips voor dit Verhaal</strong>
                                </div>
                                <p style="color: var(--text-secondary); margin: 0;">${escapeHtml(state.storyframe.notes)}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>${state.storyframe.totalWeeks}-Weken Breakdown</h3>
                            <button class="btn btn-secondary" onclick="exportStoryframe()">
                                <i data-lucide="download"></i> Exporteer
                            </button>
                        </div>
                        <div class="grid-2">
                            ${state.storyframe.weeks.map(week => {
                                const act = week.act ? actStructure[week.act - 1] : getActForWeek(week.number, state.storyframe.totalWeeks);
                                return `
                                    <div class="week-card" style="border-left: 4px solid ${genres[state.storyframe.genre].color};">
                                        <div class="week-header">
                                            <span>Week ${week.number}</span>
                                            <span class="act-badge act-${act.act}">Act ${act.act}: ${act.name}</span>
                                        </div>
                                        <div class="week-content">
                                            <p style="margin-bottom: 0.75rem;">${escapeHtml(week.summary)}</p>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                <strong>Key Beats:</strong>
                                                <ul style="margin-top: 0.25rem; padding-left: 1.25rem;">
                                                    ${week.beats.map(beat => `<li>${escapeHtml(beat)}</li>`).join('')}
                                                </ul>
                                            </div>
                                            <div style="margin-top: 0.75rem; font-size: 0.85rem;">
                                                <strong>Emotie:</strong> ${escapeHtml(week.emotion)}
                                            </div>
                                            ${week.genreElement ? `
                                                <div style="margin-top: 0.75rem; font-size: 0.85rem; padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: 0.25rem;">
                                                    <strong style="color: var(--accent);">Genre Element:</strong> ${escapeHtml(week.genreElement)}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    function exportStoryframe() {
        if (state.storyframe.weeks.length === 0) return;
        
        const genre = genres[state.storyframe.genre];
        let text = `STORYFRAME - ${genre.name.toUpperCase()}\n`;
        text += `Gegenereerd: ${new Date().toLocaleDateString('nl-NL')}\n`;
        text += `Aantal weken: ${state.storyframe.totalWeeks}\n`;
        text += `${'='.repeat(60)}\n\n`;
        
        text += `LANGE LIJN:\n${state.storyframe.longLine}\n\n`;
        text += `${'='.repeat(60)}\n\n`;
        
        if (state.storyframe.notes) {
            text += `DRAMATURGISCHE TIPS:\n${state.storyframe.notes}\n\n`;
            text += `${'='.repeat(60)}\n\n`;
        }
        
        state.storyframe.weeks.forEach(week => {
            const act = week.act ? actStructure[week.act - 1] : getActForWeek(week.number, state.storyframe.totalWeeks);
            text += `WEEK ${week.number} - Act ${act.act}: ${act.name}\n`;
            text += `${'-'.repeat(40)}\n`;
            text += `Samenvatting: ${week.summary}\n\n`;
            text += `Key Beats:\n`;
            week.beats.forEach((beat, i) => {
                text += `  ${i + 1}. ${beat}\n`;
            });
            text += `\nEmotie: ${week.emotion}\n`;
            if (week.genreElement) {
                text += `Genre Element: ${week.genreElement}\n`;
            }
            text += `\n`;
        });
        
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `storyframe_${state.storyframe.totalWeeks}weken_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function renderContinuityTab() {
        const basicIssues = checkContinuity();
        const aiReport = state.ui.continuityReport;
        const isGenerating = state.ui.generatingContinuity;
        
        // Count issues per category
        const countIssues = (arr) => arr?.length || 0;
        const totalBasic = countIssues(basicIssues.characters) + countIssues(basicIssues.locations) + 
                          countIssues(basicIssues.time) + countIssues(basicIssues.dialogue) +
                          countIssues(basicIssues.props) + countIssues(basicIssues.wardrobe) +
                          countIssues(basicIssues.eyelines) + countIssues(basicIssues.action);
        const totalAI = aiReport?.issues?.length || 0;
        
        const categories = [
            { id: 'characters', name: 'Karakters', icon: 'users', issues: basicIssues.characters || [] },
            { id: 'locations', name: 'Locaties & Weer', icon: 'map-pin', issues: basicIssues.locations || [] },
            { id: 'time', name: 'Tijd (Dag/Nacht)', icon: 'clock', issues: basicIssues.time || [] },
            { id: 'props', name: 'Props & Eten/Drinken', icon: 'coffee', issues: basicIssues.props || [] },
            { id: 'wardrobe', name: 'Wardrobe/Kleding', icon: 'shirt', issues: basicIssues.wardrobe || [] },
            { id: 'eyelines', name: 'Eyelines & Blikken', icon: 'eye', issues: basicIssues.eyelines || [] },
            { id: 'action', name: 'Binnenkomst/Vertrek', icon: 'door-open', issues: basicIssues.action || [] },
            { id: 'dialogue', name: 'Dialoog', icon: 'message-square', issues: basicIssues.dialogue || [] },
            { id: 'plot', name: 'Plot', icon: 'git-branch', issues: basicIssues.plot || [] }
        ];
        
        return `
            <div>
                <!-- Info Card -->
                <div class="card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid var(--success); margin-bottom: 1.5rem;">
                    <div class="card-body" style="padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <i data-lucide="shield-check" style="color: var(--success);"></i>
                            <strong style="color: var(--success);">Professionele Script Supervisor Check</strong>
                        </div>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                            Controleert op: <strong>Karakter inconsistenties</strong>, <strong>Locatie/weer fouten</strong>, 
                            <strong>Dag/nacht timing</strong>, <strong>Props & eten/drinken</strong> (meest voorkomende fout!),
                            <strong>Wardrobe</strong>, <strong>Eyelines</strong>, <strong>Binnenkomst/vertrek</strong>, en <strong>Dialoog</strong>.
                        </p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i data-lucide="check-circle"></i> Continuteitscontrole</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="render()">
                                <i data-lucide="refresh-cw"></i>
                                Basis Scan
                            </button>
                            <button class="btn btn-primary" onclick="generateAIContinuityReport()" ${isGenerating ? 'disabled' : ''}>
                                <i data-lucide="sparkles"></i>
                                ${isGenerating ? 'Analyseren...' : 'AI Diepe Analyse'}
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        ${state.scripts.length === 0 ? `
                            <div class="empty-state">
                                <i data-lucide="file-x"></i>
                                <p>Upload eerst scripts om continuteit te controleren</p>
                            </div>
                        ` : `
                            ${isGenerating ? `
                                <div class="generating-summaries" style="margin-bottom: 1rem;">
                                    <span class="spinner"></span>
                                    <span>AI analyseert scripts op continuteitsproblemen...</span>
                                </div>
                            ` : ''}
                            
                            <!-- Basic Analysis Results -->
                            <h4 style="margin-bottom: 1rem; color: var(--text-secondary);">
                                <i data-lucide="search" style="width: 16px; height: 16px; display: inline;"></i>
                                Script Supervisor Analyse ${totalBasic > 0 ? `(${totalBasic} aandachtspunten)` : '(geen problemen)'}
                            </h4>
                            
                            ${categories.map(cat => `
                                <div class="continuity-category">
                                    <div class="continuity-category-header">
                                        <i data-lucide="${cat.icon}" style="width: 18px; height: 18px; color: var(--text-secondary);"></i>
                                        <span>${cat.name}</span>
                                        <span class="continuity-count ${cat.issues.length > 0 ? 'warning' : 'ok'}">
                                            ${cat.issues.length}
                                        </span>
                                    </div>
                                    ${cat.issues.length > 0 ? `
                                        ${cat.issues.map(issue => `
                                            <div class="continuity-issue ${issue.type}">
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                    <i data-lucide="${issue.type === 'error' ? 'x-circle' : issue.type === 'warning' ? 'alert-triangle' : 'info'}" 
                                                       style="width: 16px; height: 16px; color: var(--${issue.type === 'error' ? 'error' : issue.type === 'warning' ? 'accent' : 'text-secondary'});"></i>
                                                    <strong style="font-size: 0.9rem;">${escapeHtml(issue.message)}</strong>
                                                </div>
                                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                                                     ${escapeHtml(issue.suggestion)}
                                                </p>
                                            </div>
                                        `).join('')}
                                    ` : `
                                        <div style="padding: 0.5rem 1rem; color: var(--success); font-size: 0.85rem;">
                                             Geen problemen gevonden
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                            
                            ${aiReport ? `
                                <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0;">
                                
                                <h4 style="margin-bottom: 1rem; color: var(--accent);">
                                    <i data-lucide="sparkles" style="width: 16px; height: 16px; display: inline;"></i>
                                    AI Diepe Analyse ${totalAI > 0 ? `(${totalAI} gevonden)` : '(geen problemen)'}
                                </h4>
                                
                                ${aiReport.summary ? `
                                    <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 1rem;">
                                        <p style="margin: 0; font-style: italic; color: var(--text-secondary);">${escapeHtml(aiReport.summary)}</p>
                                    </div>
                                ` : ''}
                                
                                ${aiReport.issues?.length > 0 ? `
                                    ${aiReport.issues.map(issue => `
                                        <div class="continuity-issue ${issue.severity}">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                <span class="stat-badge" style="background: var(--bg-secondary);">${issue.category}</span>
                                                ${issue.scene ? `<span style="font-size: 0.8rem; color: var(--text-muted);">${escapeHtml(issue.scene)}</span>` : ''}
                                            </div>
                                            <p style="margin: 0 0 0.5rem 0;">${escapeHtml(issue.description)}</p>
                                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                                                 ${escapeHtml(issue.suggestion)}
                                            </p>
                                        </div>
                                    `).join('')}
                                ` : `
                                    <div class="continuity-issue ok">
                                        <i data-lucide="check-circle" style="color: var(--success); width: 20px; height: 20px;"></i>
                                        <strong style="margin-left: 0.5rem;">Geen continuteitsproblemen gevonden!</strong>
                                        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">
                                            De AI heeft geen significante problemen gedetecteerd in je scripts.
                                        </p>
                                    </div>
                                `}
                                
                                <button class="btn btn-ghost" style="margin-top: 1rem;" onclick="state.ui.continuityReport = null; render();">
                                    <i data-lucide="x"></i> AI Rapport Wissen
                                </button>
                            ` : ''}
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    function renderChatTab() {
        return `
            <div class="chat-container card">
                <div class="chat-messages" id="chatMessages">
                    ${state.chat.messages.length === 0 ? `
                        <div class="empty-state">
                            <i data-lucide="message-square"></i>
                            <h3>Chat met je AI Schrijfassistent</h3>
                            <p>Stel vragen over je scripts, vraag om feedback, of brainstorm nieuwe ideen</p>
                        </div>
                    ` : `
                        ${state.chat.messages.map(msg => `
                            <div class="chat-message ${msg.role}">
                                ${escapeHtml(msg.content).replace(/\n/g, '<br>')}
                            </div>
                        `).join('')}
                        ${state.chat.isLoading ? `
                            <div class="chat-message assistant">
                                <span class="spinner"></span> Aan het denken...
                            </div>
                        ` : ''}
                    `}
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" 
                           placeholder="Stel een vraag over je scripts..."
                           onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i data-lucide="send"></i>
                    </button>
                </div>
            </div>
        `;
    }

    function renderWisdomTab() {
        return `
            <div>
                ${Object.entries(masterWisdom).map(([category, wisdoms]) => `
                    <div class="wisdom-category">
                        <h3>${category.charAt(0).toUpperCase() + category.slice(1)}</h3>
                        <div class="grid-2">
                            ${wisdoms.map(w => `
                                <div class="wisdom-card">
                                    <p class="wisdom-quote">"${escapeHtml(w.wisdom)}"</p>
                                    <p class="wisdom-author"> ${escapeHtml(w.writer)}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderSettingsModal() {
        if (!state.ui.showSettings) return '';

        return `
            <div class="modal-overlay" onclick="state.ui.showSettings = false; render()">
                <div class="modal" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3>Settings</h3>
                        <button class="btn btn-ghost" onclick="state.ui.showSettings = false; render()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Claude API Key</label>
                            <input type="password" class="form-input" 
                                   value="${state.settings.apiKey}"
                                   placeholder="sk-ant-api03-..."
                                   oninput="state.settings.apiKey = this.value">
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Verkrijgbaar op console.anthropic.com
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Proxy URL</label>
                            <input type="text" class="form-input" 
                                   value="${state.settings.proxyUrl}"
                                   oninput="state.settings.proxyUrl = this.value">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="state.ui.showSettings = false; render()">
                            Annuleren
                        </button>
                        <button class="btn btn-primary" onclick="saveSettings()">
                            Opslaan
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderSceneViewer() {
        if (!state.ui.showSceneViewer || state.selectedScript === null || state.selectedScript === undefined) return '';

        const script = state.scripts[state.selectedScript];
        if (!script) return '';
        
        return `
            <div class="scene-viewer">
                <div class="header glass">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn btn-ghost" onclick="closeSceneViewer()">
                            <i data-lucide="arrow-left"></i>
                        </button>
                        <div>
                            <h2 style="font-family: var(--font-display); font-size: 1.1rem; font-weight: 400;">${escapeHtml(script.title)}</h2>
                            <p style="font-size: 0.82rem; color: var(--text-secondary);">
                                ${script.stats?.sceneCount || 0} scenes  ${script.stats?.characterCount || 0} karakters
                                ${script.detectedFormat ? '  ' + escapeHtml(script.detectedFormat) : ''}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="scene-content">
                    ${script.scenes.map(scene => `
                        <div style="margin-bottom: 3rem;">
                            <div class="scene-header-text">${escapeHtml(scene.header || 'Scene ' + scene.number)}</div>
                            ${scene.summary ? `<div style="color: var(--text-secondary); font-style: italic; margin-bottom: 1rem; font-size: 0.88rem;">${escapeHtml(scene.summary)}</div>` : ''}
                            ${scene.content && scene.content.length > 1 ? 
                                scene.content.slice(1).map(line => {
                                    const trimmed = (line || '').trim();
                                    if (!trimmed) return '';
                                    
                                    if (trimmed === trimmed.toUpperCase() && trimmed.length > 1 && trimmed.length < 40 && !trimmed.match(/^[\d\.\(\)]/)) {
                                        return `<div class="scene-character">${escapeHtml(trimmed)}</div>`;
                                    }
                                    if (trimmed.match(/^\([^)]+\)$/)) {
                                        return `<div class="scene-parenthetical">${escapeHtml(trimmed)}</div>`;
                                    }
                                    if (line.startsWith('    ') || line.startsWith('\t')) {
                                        return `<div class="scene-dialogue">${escapeHtml(trimmed)}</div>`;
                                    }
                                    return `<div class="scene-action">${escapeHtml(trimmed)}</div>`;
                                }).join('')
                            :
                                (scene.dialogues && scene.dialogues.length > 0 ? 
                                    scene.dialogues.map(d => `
                                        <div class="scene-character">${escapeHtml(d.character || '')}</div>
                                        <div class="scene-dialogue">${escapeHtml(d.text || '')}</div>
                                    `).join('')
                                : 
                                    `<div class="scene-action" style="color: var(--text-muted);">Geen content beschikbaar. Gebruik "Genereer Samenvattingen" voor een overzicht.</div>`
                                )
                            }
                        </div>
                    `).join('')}
                    ${(!script.scenes || script.scenes.length === 0) && script.rawText ? `
                        <div style="font-family: var(--font-mono); white-space: pre-wrap; font-size: 0.85rem; line-height: 1.7;">${escapeHtml(script.rawText.substring(0, 50000))}</div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function renderMainContent() {
        switch (state.activeTab) {
            case 'scripts': return renderScriptsTab();
            case 'writer': return renderWriterTab();
            case 'characters': return renderCharactersTab();
            case 'locations': return renderLocationsTab();
            case 'storyframe': return renderStoryframeTab();
            case 'continuity': return renderContinuityTab();
            case 'chat': return renderChatTab();
            case 'wisdom': return renderWisdomTab();
            default: return renderScriptsTab();
        }
    }

    // ============================================
    // WRITER ASSISTANT TAB RENDER
    // ============================================

    function renderWriterTab() {
        return `
            <div class="writer-container">
                <!-- Sub-tabs -->
                <div class="tabs-sub">
                    <button class="tab-sub ${state.writer.subTab === 'beats' ? 'active' : ''}"
                            onclick="state.writer.subTab = 'beats'; render()">
                        <i data-lucide="list-ordered" style="width:16px;height:16px;"></i>
                        Beat Planner
                    </button>
                    <button class="tab-sub ${state.writer.subTab === 'scene' ? 'active' : ''}"
                            onclick="state.writer.subTab = 'scene'; render()">
                        <i data-lucide="clapperboard" style="width:16px;height:16px;"></i>
                        Scene Builder
                    </button>
                    <button class="tab-sub ${state.writer.subTab === 'dialogue' ? 'active' : ''}"
                            onclick="state.writer.subTab = 'dialogue'; render()">
                        <i data-lucide="message-circle" style="width:16px;height:16px;"></i>
                        Dialoog Generator
                    </button>
                    <button class="tab-sub ${state.writer.subTab === 'conflict' ? 'active' : ''}"
                            onclick="state.writer.subTab = 'conflict'; render()">
                        <i data-lucide="flame" style="width:16px;height:16px;"></i>
                        Conflict Escalator
                    </button>
                    <button class="tab-sub ${state.writer.subTab === 'twist' ? 'active' : ''}"
                            onclick="state.writer.subTab = 'twist'; render()">
                        <i data-lucide="shuffle" style="width:16px;height:16px;"></i>
                        Plot Twist
                    </button>
                </div>

                ${state.writer.subTab === 'beats' ? renderBeatPlanner() : ''}
                ${state.writer.subTab === 'scene' ? renderSceneBuilder() : ''}
                ${state.writer.subTab === 'dialogue' ? renderDialogueGenerator() : ''}
                ${state.writer.subTab === 'conflict' ? renderConflictEscalator() : ''}
                ${state.writer.subTab === 'twist' ? renderTwistGenerator() : ''}
            </div>
        `;
    }

    // ============================================
    // SCENE BUILDER RENDER
    // ============================================

    function renderSceneBuilder() {
        const s = state.writer.scene;
        
        // Check which characters have ruit data
        const charactersWithRuit = s.characters.filter(charName => {
            const char = state.characters.find(c => c.name.toUpperCase() === charName.toUpperCase());
            return char && hasRuitData(char.ruit);
        });
        
        return `
            <div class="card">
                <div class="card-header">
                    <h3> Scene Builder</h3>
                    <span style="color: var(--text-secondary);">Genereer volledige scenes met ruit-integratie</span>
                </div>
                <div class="card-body">
                    <div class="scene-form">
                        <div>
                            <label class="form-label">INT / EXT</label>
                            <select class="form-input" onchange="state.writer.scene.intExt = this.value">
                                <option value="INT" ${s.intExt === 'INT' ? 'selected' : ''}>INT.</option>
                                <option value="EXT" ${s.intExt === 'EXT' ? 'selected' : ''}>EXT.</option>
                                <option value="INT/EXT" ${s.intExt === 'INT/EXT' ? 'selected' : ''}>INT/EXT.</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Tijd van de dag</label>
                            <select class="form-input" onchange="state.writer.scene.timeOfDay = this.value">
                                <option value="DAY" ${s.timeOfDay === 'DAY' ? 'selected' : ''}>DAY</option>
                                <option value="NIGHT" ${s.timeOfDay === 'NIGHT' ? 'selected' : ''}>NIGHT</option>
                                <option value="DAWN" ${s.timeOfDay === 'DAWN' ? 'selected' : ''}>DAWN</option>
                                <option value="DUSK" ${s.timeOfDay === 'DUSK' ? 'selected' : ''}>DUSK</option>
                                <option value="CONTINUOUS" ${s.timeOfDay === 'CONTINUOUS' ? 'selected' : ''}>CONTINUOUS</option>
                            </select>
                        </div>
                        <div class="scene-form-full">
                            <label class="form-label">Locatie *</label>
                            <input type="text" class="form-input" 
                                   placeholder="bijv. SARAH'S APPARTEMENT - WOONKAMER"
                                   value="${escapeHtml(s.location)}"
                                   oninput="state.writer.scene.location = this.value">
                        </div>
                        <div class="scene-form-full">
                            <label class="form-label">Karakters ${state.characters.length > 0 ? '(kies uit database of typ zelf)' : '(komma-gescheiden)'}</label>
                            ${state.characters.length > 0 ? `
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    ${state.characters.slice(0, 12).map(char => {
                                        const isSelected = s.characters.some(c => c.toUpperCase() === char.name.toUpperCase());
                                        const charHasRuit = hasRuitData(char.ruit);
                                        return `
                                            <button type="button" 
                                                    class="btn ${isSelected ? 'btn-primary' : 'btn-secondary'}"
                                                    style="padding: 0.25rem 0.75rem; font-size: 0.8rem; ${charHasRuit ? 'border-left: 3px solid var(--success);' : ''}"
                                                    onclick="toggleSceneCharacter('${char.name}')">
                                                ${char.ruit?.foto ? `<img src="${char.ruit.foto}" style="width: 16px; height: 16px; border-radius: 50%; margin-right: 4px;">` : ''}
                                                ${escapeHtml(char.name)}
                                                ${charHasRuit ? ' ' : ''}
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                            <input type="text" class="form-input" 
                                   placeholder="bijv. SARAH, MARK, DETECTIVE JANSEN"
                                   value="${s.characters.join(', ')}"
                                   oninput="state.writer.scene.characters = this.value.split(',').map(c => c.trim()).filter(c => c); render();">
                        </div>
                        
                        ${charactersWithRuit.length > 0 ? `
                            <div class="scene-form-full" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), transparent); padding: 0.75rem; border-radius: 8px; border-left: 3px solid var(--success);">
                                <div style="font-size: 0.85rem; color: var(--success); margin-bottom: 0.5rem;">
                                    <i data-lucide="diamond" style="width: 14px; height: 14px; display: inline;"></i>
                                    Ruit-informatie beschikbaar voor: <strong>${charactersWithRuit.join(', ')}</strong>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    De AI zal maskers, valkuilen, krachten en angsten van deze karakters meenemen in de scene-generatie.
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="scene-form-full">
                            <label class="form-label">Doel van de scene *</label>
                            <textarea class="form-input" style="min-height: 80px;"
                                      placeholder="Wat moet deze scene bereiken? Welke informatie moet onthuld worden? Welke emotie?"
                                      oninput="state.writer.scene.objective = this.value">${escapeHtml(s.objective)}</textarea>
                        </div>
                        <div>
                            <label class="form-label">Conflict</label>
                            <input type="text" class="form-input" 
                                   placeholder="Wat is het obstakel of de spanning?"
                                   value="${escapeHtml(s.conflict)}"
                                   oninput="state.writer.scene.conflict = this.value">
                        </div>
                        <div>
                            <label class="form-label">Toon</label>
                            <select class="form-input" onchange="state.writer.scene.tone = this.value">
                                <option value="neutral" ${s.tone === 'neutral' ? 'selected' : ''}>Neutraal</option>
                                <option value="tense" ${s.tone === 'tense' ? 'selected' : ''}>Gespannen</option>
                                <option value="romantic" ${s.tone === 'romantic' ? 'selected' : ''}>Romantisch</option>
                                <option value="comedic" ${s.tone === 'comedic' ? 'selected' : ''}>Komisch</option>
                                <option value="dramatic" ${s.tone === 'dramatic' ? 'selected' : ''}>Dramatisch</option>
                                <option value="action" ${s.tone === 'action' ? 'selected' : ''}>Actie</option>
                                <option value="horror" ${s.tone === 'horror' ? 'selected' : ''}>Horror</option>
                            </select>
                        </div>
                        <div class="scene-form-full">
                            ${renderMasterDropdown()}
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="generateScene()" ${state.writer.isGenerating ? 'disabled' : ''}>
                            ${state.writer.isGenerating ? '<span class="spinner"></span> Genereren...' : ' Genereer Scene'}
                        </button>
                        ${s.generatedScene ? `
                            <button class="btn btn-secondary" onclick="copyToClipboard(state.writer.scene.generatedScene, this)">
                                 Kopieer
                            </button>
                            <button class="btn btn-secondary" onclick="exportSceneToFountain()">
                                 Download .fountain
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>

            ${s.generatedScene ? `
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3>Gegenereerde Scene</h3>
                    </div>
                    <div class="card-body">
                        <div class="scene-preview">${escapeHtml(s.generatedScene)}</div>
                    </div>
                </div>
            ` : ''}
        `;
    }

    // ============================================
    // DIALOGUE GENERATOR RENDER
    // ============================================

    function renderDialogueGenerator() {
        const d = state.writer.dialogue;
        
        return `
            <div class="card">
                <div class="card-header">
                    <h3> Dialoog Generator</h3>
                    <span style="color: var(--text-secondary);">3 versies van dezelfde dialoog</span>
                </div>
                <div class="card-body">
                    <div class="scene-form">
                        <div>
                            <label class="form-label">Wie spreekt *</label>
                            <input type="text" class="form-input" 
                                   placeholder="bijv. SARAH"
                                   value="${escapeHtml(d.speaker)}"
                                   oninput="state.writer.dialogue.speaker = this.value">
                        </div>
                        <div>
                            <label class="form-label">Tegen wie</label>
                            <input type="text" class="form-input" 
                                   placeholder="bijv. MARK"
                                   value="${escapeHtml(d.listener)}"
                                   oninput="state.writer.dialogue.listener = this.value">
                        </div>
                        <div class="scene-form-full">
                            <label class="form-label">Wat wil ${d.speaker || 'de spreker'} bereiken? *</label>
                            <textarea class="form-input" style="min-height: 60px;"
                                      placeholder="bijv. Mark overtuigen om mee te doen aan het plan, zonder te onthullen dat ze al weet van zijn geheim"
                                      oninput="state.writer.dialogue.objective = this.value">${escapeHtml(d.objective)}</textarea>
                        </div>
                        <div class="scene-form-full">
                            <label class="form-label">Subtext (wat wordt NIET gezegd)</label>
                            <input type="text" class="form-input" 
                                   placeholder="bijv. Sarah is bang dat Mark haar zal verlaten"
                                   value="${escapeHtml(d.subtext)}"
                                   oninput="state.writer.dialogue.subtext = this.value">
                        </div>
                        <div>
                            <label class="form-label">Toon</label>
                            <select class="form-input" onchange="state.writer.dialogue.tone = this.value">
                                <option value="neutral" ${d.tone === 'neutral' ? 'selected' : ''}>Neutraal</option>
                                <option value="flirty" ${d.tone === 'flirty' ? 'selected' : ''}>Flirterig</option>
                                <option value="aggressive" ${d.tone === 'aggressive' ? 'selected' : ''}>Agressief</option>
                                <option value="sarcastic" ${d.tone === 'sarcastic' ? 'selected' : ''}>Sarcastisch</option>
                                <option value="vulnerable" ${d.tone === 'vulnerable' ? 'selected' : ''}>Kwetsbaar</option>
                                <option value="manipulative" ${d.tone === 'manipulative' ? 'selected' : ''}>Manipulatief</option>
                                <option value="professional" ${d.tone === 'professional' ? 'selected' : ''}>Professioneel</option>
                            </select>
                        </div>
                        <div class="scene-form-full">
                            ${renderMasterDropdown()}
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" style="margin-top: 1.5rem;" 
                            onclick="generateDialogueOptions()" ${state.writer.isGenerating ? 'disabled' : ''}>
                        ${state.writer.isGenerating ? '<span class="spinner"></span> Genereren...' : ' Genereer 3 Versies'}
                    </button>
                </div>
            </div>

            ${d.options.length > 0 ? `
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3>Dialoog Opties</h3>
                    </div>
                    <div class="card-body">
                        <div class="dialogue-options">
                            ${d.options.map((opt, idx) => `
                                <div class="dialogue-option ${d.selectedOption === idx ? 'selected' : ''}"
                                     onclick="state.writer.dialogue.selectedOption = ${idx}; render()">
                                    <div class="dialogue-option-label">${opt.style}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                                        ${escapeHtml(opt.description)}
                                    </div>
                                    <div class="dialogue-preview">
                                        ${escapeHtml(opt.dialogue).replace(/\n/g, '<br>')}
                                    </div>
                                    <button class="copy-btn" style="margin-top: 0.5rem;" 
                                            onclick="event.stopPropagation(); copyToClipboard('${escapeHtml(opt.dialogue).replace(/'/g, "\\'")}', this)">
                                         Kopieer
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
        `;
    }

    // ============================================
    // CONFLICT ESCALATOR RENDER
    // ============================================

    function renderConflictEscalator() {
        const c = state.writer.conflict;
        
        return `
            <div class="card">
                <div class="card-header">
                    <h3> Conflict Escalator</h3>
                    <span style="color: var(--text-secondary);">Van subtiel naar explosief</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Beschrijf je basisconflict *</label>
                        <textarea class="form-input" style="min-height: 100px;"
                                  placeholder="bijv. Sarah ontdekt dat haar collega Mark al maanden haar ideen steelt en als de zijne presenteert bij de directie"
                                  oninput="state.writer.conflict.baseConflict = this.value">${escapeHtml(c.baseConflict)}</textarea>
                    </div>
                    
                    ${renderMasterDropdown()}
                    
                    <button class="btn btn-primary" onclick="generateConflictEscalations()" 
                            ${state.writer.isGenerating ? 'disabled' : ''}>
                        ${state.writer.isGenerating ? '<span class="spinner"></span> Genereren...' : ' Escaleer Conflict'}
                    </button>
                </div>
            </div>

            ${c.escalations.length > 0 ? `
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3>5 Escalatie Niveaus</h3>
                    </div>
                    <div class="card-body">
                        <div class="conflict-scale">
                            ${c.escalations.map(e => `
                                <div class="conflict-level level-${e.level}" 
                                     onclick="state.writer.conflict.selectedLevel = ${e.level}; render()">
                                    <div class="conflict-level-number">${e.level}</div>
                                    <div class="conflict-content">
                                        <div class="conflict-title">${escapeHtml(e.name)}</div>
                                        <div class="conflict-description">${escapeHtml(e.description)}</div>
                                        ${c.selectedLevel === e.level ? `
                                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; font-size: 0.9rem;">
                                                <strong>Scene voorbeeld:</strong><br>
                                                ${escapeHtml(e.example)}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
        `;
    }

    // ============================================
    // PLOT TWIST GENERATOR RENDER
    // ============================================

    function renderTwistGenerator() {
        const t = state.writer.twist;
        
        return `
            <div class="card">
                <div class="card-header">
                    <h3> Plot Twist Generator</h3>
                    <span style="color: var(--text-secondary);">Verrassende wendingen</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Twist Categorie</label>
                        <div class="twist-categories">
                            ${Object.entries(twistCategories).map(([key, label]) => `
                                <button class="twist-category-btn ${t.category === key ? 'active' : ''}"
                                        onclick="state.writer.twist.category = '${key}'; render()">
                                    ${key === 'all' ? '' : key === 'character' ? '' : key === 'perspective' ? '' : key === 'time' ? '' : key === 'relationship' ? '' : ''} ${label}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Extra context (optioneel)</label>
                        <textarea class="form-input" style="min-height: 80px;"
                                  placeholder="Beschrijf je verhaal of specifieke elementen die je wilt twisten..."
                                  oninput="state.writer.twist.context = this.value">${escapeHtml(t.context)}</textarea>
                    </div>
                    
                    ${renderMasterDropdown()}
                    
                    <button class="btn btn-primary" onclick="generatePlotTwists()" 
                            ${state.writer.isGenerating ? 'disabled' : ''}>
                        ${state.writer.isGenerating ? '<span class="spinner"></span> Genereren...' : ' Genereer Twists'}
                    </button>
                </div>
            </div>

            ${t.twists.length > 0 ? `
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3>Plot Twist Suggesties</h3>
                    </div>
                    <div class="card-body">
                        <div class="twist-results">
                            ${t.twists.map(twist => `
                                <div class="twist-card">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div class="twist-title">${escapeHtml(twist.title)}</div>
                                        <span class="stat-badge">${twist.category}</span>
                                    </div>
                                    <div class="twist-setup"><strong>Setup:</strong> ${escapeHtml(twist.setup)}</div>
                                    <div style="margin: 0.5rem 0; padding: 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
                                        <strong> De Twist:</strong> ${escapeHtml(twist.reveal)}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                        <strong>Waarom het werkt:</strong> ${escapeHtml(twist.impact)}
                                    </div>
                                    <div class="twist-example"> Voorbeeld: ${escapeHtml(twist.example)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
        `;
    }

    function renderBeatPlanner() {
        const method = writingMethods[state.writer.method];
        const beats = getCurrentMethodBeats();
        const currentBeat = beats[state.writer.currentBeat];
        
        // Calculate progress
        const filledBeats = beats.filter(b => getBeatContent(b.id) && getBeatContent(b.id).length > 10).length;
        const progressPercent = Math.round((filledBeats / beats.length) * 100);

        return `
            <!-- Project Setup -->
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-body">
                    <div class="project-setup" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label class="form-label">Schrijfmethode</label>
                            <div class="method-selector">
                                ${Object.entries(writingMethods).map(([key, m]) => `
                                    <button class="method-btn ${state.writer.method === key ? 'active' : ''}"
                                            onclick="state.writer.method = '${key}'; state.writer.currentBeat = 0; saveState(); render()">
                                        ${m.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Genre</label>
                            <select class="form-input" onchange="state.writer.genre = this.value; saveState();" style="padding: 0.5rem;">
                                <option value="thriller" ${state.writer.genre === 'thriller' ? 'selected' : ''}>Thriller</option>
                                <option value="drama" ${state.writer.genre === 'drama' ? 'selected' : ''}>Drama</option>
                                <option value="comedy" ${state.writer.genre === 'comedy' ? 'selected' : ''}>Comedy</option>
                                <option value="horror" ${state.writer.genre === 'horror' ? 'selected' : ''}>Horror</option>
                                <option value="scifi" ${state.writer.genre === 'scifi' ? 'selected' : ''}>Sci-Fi</option>
                                <option value="romance" ${state.writer.genre === 'romance' ? 'selected' : ''}>Romance</option>
                                <option value="action" ${state.writer.genre === 'action' ? 'selected' : ''}>Action</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label class="form-label">Logline (1-2 zinnen over je verhaal)</label>
                        <input type="text" class="form-input" 
                               placeholder="Een [held] moet [doel] ondanks [obstakel]..."
                               value="${escapeHtml(state.writer.logline)}"
                               oninput="state.writer.logline = this.value; saveState();">
                    </div>
                    <div style="margin-top: 1rem;">
                        ${renderMasterDropdown()}
                    </div>
                </div>
            </div>

            <!-- Beat Overview -->
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-header">
                    <div>
                        <h3>${method.name} - ${method.author}</h3>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                            <div class="progress-bar" style="width: 200px;">
                                <div class="progress-fill" style="width: ${progressPercent}%;"></div>
                            </div>
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${filledBeats}/${beats.length} beats (${progressPercent}%)
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="state.ui.showExportModal = true; render()">
                            <i data-lucide="download"></i>
                            Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="beat-grid">
                        ${beats.map((beat, idx) => {
                            const content = getBeatContent(beat.id);
                            const isActive = idx === state.writer.currentBeat;
                            const isCompleted = content && content.length > 10;
                            return `
                                <div class="beat-card ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}"
                                     onclick="state.writer.currentBeat = ${idx}; state.writer.suggestions = []; render()">
                                    <div class="beat-number">Beat ${beat.id}  p.${beat.page}</div>
                                    <div class="beat-name">${beat.name}</div>
                                    <div class="beat-status ${isCompleted ? 'filled' : 'empty'}">
                                        ${isCompleted ? ' Ingevuld' : ' Leeg'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>

            <!-- Beat Editor -->
            ${currentBeat ? `
                <div class="beat-editor">
                    <div class="beat-editor-header">
                        <h3>Beat ${currentBeat.id}: ${currentBeat.name}</h3>
                        <span style="color: var(--text-secondary);">Pagina ${currentBeat.page}</span>
                    </div>
                    <div class="beat-editor-body">
                        <div class="beat-description">
                             ${currentBeat.description}
                        </div>
                        
                        <textarea class="beat-textarea" 
                                  placeholder="Schrijf hier je idee voor deze beat..."
                                  oninput="setBeatContent(${currentBeat.id}, this.value)"
                        >${escapeHtml(getBeatContent(currentBeat.id))}</textarea>
                        
                        <div class="suggestion-buttons">
                            <button class="btn btn-primary" onclick="generateBeatSuggestions(getCurrentMethodBeats()[${state.writer.currentBeat}])"
                                    ${state.writer.isGenerating ? 'disabled' : ''}>
                                ${state.writer.isGenerating ? '<span class="spinner"></span> Genereren...' : ' AI Suggesties'}
                            </button>
                            <button class="btn btn-secondary" onclick="showRandomMasterTip()">
                                 Meester Tip
                            </button>
                        </div>
                        
                        ${state.writer.suggestions.length > 0 ? `
                            <div class="suggestions-container">
                                ${state.writer.suggestions.map(s => `
                                    <div class="suggestion-card ${s.type}" onclick="selectSuggestion(${JSON.stringify(s).replace(/"/g, '&quot;')})">
                                        <div class="suggestion-label ${s.type}">
                                            ${s.type === 'conventional' ? ' CONVENTIONEEL' : s.type === 'surprising' ? ' VERRASSEND' : ' GEDURFD'}
                                        </div>
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(s.title)}</div>
                                        <div class="suggestion-text">${escapeHtml(s.description)}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                                             ${escapeHtml(s.reasoning || '')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="beat-nav">
                            <button class="btn btn-secondary" 
                                    onclick="state.writer.currentBeat = Math.max(0, state.writer.currentBeat - 1); state.writer.suggestions = []; render()"
                                    ${state.writer.currentBeat === 0 ? 'disabled' : ''}>
                                 Vorige Beat
                            </button>
                            <button class="btn btn-secondary"
                                    onclick="state.writer.currentBeat = Math.min(${beats.length - 1}, state.writer.currentBeat + 1); state.writer.suggestions = []; render()"
                                    ${state.writer.currentBeat === beats.length - 1 ? 'disabled' : ''}>
                                Volgende Beat 
                            </button>
                        </div>
                    </div>
                </div>
            ` : ''}
        `;
    }

    // Export Modal Render
    function renderExportModal() {
        if (!state.ui.showExportModal) return '';
        
        return `
            <div class="modal-overlay" onclick="state.ui.showExportModal = false; render()">
                <div class="modal" style="max-width: 500px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3> Exporteer Je Werk</h3>
                        <button class="btn btn-ghost" onclick="state.ui.showExportModal = false; render()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <h4 style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.85rem;">BEAT SHEET EXPORT</h4>
                        <div class="export-options" style="margin-bottom: 1.5rem;">
                            <div class="export-option" onclick="exportBeatsToText(); state.ui.showExportModal = false; render()">
                                <i data-lucide="file-text"></i>
                                <div class="export-option-title">Text (.txt)</div>
                                <div class="export-option-desc">Simpel tekstbestand</div>
                            </div>
                            <div class="export-option" onclick="exportBeatsToJSON(); state.ui.showExportModal = false; render()">
                                <i data-lucide="braces"></i>
                                <div class="export-option-title">JSON (.json)</div>
                                <div class="export-option-desc">Gestructureerde data</div>
                            </div>
                        </div>
                        
                        ${state.scripts.length > 0 ? `
                            <h4 style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.85rem;">SCRIPT EXPORT</h4>
                            <div style="margin-bottom: 0.75rem;">
                                <select class="form-control" id="exportScriptSelect">
                                    ${state.scripts.map((script, idx) => `
                                        <option value="${idx}">${escapeHtml(script.title)}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="export-options">
                                <div class="export-option" onclick="exportScriptToFountain(); state.ui.showExportModal = false; render()">
                                    <i data-lucide="file-code"></i>
                                    <div class="export-option-title">Fountain (.fountain)</div>
                                    <div class="export-option-desc">Open standaard voor scripts</div>
                                </div>
                                <div class="export-option" onclick="exportScriptToFDX(); state.ui.showExportModal = false; render()">
                                    <i data-lucide="file"></i>
                                    <div class="export-option-title">Final Draft (.fdx)</div>
                                    <div class="export-option-desc">Final Draft XML format</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Export script to Fountain format
    function exportScriptToFountain() {
        const select = document.getElementById('exportScriptSelect');
        const scriptIdx = parseInt(select?.value || 0);
        const script = state.scripts[scriptIdx];
        
        if (!script) return;
        
        let fountainContent = `Title: ${script.title}\nCredit: Gexporteerd door ScriptMaster Pro\nDate: ${new Date().toLocaleDateString('nl-NL')}\n\n===\n\n`;
        
        script.scenes?.forEach(scene => {
            // Scene header
            fountainContent += `${scene.header}\n\n`;
            
            // Scene content
            let lastWasCharacter = false;
            scene.content?.slice(1).forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) {
                    fountainContent += '\n';
                    return;
                }
                
                // Character name (all caps, not a scene header)
                if (trimmed === trimmed.toUpperCase() && trimmed.length > 1 && trimmed.length < 40 &&
                    !trimmed.startsWith('INT') && !trimmed.startsWith('EXT')) {
                    fountainContent += `\n${trimmed}\n`;
                    lastWasCharacter = true;
                }
                // Parenthetical
                else if (trimmed.match(/^\([^)]+\)$/)) {
                    fountainContent += `${trimmed}\n`;
                }
                // Dialogue (after character)
                else if (lastWasCharacter || line.startsWith('    ') || line.startsWith('\t')) {
                    fountainContent += `${trimmed}\n`;
                    lastWasCharacter = false;
                }
                // Action
                else {
                    fountainContent += `\n${trimmed}\n`;
                    lastWasCharacter = false;
                }
            });
            
            fountainContent += '\n';
        });
        
        downloadFile(fountainContent, `${script.title}.fountain`, 'text/plain');
    }
    
    // Export script to Final Draft XML format
    function exportScriptToFDX() {
        const select = document.getElementById('exportScriptSelect');
        const scriptIdx = parseInt(select?.value || 0);
        const script = state.scripts[scriptIdx];
        
        if (!script) return;
        
        let fdxContent = `<?xml version="1.0" encoding="UTF-8"?>
<FinalDraft DocumentType="Script" Template="No" Version="3">
<Content>
`;
        
        script.scenes?.forEach(scene => {
            // Scene header
            fdxContent += `<Paragraph Type="Scene Heading">
    <Text>${escapeXml(scene.header)}</Text>
</Paragraph>
`;
            
            // Scene content
            scene.content?.slice(1).forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;
                
                let paraType = 'Action';
                
                // Character name
                if (trimmed === trimmed.toUpperCase() && trimmed.length > 1 && trimmed.length < 40 &&
                    !trimmed.startsWith('INT') && !trimmed.startsWith('EXT')) {
                    paraType = 'Character';
                }
                // Parenthetical
                else if (trimmed.match(/^\([^)]+\)$/)) {
                    paraType = 'Parenthetical';
                }
                // Dialogue
                else if (line.startsWith('    ') || line.startsWith('\t')) {
                    paraType = 'Dialogue';
                }
                
                fdxContent += `<Paragraph Type="${paraType}">
    <Text>${escapeXml(trimmed)}</Text>
</Paragraph>
`;
            });
        });
        
        fdxContent += `</Content>
<TitlePage>
    <Content>
        <Paragraph Type="Title Page">
            <Text>${escapeXml(script.title)}</Text>
        </Paragraph>
    </Content>
</TitlePage>
</FinalDraft>`;
        
        downloadFile(fdxContent, `${script.title}.fdx`, 'application/xml');
    }
    
    function escapeXml(text) {
        return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&apos;');
    }
    
    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function renderMastersDatabase() {
        const filteredMasters = getFilteredMasters();

        return `
            <div class="card">
                <div class="card-header">
                    <h3> 100 Meester Schrijvers</h3>
                    <span style="color: var(--text-secondary);">${filteredMasters.length} schrijvers</span>
                </div>
                <div class="card-body">
                    <div class="category-filter">
                        ${Object.entries(masterCategories).map(([key, label]) => `
                            <button class="filter-btn ${state.writer.masterFilter === key ? 'active' : ''}"
                                    onclick="state.writer.masterFilter = '${key}'; render()">
                                ${key === 'all' ? '' : key === 'structure' ? '' : key === 'character' ? '' : key === 'dialogue' ? '' : key === 'tv' ? '' : key === 'comedy' ? '' : key === 'horror' ? '' : key === 'scifi' ? '' : ''} ${label}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="masters-grid">
                        ${filteredMasters.map(master => `
                            <div class="master-card" onclick="showMasterDetailModal(${master.id})">
                                <div class="master-name">${master.name}</div>
                                <div class="master-works">${escapeHtml(master.works)}</div>
                                <div class="master-technique"> ${escapeHtml(master.technique)}</div>
                                <div style="margin-top: 0.5rem; font-size: 0.85rem; font-style: italic; color: var(--text-secondary);">
                                    "${escapeHtml(master.tip)}"
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderMasterDetailModal() {
        if (!state.ui.showMasterDetail) return '';
        
        const master = masterWriters.find(m => m.id === state.ui.showMasterDetail);
        if (!master) return '';

        const categoryEmoji = {
            structure: '',
            character: '',
            dialogue: '',
            tv: '',
            comedy: '',
            horror: '',
            scifi: '',
            international: ''
        };

        return `
            <div class="modal-overlay" onclick="closeMasterDetailModal()">
                <div class="modal master-detail-modal" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3>Meester Profiel</h3>
                        <button class="btn btn-ghost" onclick="closeMasterDetailModal()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="master-detail-header">
                            <div class="master-avatar">${categoryEmoji[master.category] || ''}</div>
                            <div class="master-info">
                                <h2>${master.name}</h2>
                                <p>${escapeHtml(master.works)}</p>
                            </div>
                        </div>
                        
                        <div class="master-technique-box">
                            <div class="master-technique-label"> KERNTECHNIEK</div>
                            <div style="font-weight: 600; font-size: 1.1rem;">${escapeHtml(master.technique)}</div>
                        </div>
                        
                        <div class="master-quote-box">
                            <blockquote>"${escapeHtml(master.tip)}"</blockquote>
                        </div>

                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                Categorie: <span class="stat-badge">${masterCategories[master.category]}</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeMasterDetailModal()">
                            Sluiten
                        </button>
                        <button class="btn btn-primary" onclick="applyMasterStyle(masterWriters.find(m => m.id === ${master.id}))">
                            <i data-lucide="wand-2"></i>
                            Pas stijl toe in Chat
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function showRandomMasterTip() {
        const master = getRandomMasterTip();
        alert(` Tip van ${master.name}:\n\n"${master.tip}"\n\n Techniek: ${master.technique}\n Bekend van: ${master.works}`);
    }

    function render() {
        const app = document.getElementById('app');
        app.innerHTML = `
            ${renderHeader()}
            ${renderNav()}
            <main class="main-content">
                ${renderMainContent()}
            </main>
            ${renderSettingsModal()}
            ${renderSceneViewer()}
            ${renderMasterDetailModal()}
            ${renderExportModal()}
            ${renderRuitEditorModal()}
            ${renderSessionManager()}
            ${renderLocationEditorModal()}
        `;
        
        // Initialize Lucide icons
        lucide.createIcons();

        // Setup drag and drop
        setupDragAndDrop();

        // Scroll chat to bottom
        if (state.activeTab === 'chat') {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================

    function setupDragAndDrop() {
        const uploadZone = document.getElementById('uploadZone');
        if (!uploadZone) return;

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            await processFiles(files);
        });
    }

    async function handleFileUpload(event) {
        const files = Array.from(event.target.files);
        await processFiles(files);
        event.target.value = ''; // Reset input
    }

    async function processFiles(files) {
        state.ui.isProcessing = true;
        render();

        for (const file of files) {
            try {
                await processFile(file);
            } catch (error) {
                alert(`Fout bij verwerken van ${file.name}: ${error.message}`);
            }
        }

        state.ui.isProcessing = false;
        render();
    }

    function viewScript(index) {
        state.selectedScript = index;
        state.ui.showSceneViewer = true;
        render();
    }

    function closeSceneViewer() {
        state.ui.showSceneViewer = false;
        state.selectedScript = null;
        render();
    }

    // Toggle script accordion open/closed
    function toggleScriptAccordion(index) {
        state.ui.expandedScripts[index] = !state.ui.expandedScripts[index];
        render();
    }

    // ============================================
    // SCRIPT SEARCH FUNCTIONALITY
    // ============================================

    function searchScripts(query) {
        state.ui.scriptSearch = query;
        
        if (!query || query.trim().length < 2) {
            state.ui.scriptSearchResults = null;
            render();
            return;
        }

        const searchTerm = query.toLowerCase().trim();
        const results = [];

        state.scripts.forEach((script, scriptIndex) => {
            // Search in title
            if (script.title.toLowerCase().includes(searchTerm)) {
                results.push({
                    type: 'title',
                    scriptIndex,
                    scriptTitle: script.title,
                    match: script.title,
                    context: `Script titel bevat "${query}"`
                });
            }

            // Search in characters
            script.characters?.forEach(char => {
                if (char.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'character',
                        scriptIndex,
                        scriptTitle: script.title,
                        match: char,
                        context: `Karakter in ${script.title}`
                    });
                }
            });

            // Search in locations
            script.locations?.forEach(loc => {
                if (loc.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'location',
                        scriptIndex,
                        scriptTitle: script.title,
                        match: loc,
                        context: `Locatie in ${script.title}`
                    });
                }
            });

            // Search in scene content (dialogue and action)
            script.scenes?.forEach((scene, sceneIndex) => {
                // Search in scene header
                if (scene.header?.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'scene',
                        scriptIndex,
                        sceneIndex,
                        scriptTitle: script.title,
                        match: scene.header,
                        context: `Scene ${sceneIndex + 1} header`
                    });
                }

                // Search in scene content
                scene.content?.forEach((line, lineIndex) => {
                    if (line.toLowerCase().includes(searchTerm)) {
                        // Get some context around the match
                        const startIdx = Math.max(0, lineIndex - 1);
                        const endIdx = Math.min(scene.content.length, lineIndex + 2);
                        const contextLines = scene.content.slice(startIdx, endIdx).join('\n');
                        
                        results.push({
                            type: 'dialogue',
                            scriptIndex,
                            sceneIndex,
                            scriptTitle: script.title,
                            sceneHeader: scene.header,
                            match: line.trim().substring(0, 100),
                            context: contextLines.substring(0, 200)
                        });
                    }
                });
            });

            // Search in scene summaries if available
            script.sceneSummaries?.forEach((summary, sceneIndex) => {
                if (summary.summary?.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'summary',
                        scriptIndex,
                        sceneIndex,
                        scriptTitle: script.title,
                        match: summary.summary.substring(0, 100),
                        context: `Scene ${sceneIndex + 1} samenvatting`
                    });
                }
            });
        });

        // Limit results and remove duplicates
        const uniqueResults = [];
        const seen = new Set();
        
        results.forEach(r => {
            const key = `${r.scriptIndex}-${r.sceneIndex || 0}-${r.type}-${r.match.substring(0, 30)}`;
            if (!seen.has(key) && uniqueResults.length < 50) {
                seen.add(key);
                uniqueResults.push(r);
            }
        });

        state.ui.scriptSearchResults = uniqueResults;
        render();
    }

    function clearScriptSearch() {
        state.ui.scriptSearch = '';
        state.ui.scriptSearchResults = null;
        render();
    }

    function goToSearchResult(resultIndex) {
        const result = state.ui.scriptSearchResults[resultIndex];
        if (!result) return;
        
        // Expand the script and scroll to it
        state.ui.expandedScripts[result.scriptIndex] = true;
        
        if (result.type === 'dialogue' || result.type === 'scene') {
            // Open the full script viewer
            state.selectedScript = result.scriptIndex;
            state.ui.showSceneViewer = true;
        }
        
        // Clear search
        state.ui.scriptSearch = '';
        state.ui.scriptSearchResults = null;
        
        render();
    }

    // Generate scene summaries using AI
    async function generateSceneSummaries(scriptIndex) {
        const script = state.scripts[scriptIndex];
        if (!script || !script.scenes || script.scenes.length === 0) {
            alert('Geen scenes gevonden in dit script');
            return;
        }

        if (!state.settings.apiKey) {
            alert('Voer eerst een API key in bij instellingen');
            return;
        }

        state.ui.generatingSummaries = scriptIndex;
        state.ui.expandedScripts[scriptIndex] = true;
        render();

        try {
            // Build prompt with all scenes
            const scenesText = script.scenes.map((scene, i) => {
                // AI-analyzed scripts may not have content array - use dialogues/summary instead
                let sceneText = '';
                if (scene.content && scene.content.length > 0) {
                    sceneText = scene.content.join('\n').substring(0, 1500);
                } else if (scene.dialogues && scene.dialogues.length > 0) {
                    sceneText = scene.dialogues.map(d => `${d.character}: ${d.text}`).join('\n').substring(0, 1500);
                } else if (scene.summary) {
                    sceneText = scene.summary;
                }
                const header = scene.header || `Scene ${scene.number || i + 1}`;
                const chars = scene.characters ? `Karakters: ${scene.characters.join(', ')}` : '';
                return `--- SCENE ${i + 1} ---\n${header}\n${chars}\n${sceneText}`;
            }).join('\n\n');

            const prompt = `Je bent een script-analist. Analyseer het volgende script en geef voor ELKE scene een korte samenvatting van 2-3 zinnen.

Script: "${script.title}"
Aantal scenes: ${script.scenes.length}

${scenesText}

${script.rawText && !scenesText.includes('\n') ? '\n=== VOLLEDIGE SCRIPT TEKST ===\n' + script.rawText.substring(0, 20000) : ''}

Geef je antwoord in het volgende JSON formaat (ALLEEN JSON, geen andere tekst):
{
    "summaries": [
        {"scene": 1, "header": "INT. LOCATIE - DAG", "summary": "Korte samenvatting van wat er gebeurt..."},
        {"scene": 2, "header": "EXT. LOCATIE - NACHT", "summary": "Korte samenvatting..."}
    ]
}

Belangrijk:
- Geef voor ELKE scene een samenvatting (${script.scenes.length} scenes totaal)
- Houd elke samenvatting tussen 2-3 zinnen
- Focus op: wie zijn aanwezig, wat gebeurt er, wat is het conflict/doel
- Gebruik Nederlandse taal
- ALLEEN JSON output`;

            const response = await fetch(state.settings.proxyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.settings.apiKey
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 8000,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            const data = await response.json();
            const text = data.content[0].text;

            // Parse JSON response
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const parsed = JSON.parse(jsonMatch[0]);
                script.sceneSummaries = parsed.summaries.map((s, i) => ({
                    header: s.header || script.scenes[i]?.header || `Scene ${i + 1}`,
                    summary: s.summary
                }));
                saveState();
            } else {
                throw new Error('Kon geen geldige JSON vinden in response');
            }

        } catch (error) {
            console.error('Error generating summaries:', error);
            const errorMsg = error.message || 'Onbekende fout';
            alert('Fout bij genereren samenvattingen: ' + errorMsg + '\n\nTip: Check je API key en internetverbinding.');
        }

        state.ui.generatingSummaries = null;
        render();
    }

    // Regenerate summaries (delete and regenerate)
    function regenerateSceneSummaries(scriptIndex) {
        if (confirm('Weet je zeker dat je de samenvattingen opnieuw wilt genereren?')) {
            const script = state.scripts[scriptIndex];
            if (script) {
                delete script.sceneSummaries;
                saveState();
                generateSceneSummaries(scriptIndex);
            }
        }
    }

    function deleteScript(index) {
        if (confirm('Weet je zeker dat je dit script wilt verwijderen?')) {
            state.scripts.splice(index, 1);
            // Clean up expanded state
            delete state.ui.expandedScripts[index];
            rebuildIndexes();
            saveState();
            render();
        }
    }

    function saveSettings() {
        saveState();
        state.ui.showSettings = false;
        render();
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        if (input && input.value.trim()) {
            sendChatMessage(input.value.trim());
            input.value = '';
        }
    }

    // ============================================
    // INITIALIZATION
    // ============================================

    // Set PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Load state and render
    loadState();
    render();

    // Make functions available globally
    window.handleFileUpload = handleFileUpload;
    window.viewScript = viewScript;
    window.closeSceneViewer = closeSceneViewer;
    window.deleteScript = deleteScript;
    window.toggleScriptAccordion = toggleScriptAccordion;
    window.generateSceneSummaries = generateSceneSummaries;
    window.regenerateSceneSummaries = regenerateSceneSummaries;
    window.searchScripts = searchScripts;
    window.clearScriptSearch = clearScriptSearch;
    window.goToSearchResult = goToSearchResult;
    window.saveSettings = saveSettings;
    window.sendMessage = sendMessage;
    window.generateStoryframe = generateStoryframe;
    window.exportStoryframe = exportStoryframe;
    window.state = state;
    window.render = render;
    window.saveState = saveState;
    
    // Writer Assistant functions
    window.getCurrentMethodBeats = getCurrentMethodBeats;
    window.getBeatContent = getBeatContent;
    window.setBeatContent = setBeatContent;
    window.generateBeatSuggestions = generateBeatSuggestions;
    window.selectSuggestion = selectSuggestion;
    window.getFilteredMasters = getFilteredMasters;
    window.showMasterDetail = showMasterDetailModal;
    window.showMasterDetailModal = showMasterDetailModal;
    window.closeMasterDetailModal = closeMasterDetailModal;
    window.showRandomMasterTip = showRandomMasterTip;
    window.getRandomMasterTip = getRandomMasterTip;
    window.writingMethods = writingMethods;
    window.masterWriters = masterWriters;
    
    // New feature functions
    window.generateScene = generateScene;
    window.generateDialogueOptions = generateDialogueOptions;
    window.generateConflictEscalations = generateConflictEscalations;
    window.generatePlotTwists = generatePlotTwists;
    window.twistCategories = twistCategories;
    window.exportBeatsToText = exportBeatsToText;
    window.exportBeatsToJSON = exportBeatsToJSON;
    window.exportSceneToFountain = exportSceneToFountain;
    window.copyToClipboard = copyToClipboard;
    window.applyMasterStyle = applyMasterStyle;
    window.renderMasterDropdown = renderMasterDropdown;
    window.getMasterPromptText = getMasterPromptText;
    
    // Karakter Ruit functions
    window.openRuitEditor = openRuitEditor;
    window.closeRuitEditor = closeRuitEditor;
    window.handleRuitPhotoUpload = handleRuitPhotoUpload;
    window.updateRuitField = updateRuitField;
    window.addRuitArrayItem = addRuitArrayItem;
    window.removeRuitArrayItem = removeRuitArrayItem;
    window.saveCharacterRuit = saveCharacterRuit;
    window.getCharacterRuit = getCharacterRuit;
    window.hasRuitData = hasRuitData;
    window.buildRuitContext = buildRuitContext;
    window.toggleSceneCharacter = toggleSceneCharacter;
    window.parseAndImportRuit = parseAndImportRuit;
    window.renderRuitVisual = renderRuitVisual;
    window.renderRuitImport = renderRuitImport;
    window.renderRuitEditForm = renderRuitEditForm;
    
    // Session management functions
    window.getAllSessions = getAllSessions;
    window.createNewSession = createNewSession;
    window.saveCurrentSession = saveCurrentSession;
    window.loadSession = loadSession;
    window.deleteSession = deleteSession;
    window.renameSession = renameSession;
    window.clearAllData = clearAllData;
    window.promptNewSession = promptNewSession;
    window.renderSessionManager = renderSessionManager;
    
    // Location editor functions
    window.openLocationEditor = openLocationEditor;
    window.closeLocationEditor = closeLocationEditor;
    window.updateLocationField = updateLocationField;
    
    // Continuity functions
    window.generateAIContinuityReport = generateAIContinuityReport;
    
    // Script export functions
    window.exportScriptToFountain = exportScriptToFountain;
    window.exportScriptToFDX = exportScriptToFDX;
    </script>
</body>
</html>
